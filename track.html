<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f1a">
    <title>Track Your Order - NeighborFleet</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252542;
            --accent-green: #00d26a;
            --accent-green-dim: rgba(0, 210, 106, 0.15);
            --accent-orange: #ff6b35;
            --accent-blue: #4dabf7;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-dim: #6b6b80;
            --border-color: #353550;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 1.5rem 0;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-green-dim);
            color: var(--accent-green);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .status-badge.pending {
            background: rgba(255, 107, 53, 0.15);
            color: var(--accent-orange);
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Map Container */
        .map-container {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 16/10;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .map-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
            fill: var(--text-dim);
        }

        /* ETA Card */
        .eta-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .eta-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .eta-time {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-green);
        }

        .eta-time span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Driver Card */
        .driver-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .driver-avatar {
            width: 56px;
            height: 56px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .driver-avatar svg {
            width: 28px;
            height: 28px;
            fill: var(--text-dim);
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .driver-info {
            flex: 1;
        }

        .driver-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .driver-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .driver-action {
            background: var(--accent-green);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .driver-action:hover {
            transform: scale(1.1);
        }

        .driver-action svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Order Details */
        .order-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .order-id {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .restaurant-name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .order-items {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Address */
        .address-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .address-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .address-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 0;
        }

        .step.completed:not(:last-child)::after {
            background: var(--accent-green);
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .step.completed .step-icon {
            background: var(--accent-green);
        }

        .step.active .step-icon {
            background: var(--accent-orange);
            animation: pulse 1.5s infinite;
        }

        .step-icon svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .step-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
        }

        .step.completed .step-label,
        .step.active .step-label {
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error {
            text-align: center;
            padding: 4rem 2rem;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            background: rgba(255, 71, 87, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .error-icon svg {
            width: 32px;
            height: 32px;
            fill: #ff4757;
        }

        .error h2 {
            margin-bottom: 0.5rem;
        }

        .error p {
            color: var(--text-secondary);
        }

        /* Delivered State */
        .delivered-banner {
            background: var(--accent-green-dim);
            border: 2px solid var(--accent-green);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .delivered-banner h2 {
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .delivered-banner p {
            color: var(--text-secondary);
        }

        .delivery-photo {
            width: 100%;
            border-radius: 12px;
            margin-top: 1rem;
        }

        /* Driver Story Card */
        .driver-story-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid #8b5cf6;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-header {
            margin-bottom: 0.75rem;
        }

        .story-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .story-content {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .story-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .story-avatar svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .story-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        .story-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Feedback Section */
        .feedback-section {
            margin-bottom: 1rem;
        }

        .feedback-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .feedback-card h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .star {
            font-size: 2.5rem;
            color: var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover,
        .star.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .star.active {
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .rating-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        /* Tip Section */
        .tip-section {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        .tip-prompt {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .tip-options {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tip-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tip-btn:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .tip-btn.selected {
            border-color: #8b5cf6;
            background: #8b5cf6;
            color: white;
        }

        .custom-tip-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
        }

        .custom-tip-input .currency {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .custom-tip-input input {
            width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.1rem;
            text-align: center;
        }

        .custom-tip-input input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .feedback-comment {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            height: 80px;
            margin-bottom: 1rem;
        }

        .feedback-comment:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .submit-feedback-btn {
            width: 100%;
            padding: 1rem;
            background: var(--accent-green);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-feedback-btn:hover {
            background: #00e676;
            transform: translateY(-2px);
        }

        .submit-feedback-btn:disabled {
            background: var(--border-color);
            color: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        /* Thank You Card */
        .thank-you-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }

        .thank-you-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .thank-you-card h3 {
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .thank-you-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .order-again-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .order-again-btn:hover {
            background: #22c55e;
            transform: translateY(-2px);
        }

        /* Floating Help Button */
        .help-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d26a, #00a854);
            border: none;
            box-shadow: 0 4px 20px rgba(0, 210, 106, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .help-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 210, 106, 0.5);
        }

        .help-fab svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .help-fab-label {
            position: absolute;
            right: 70px;
            background: white;
            color: #1a1a2e;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .help-fab:hover .help-fab-label {
            opacity: 1;
        }

        /* Help Modal */
        .help-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 1rem;
        }

        .help-modal-overlay.active {
            display: flex;
        }

        .help-modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }

        .help-modal-header h3 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .help-options {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .help-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .help-option:hover {
            background: var(--border-color);
            transform: translateX(5px);
        }

        .help-option-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .help-option-icon.whatsapp {
            background: rgba(37, 211, 102, 0.15);
        }

        .help-option-icon.phone {
            background: rgba(59, 130, 246, 0.15);
        }

        .help-option-icon.faq {
            background: rgba(251, 191, 36, 0.15);
        }

        .help-option-text {
            text-align: left;
        }

        .help-option-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .help-option-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* FAQ Section */
        .faq-section {
            padding: 1rem;
            display: none;
        }

        .faq-section.active {
            display: block;
        }

        .faq-back {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--accent-green);
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 1rem;
            padding: 0;
        }

        .faq-item {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .faq-question {
            width: 100%;
            padding: 1rem;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .faq-question:hover {
            background: rgba(255,255,255,0.05);
        }

        .faq-question .arrow {
            transition: transform 0.3s ease;
        }

        .faq-item.open .faq-question .arrow {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .faq-item.open .faq-answer {
            max-height: 200px;
        }

        .faq-answer p {
            padding: 0 1rem 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--accent-green);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="loading-spinner"></div>
            <p>Finding your order...</p>
        </div>

        <!-- Error State -->
        <div class="error" id="errorState" style="display: none;">
            <div class="error-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </div>
            <h2>Order not found</h2>
            <p>This tracking link may have expired or is invalid.</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Header -->
            <div class="header">
                <div class="status-badge" id="statusBadge">
                    <span class="dot"></span>
                    <span id="statusText">On the way</span>
                </div>
                <h1 id="headerTitle">Your order is coming!</h1>
                <p id="headerSubtitle">Estimated arrival in a few minutes</p>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps" id="progressSteps">
                <div class="step completed" id="step1">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Confirmed</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Picked Up</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">On the way</span>
                </div>
                <div class="step" id="step4">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Delivered</span>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map">
                    
                </div>
            </div>

            <!-- ETA Card -->
            <div class="eta-card" id="etaCard">
                <div class="eta-label">Estimated Arrival</div>
                <div class="eta-time"><span id="etaTime">--</span> <span>min</span></div>
                <div class="eta-distance" id="distanceText" style="color: #a0a0b8; font-size: 0.9rem; margin-top: 0.5rem;"></div>
            </div>

            <!-- Driver Card -->
            <div class="driver-card" id="driverCard">
                <div class="driver-avatar" id="driverAvatar">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="driver-info">
                    <div class="driver-name" id="driverName">Your driver</div>
                    <div class="driver-status" id="driverStatus">Picking up your order</div>
                </div>
                <button class="driver-action" id="callDriver" title="Message driver">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                </button>
            </div>

            <!-- Driver Story Card (shows while on route) -->
            <div class="driver-story-card" id="driverStoryCard" style="display: none;">
                <div class="story-header">
                    <span class="story-badge">üíú Meet Your Driver</span>
                </div>
                <div class="story-content">
                    <div class="story-avatar" id="storyAvatar">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="story-text">
                        <p id="storyText">Your driver is a valued member of our community, helping connect local restaurants with neighbors like you.</p>
                    </div>
                </div>
                <div class="story-footer">
                    <span>üöó Supporting local families & businesses</span>
                </div>
            </div>

            <!-- Delivered Banner (hidden by default) -->
            <div class="delivered-banner" id="deliveredBanner" style="display: none;">
                <h2>‚úÖ Order Delivered!</h2>
                <p>Thank you for ordering with NeighborFleet</p>
                <img class="delivery-photo" id="deliveryPhoto" style="display: none;">
            </div>

            <!-- Feedback & Tip Section (hidden until delivered) -->
            <div class="feedback-section" id="feedbackSection" style="display: none;">
                <div class="feedback-card">
                    <h3>How was your delivery?</h3>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <p class="rating-label" id="ratingLabel">Tap to rate</p>
                    
                    <div class="tip-section" id="tipSection" style="display: none;">
                        <p class="tip-prompt">üíú Say thanks to <span id="tipDriverName">your driver</span> with a tip</p>
                        <div class="tip-options">
                            <button class="tip-btn" data-amount="2">$2</button>
                            <button class="tip-btn" data-amount="3">$3</button>
                            <button class="tip-btn" data-amount="5">$5</button>
                            <button class="tip-btn custom-tip" id="customTipBtn">Other</button>
                        </div>
                        <div class="custom-tip-input" id="customTipInput" style="display: none;">
                            <span class="currency">$</span>
                            <input type="number" id="customTipAmount" min="1" max="50" placeholder="0">
                        </div>
                    </div>
                    
                    <textarea class="feedback-comment" id="feedbackComment" placeholder="Any comments? (optional)"></textarea>
                    
                    <button class="submit-feedback-btn" id="submitFeedbackBtn">Submit Feedback</button>
                </div>
                
                <!-- Thank You Message (after submission) -->
                <div class="thank-you-card" id="thankYouCard" style="display: none;">
                    <div class="thank-you-icon">üíö</div>
                    <h3>Thank you!</h3>
                    <p>Your feedback helps us improve</p>
                    <button class="order-again-btn" id="orderAgainBtn">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z" fill="#25D366"/></svg>
                        Order again on WhatsApp
                    </button>
                </div>
            </div>

            <!-- Order Details -->
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-id" id="orderId">#ORDER</div>
                        <div class="restaurant-name" id="restaurantName">Restaurant</div>
                    </div>
                </div>
                <div class="order-items" id="orderItems">
                    Loading order details...
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="address-card">
                <div class="address-label">Delivering to</div>
                <div class="address-text" id="deliveryAddress">Loading address...</div>
            </div>

            <!-- Footer -->
            <div class="footer">
                Powered by <a href="#">YYC LocalFirst</a><br>
                Supporting local restaurants üíö
            </div>
        </div>
    </div>

    <!-- Floating Help Button -->
    <button class="help-fab" id="helpFab" aria-label="Need help?">
        <span class="help-fab-label">Need help?</span>
        <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
    </button>

    <!-- Help Modal -->
    <div class="help-modal-overlay" id="helpModal">
        <div class="help-modal">
            <div class="help-modal-header">
                <h3>üí¨ How can we help?</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <!-- Main Help Options -->
            <div class="help-options" id="helpOptions">
                <a href="https://wa.me/14038265529?text=Hi! I need help with my order." class="help-option" target="_blank">
                    <div class="help-option-icon whatsapp">üí¨</div>
                    <div class="help-option-text">
                        <div class="help-option-title">Chat on WhatsApp</div>
                        <div class="help-option-desc">Get instant support</div>
                    </div>
                </a>
                
                <a href="tel:+14038265529" class="help-option">
                    <div class="help-option-icon phone">üìû</div>
                    <div class="help-option-text">
                        <div class="help-option-title">Call Us</div>
                        <div class="help-option-desc">Speak with our team</div>
                    </div>
                </a>
                
                <button class="help-option" id="showFaq">
                    <div class="help-option-icon faq">‚ùì</div>
                    <div class="help-option-text">
                        <div class="help-option-title">FAQs</div>
                        <div class="help-option-desc">Common questions answered</div>
                    </div>
                </button>
            </div>
            
            <!-- FAQ Section -->
            <div class="faq-section" id="faqSection">
                <button class="faq-back" id="faqBack">
                    ‚Üê Back to options
                </button>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Where is my order?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>You can track your order in real-time on this page. The map shows your driver's exact location. If the driver hasn't moved for a while, they may be picking up your order or in traffic.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How do I contact my driver?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>Tap the message icon next to your driver's name on the tracking page to send them a WhatsApp message directly.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How long does delivery take?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>Most deliveries arrive within 30-45 minutes. The estimated arrival time on your tracking page updates in real-time based on your driver's location and traffic.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Can I change my delivery address?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>If your driver hasn't picked up the order yet, contact us immediately via WhatsApp and we'll update your address. Once picked up, address changes may not be possible.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How do I get a refund?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>If there's an issue with your order, please contact us on WhatsApp with your order number. We review all refund requests within 24 hours and prioritize your satisfaction.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Why support local restaurants?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>We charge restaurants only 15% commission vs 25-30% from big chains. This means more money stays with local families and our Calgary community. Thank you for choosing local! üíö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4T_RiDo2RqzDZNnhoUwwsrEQqf1AjUMs"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // STATE
        // ============================================
        let currentDelivery = null;
        let currentDriver = null;

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const mainContent = document.getElementById('mainContent');

        // ============================================
        // GET TRACKING TOKEN FROM URL
        // ============================================
        function getTrackingToken() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        // ============================================
        // LOAD DELIVERY
        // ============================================
        async function loadDelivery() {
            const token = getTrackingToken();
            
            if (!token) {
                showError();
                return;
            }

            try {
                // Get delivery by tracking token
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('tracking_token', token)
                    .single();

                if (error || !delivery) {
                    showError();
                    return;
                }

                currentDelivery = delivery;

                // Get driver info if assigned
                if (delivery.driver_id) {
                    const { data: driver } = await supabaseClient
                        .from('drivers')
                        .select('*')
                        .eq('id', delivery.driver_id)
                        .single();
                    
                    currentDriver = driver;
                }

                showContent();
                updateUI();
                subscribeToUpdates();

            } catch (err) {
                console.error('Error loading delivery:', err);
                showError();
            }
        }

        // ============================================
        // SUBSCRIBE TO REALTIME UPDATES
        // ============================================
        function subscribeToUpdates() {
            // Subscribe to delivery updates
            supabaseClient
                .channel('tracking-channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'deliveries',
                        filter: `id=eq.${currentDelivery.id}`
                    }, 
                    async (payload) => {
                        console.log('Delivery update:', payload);
                        currentDelivery = payload.new;
                        updateUI();
                    }
                )
                .subscribe();

            // Subscribe to driver location updates if assigned
            if (currentDriver) {
                supabaseClient
                    .channel('driver-location-channel')
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'drivers',
                            filter: `id=eq.${currentDriver.id}`
                        }, 
                        (payload) => {
                            console.log('Driver location update:', payload);
                            currentDriver = payload.new;
                            updateDriverLocation();
                        }
                    )
                    .subscribe();
            }
        }

        // ============================================
        // UPDATE UI
        // ============================================
        function updateUI() {
            if (!currentDelivery) return;

            // Order details
            document.getElementById('orderId').textContent = `#${currentDelivery.order_id}`;
            document.getElementById('restaurantName').textContent = currentDelivery.restaurant_name;
            document.getElementById('orderItems').textContent = currentDelivery.items_summary || 'Order items';
            document.getElementById('deliveryAddress').textContent = currentDelivery.customer_address;

            // Driver info
            if (currentDriver) {
                document.getElementById('driverName').textContent = currentDriver.name;
                document.getElementById('driverCard').style.display = 'flex';
                
                // WhatsApp link
                document.getElementById('callDriver').onclick = () => {
                    const phone = currentDriver.phone.replace('+', '');
                    window.open(`https://wa.me/${phone}`, '_blank');
                };
            } else {
                document.getElementById('driverCard').style.display = 'none';
            }

            // Update based on status
            updateStatus(currentDelivery.status);
        }

        // ============================================
        // UPDATE STATUS
        // ============================================
        function updateStatus(status) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const driverStatus = document.getElementById('driverStatus');
            const etaCard = document.getElementById('etaCard');
            const deliveredBanner = document.getElementById('deliveredBanner');

            // Reset steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('completed', 'active');
            });

            switch (status) {
                case 'pending':
                    statusText.textContent = 'Order received';
                    statusBadge.className = 'status-badge pending';
                    headerTitle.textContent = 'Preparing your order';
                    headerSubtitle.textContent = 'Finding a driver for you';
                    driverStatus.textContent = 'Finding a driver...';
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('etaTime').textContent = '--';
                    break;

                case 'assigned':
                    statusText.textContent = 'Driver assigned';
                    statusBadge.className = 'status-badge pending';
                    headerTitle.textContent = 'Driver on the way to restaurant';
                    headerSubtitle.textContent = 'Your order will be picked up soon';
                    driverStatus.textContent = 'Heading to pickup';
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('etaTime').textContent = '15-20';
                    break;

                case 'picked_up':
                case 'delivering':
                    statusText.textContent = 'On the way';
                    statusBadge.className = 'status-badge';
                    headerTitle.textContent = 'Your order is on the way!';
                    headerSubtitle.textContent = 'Driver has picked up your food';
                    driverStatus.textContent = 'Delivering to you';
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('active');
                    document.getElementById('etaTime').textContent = '5-10';
                    
                    // Show driver story while on route
                    showDriverStory();
                    break;

                case 'delivered':
                    statusText.textContent = 'Delivered';
                    statusBadge.className = 'status-badge';
                    headerTitle.textContent = 'Order delivered!';
                    headerSubtitle.textContent = 'Enjoy your meal!';
                    driverStatus.textContent = 'Delivery completed';
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.add('completed');
                    });
                    etaCard.style.display = 'none';
                    deliveredBanner.style.display = 'block';
                    
                    // Hide driver story, show feedback section
                    document.getElementById('driverStoryCard').style.display = 'none';
                    document.getElementById('feedbackSection').style.display = 'block';
                    
                    // Set driver name in tip section
                    if (currentDriver) {
                        document.getElementById('tipDriverName').textContent = currentDriver.name;
                    }
                    
                    // Show delivery photo if available
                    if (currentDelivery.delivery_photo_url) {
                        const photo = document.getElementById('deliveryPhoto');
                        photo.src = currentDelivery.delivery_photo_url;
                        photo.style.display = 'block';
                    }
                    break;
            }
        }

        // ============================================
        // UPDATE DRIVER LOCATION ON MAP
        // ============================================
        function updateDriverLocation() {
            if (currentDriver && currentDriver.current_lat && currentDriver.current_lng) {
                console.log('Driver location:', currentDriver.current_lat, currentDriver.current_lng);
                updateDriverMarker();
            }
        }

        // ============================================
        // GOOGLE MAPS WITH DIRECTIONS
        // ============================================
        let map = null;
        let driverMarker = null;
        let customerMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let lastRouteUpdate = 0;
        let lastDriverLat = null;
        let lastDriverLng = null;
        let carRotation = 0;
        let routePath = []; // Store the route polyline points

        // Honda Civic 2017 Hatchback - Blue (actual PNG image, top-down view)
        const carImageBase64 = 'data:image/png;base64,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';
        
        function getCivicIcon(rotation) {
            // For rotation, we use CSS transform in a wrapper SVG
            return 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
                    <g transform="rotate(${rotation}, 40, 40)">
                        <image href="${carImageBase64}" x="0" y="0" width="80" height="80"/>
                    </g>
                </svg>
            `);
        }
        
        let civicImageUrl = getCivicIcon(0);

        function getCarIcon(rotation) {
            return {
                url: civicImageUrl,
                scaledSize: new google.maps.Size(45, 45),
                anchor: new google.maps.Point(22, 22),
                rotation: rotation
            };
        }

        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        // Find closest point on route to snap the car
        function snapToRoute(driverPos) {
            if (!routePath || routePath.length === 0) return driverPos;
            
            let closestPoint = routePath[0];
            let closestDist = getDistance(driverPos, closestPoint);
            let closestIndex = 0;
            
            for (let i = 1; i < routePath.length; i++) {
                const dist = getDistance(driverPos, routePath[i]);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestPoint = routePath[i];
                    closestIndex = i;
                }
            }
            
            // Only snap if within 100 meters of route
            if (closestDist < 100) {
                // Calculate bearing from next point on route
                if (closestIndex < routePath.length - 1) {
                    const nextPoint = routePath[closestIndex + 1];
                    carRotation = calculateBearing(
                        closestPoint.lat(), closestPoint.lng(),
                        nextPoint.lat(), nextPoint.lng()
                    );
                }
                return { lat: closestPoint.lat(), lng: closestPoint.lng() };
            }
            return driverPos;
        }

        function getDistance(pos1, pos2) {
            const lat1 = typeof pos1.lat === 'function' ? pos1.lat() : pos1.lat;
            const lng1 = typeof pos1.lng === 'function' ? pos1.lng() : pos1.lng;
            const lat2 = typeof pos2.lat === 'function' ? pos2.lat() : pos2.lat;
            const lng2 = typeof pos2.lng === 'function' ? pos2.lng() : pos2.lng;
            
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initMap() {
            const defaultCenter = { lat: 51.1284, lng: -113.9490 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: defaultCenter,
                disableDefaultUI: true,
                zoomControl: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#1a1a2e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a2e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#6b6b80" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#353550" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e0e1a" }] }
                ]
            });

            // Initialize Directions Service
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true, // We'll use our own markers
                polylineOptions: {
                    strokeColor: '#00d26a',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });

            // Update map once data is loaded
            setTimeout(() => {
                if (currentDelivery) updateMapWithLocations();
            }, 1000);
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof google !== 'undefined') {
                initMap();
            }
        });

        function updateMapWithLocations() {
            if (!map || !currentDelivery) return;

            const customerLat = parseFloat(currentDelivery.customer_lat);
            const customerLng = parseFloat(currentDelivery.customer_lng);

            if (customerLat && customerLng) {
                const customerPos = { lat: customerLat, lng: customerLng };
                
                if (!customerMarker) {
                    customerMarker = new google.maps.Marker({
                        position: customerPos,
                        map: map,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="45" height="55" viewBox="0 0 45 55"><defs><linearGradient id="pinGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#00E676;stop-opacity:1" /><stop offset="100%" style="stop-color:#00C853;stop-opacity:1" /></linearGradient><filter id="shadow2" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/></filter></defs><path d="M22.5 0 C10 0 0 10 0 22.5 C0 35 22.5 55 22.5 55 C22.5 55 45 35 45 22.5 C45 10 35 0 22.5 0 Z" fill="url(#pinGrad)" filter="url(#shadow2)"/><circle cx="22.5" cy="20" r="12" fill="white"/><path d="M22.5 12 L14 19 L14 27 L19 27 L19 22 L26 22 L26 27 L31 27 L31 19 Z" fill="#00C853"/><circle cx="22.5" cy="20" r="2" fill="#00C853"/></svg>'),
                            scaledSize: new google.maps.Size(45, 55),
                            anchor: new google.maps.Point(22.5, 55)
                        },
                        title: 'Delivery Location'
                    });
                }
                map.setCenter(customerPos);
            }

            updateDriverMarker();
        }

        function updateDriverMarker() {
            if (!map || !currentDriver) return;

            const driverLat = parseFloat(currentDriver.current_lat);
            const driverLng = parseFloat(currentDriver.current_lng);

            if (!driverLat || !driverLng) return;

            let driverPos = { lat: driverLat, lng: driverLng };
            
            // Snap to route if we have one
            if (routePath.length > 0) {
                driverPos = snapToRoute(driverPos);
            } else {
                // Calculate rotation based on direction of travel
                if (lastDriverLat !== null && lastDriverLng !== null) {
                    const newRotation = calculateBearing(lastDriverLat, lastDriverLng, driverLat, driverLng);
                    if (Math.abs(newRotation - carRotation) > 5) {
                        carRotation = newRotation;
                    }
                }
            }
            
            lastDriverLat = driverLat;
            lastDriverLng = driverLng;

            // Create icon with current rotation
            const rotatedIcon = {
                url: getCivicIcon(carRotation),
                scaledSize: new google.maps.Size(65, 65),
                anchor: new google.maps.Point(32, 32)
            };

            if (driverMarker) {
                driverMarker.setPosition(driverPos);
                driverMarker.setIcon(rotatedIcon);
            } else {
                driverMarker = new google.maps.Marker({
                    position: driverPos,
                    map: map,
                    icon: rotatedIcon,
                    title: currentDriver.name,
                    zIndex: 1000
                });
            }

            // Update route every 3 seconds when driver is moving
            const now = Date.now();
            if (customerMarker && (now - lastRouteUpdate > 3000)) {
                lastRouteUpdate = now;
                calculateRoute(driverPos, customerMarker.getPosition());
            }

            // Fit bounds if both markers exist
            if (customerMarker && !directionsRenderer.getDirections()) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(driverPos);
                bounds.extend(customerMarker.getPosition());
                map.fitBounds(bounds, { padding: 60 });
            }
        }

        function calculateRoute(origin, destination) {
            if (!directionsService || !directionsRenderer) return;

            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Store route path for car snapping
                    routePath = result.routes[0].overview_path;
                    
                    // Get route info
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    // Update ETA display
                    const durationMins = Math.ceil(leg.duration.value / 60);
                    document.getElementById('etaTime').textContent = durationMins;
                    
                    // Update distance info if element exists
                    const distanceEl = document.getElementById('distanceText');
                    if (distanceEl) {
                        distanceEl.textContent = leg.distance.text;
                    }
                    
                    // Update header subtitle with live info
                    const subtitle = document.getElementById('headerSubtitle');
                    if (subtitle && currentDelivery.status === 'picked_up') {
                        subtitle.textContent = `${leg.distance.text} away ‚Ä¢ ${durationMins} min`;
                    }
                    
                    // Re-snap driver marker now that we have route
                    if (driverMarker && currentDriver) {
                        updateDriverMarker();
                    }
                }
            });
        }

        // ============================================
        // SHOW/HIDE STATES
        // ============================================
        function showContent() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            mainContent.style.display = 'block';
        }

        function showError() {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            mainContent.style.display = 'none';
        }

        // ============================================
        // DRIVER STORY
        // ============================================
        const driverStories = {
            default: "is a valued member of our community, helping connect local restaurants with neighbors like you. Every delivery supports local families and businesses.",
            // Add custom stories for specific drivers by their ID
        };

        function showDriverStory() {
            if (!currentDriver) return;
            
            const storyCard = document.getElementById('driverStoryCard');
            const storyAvatar = document.getElementById('storyAvatar');
            const storyText = document.getElementById('storyText');
            
            // Set driver photo if available
            if (currentDriver.photo_url) {
                storyAvatar.innerHTML = `<img src="${currentDriver.photo_url}" alt="${currentDriver.name}">`;
            }
            
            // Get custom story or default
            const story = driverStories[currentDriver.id] || driverStories.default;
            storyText.innerHTML = `<strong>${currentDriver.name}</strong> ${story}`;
            
            // Show the card with animation
            storyCard.style.display = 'block';
        }

        // ============================================
        // STAR RATING
        // ============================================
        let selectedRating = 0;
        let selectedTip = 0;

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                updateStars(selectedRating);
                
                // Show tip section after rating
                if (selectedRating >= 1) {
                    document.getElementById('tipSection').style.display = 'block';
                    document.getElementById('submitFeedbackBtn').disabled = false;
                }
                
                // Update rating label
                const labels = ['', 'Poor', 'Fair', 'Good', 'Great', 'Excellent!'];
                document.getElementById('ratingLabel').textContent = labels[selectedRating];
            });
            
            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.dataset.rating);
                updateStars(rating);
            });
            
            star.addEventListener('mouseleave', function() {
                updateStars(selectedRating);
            });
        });

        function updateStars(rating) {
            document.querySelectorAll('.star').forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                star.classList.toggle('active', starRating <= rating);
            });
        }

        // ============================================
        // TIP SELECTION
        // ============================================
        document.querySelectorAll('.tip-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove selected from all
                document.querySelectorAll('.tip-btn').forEach(b => b.classList.remove('selected'));
                
                if (this.id === 'customTipBtn') {
                    document.getElementById('customTipInput').style.display = 'flex';
                    this.classList.add('selected');
                    selectedTip = 0;
                } else {
                    document.getElementById('customTipInput').style.display = 'none';
                    this.classList.add('selected');
                    selectedTip = parseInt(this.dataset.amount);
                }
            });
        });

        document.getElementById('customTipAmount')?.addEventListener('input', function() {
            selectedTip = parseInt(this.value) || 0;
        });

        // ============================================
        // SUBMIT FEEDBACK
        // ============================================
        document.getElementById('submitFeedbackBtn')?.addEventListener('click', async function() {
            if (selectedRating === 0) return;
            
            this.disabled = true;
            this.textContent = 'Submitting...';
            
            try {
                // Save feedback to Supabase
                const { error } = await supabaseClient
                    .from('deliveries')
                    .update({
                        customer_rating: selectedRating,
                        customer_feedback: document.getElementById('feedbackComment').value,
                        tip_amount: selectedTip
                    })
                    .eq('id', currentDelivery.id);
                
                if (error) throw error;
                
                // Update driver's tip total if tip was given
                if (selectedTip > 0 && currentDriver) {
                    // You could update driver earnings here
                    console.log(`Tip of $${selectedTip} for driver ${currentDriver.name}`);
                }
                
                // Show thank you message
                document.querySelector('.feedback-card').style.display = 'none';
                document.getElementById('thankYouCard').style.display = 'block';
                
            } catch (err) {
                console.error('Error submitting feedback:', err);
                this.disabled = false;
                this.textContent = 'Submit Feedback';
                alert('Failed to submit feedback. Please try again.');
            }
        });

        // Order again button - opens WhatsApp
        document.getElementById('orderAgainBtn')?.addEventListener('click', function() {
            // Replace with your WhatsApp business number
            window.open('https://wa.me/14038265529?text=Hi! I would like to place an order.', '_blank');
        });

        // ============================================
        // HELP BUTTON & FAQ
        // ============================================
        const helpFab = document.getElementById('helpFab');
        const helpModal = document.getElementById('helpModal');
        const closeModal = document.getElementById('closeModal');
        const showFaq = document.getElementById('showFaq');
        const faqBack = document.getElementById('faqBack');
        const helpOptions = document.getElementById('helpOptions');
        const faqSection = document.getElementById('faqSection');

        // Open help modal
        helpFab?.addEventListener('click', () => {
            helpModal.classList.add('active');
            helpOptions.style.display = 'flex';
            faqSection.classList.remove('active');
        });

        // Close help modal
        closeModal?.addEventListener('click', () => {
            helpModal.classList.remove('active');
        });

        // Close on overlay click
        helpModal?.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.remove('active');
            }
        });

        // Show FAQ section
        showFaq?.addEventListener('click', () => {
            helpOptions.style.display = 'none';
            faqSection.classList.add('active');
        });

        // Back to help options
        faqBack?.addEventListener('click', () => {
            faqSection.classList.remove('active');
            helpOptions.style.display = 'flex';
        });

        // FAQ accordion
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', function() {
                const item = this.parentElement;
                const isOpen = item.classList.contains('open');
                
                // Close all others
                document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('open'));
                
                // Toggle current
                if (!isOpen) {
                    item.classList.add('open');
                }
            });
        });

        // ============================================
        // INITIALIZE
        // ============================================
        loadDelivery();
    </script>
</body>
</html>
