<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="YYC Track">
    <title>Track Your Order - YYC LocalFirst</title>
    
    <!-- App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAEUUlEQVR4nO3dzXHcRhSFUQxLe2ptx+AQnIPzcDzOwzk4BMVgrjURyAvXqChq/gA0XgO3z1lKKgpV+HTZBEec07QTr6+/fOt9DSx3Pr+del/DNE1Tt4sQcLZegZf+pSIeU2Xcm/9FIua9rePe7IMLmXu2Crv5BxUyc7QO+6XlBxMzc7Vupsm/DiHTQou1Xr3QYqaVFi2tClrMtLa2qUUTL2QqLDmCzF5oMVNlSWuzghYz1eY293TQYqaXOe01fQ4NvT0VtHWmt2cbfBi0mNmLZ1q8G7SY2ZtHTTpDE+Vm0NaZvbrX5tWgxcze3WrUkYMoPwVtnTmKa61aaKL8ELR15mg+NmuhiSJoonwP2nGDo3rfroUmiqCJ8jJNjhsc36VhC00UQRNF0EQ5OT+TxEITRdBEETRRBE0UQRPlU+8LuDj/80fvS2Cl19//7n0J/R/bCTlPz7C7BS3kfD3C7nKGFvMYetzn8qDFPJbq+10atJjHVHnfPbYjSlnQ1nlsVfffQhOlJGjrzDTVdGChiSJoogiaKIImiqCJImiiCJoogiaKoIkiaKIImiiCJoqgiSJoogiaKIImiqCJImiiCJoogiaKoIkiaKKUBL2HnxtMfxUdWGiilAVtpcdWdf8tNFFKg7bSY6q87+ULLeqxVN/vLkcOUY+hx332Llg0N+S7YH0k7OPbw2fe3QQNLXhsRxRBE0XQRBE0UQRNFEETRdBEETRRBE0UQRNF0EQRNFEETZRPvS/g4uvXf3tfAit9/vxr70vo//JRIefpGXa3oIWcr0fYXc7QYh5Dj/tcHrSYx1J9v0uDFvOYKu+7x3ZEKQvaOo+t6v5baKKUBG2dmaaaDiw0UQRNFEETRdBEETRRBE0UQRNF0EQRNFEETZTd/J9Cjuv05c+rv/7tt7+Kr8RCs9KtmB/93lYsNIs8G+vlz1WttYUmiqCZbclRour4IWhmWRNmRdSCJoqgiSJoogiaKIImimcK2YYlYfpOISzgtRwscllcR98sqX7FnYVmlXvB9nj5qIVmtR7h3lKy0Ht4Mxn6q+jAkYMoZUFb6bFV3X8LTZTSoK30mCrve/lCi3os1fe7y5FD1GPocZ+9NTLNDfnWyB8J+/j28Jl3N0FDCx7bEUXQRBE0UQRNlJfzuW3U+yKghfP57WShhSJooggaKC+n6f/Z4/cFwBqXhi00UQRNFEET5XvQjh0c1ft2LTRRBEWUn4J27OCoP jZroYnyU9BWmqO41qqFJsrVoK00e3er0ZsLLWr25l6bjhxEuRu0lWZvHjX5cKFFzV480+JTRw5R09uzDTpDE+XpoK00vchp79ZCi5pqc5ubfeQQNVWWtLYqTj/kkS2sGc1VXxRaa1pb29Tqpxyippuw2mqoTo+N4Kw1M7Vupvm2A2tNa2ubu80XVdi8t/Vn8dIjgrjHVHkU7XbmFXe2Xl9P7eaLOIEf214eCPwHfBUIaXT0g3gAAAABJRU5ErkJggg==">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAdklEQVR4nO2WwQrAIAwD0+H//3J3EPZBNrQIgrkZmuSpYuyIiF7Usy8A7Z8wF0gANjg4bQn0gS7QBC7wDwF0gS7QBC4wCAXQBbpAE7jAIBTYvnwN7S6wAGjLWjoBfGh3gQVA2/3g9wFJu4vsANryFvx/YIHNwAG+/wxKUPjcjQAAAABJRU5ErkJggg==">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252542;
            --accent-green: #00d26a;
            --accent-green-dim: rgba(0, 210, 106, 0.15);
            --accent-orange: #ff6b35;
            --accent-blue: #4dabf7;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-dim: #6b6b80;
            --border-color: #353550;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* App Logo */
        .app-logo {
            text-align: center;
            padding: 1rem 0 0.5rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .logo-yyc {
            font-size: 1.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00d26a, #00a854);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-local {
            font-size: 1.5rem;
            font-weight: 400;
            color: #ffffff;
            margin-left: 0.25rem;
        }

        .logo-first {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 1.5rem 0;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--accent-green-dim);
            color: var(--accent-green);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .status-badge.pending {
            background: rgba(255, 107, 53, 0.15);
            color: var(--accent-orange);
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Map Container */
        .map-container {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 16/10;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-center-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: var(--bg-card);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 100;
            transition: all 0.2s;
        }

        .map-center-btn:hover {
            background: var(--accent-green);
            color: #000;
        }

        .map-center-btn svg {
            width: 16px;
            height: 16px;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }

        .map-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 0.5rem;
            fill: var(--text-dim);
        }

        /* ETA Card */
        .eta-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .eta-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .eta-time {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-green);
        }

        .eta-time span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Driver Card */
        .driver-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .driver-avatar {
            width: 56px;
            height: 56px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .driver-avatar svg {
            width: 28px;
            height: 28px;
            fill: var(--text-dim);
        }

        .driver-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .driver-info {
            flex: 1;
        }

        .driver-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .driver-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .driver-action {
            background: var(--accent-green);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .driver-action:hover {
            transform: scale(1.1);
        }

        .driver-action svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        /* Order Details */
        .order-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .order-id {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .restaurant-name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .order-items {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Address */
        .address-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .address-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .address-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 0;
        }

        .step.completed:not(:last-child)::after {
            background: var(--accent-green);
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .step.completed .step-icon {
            background: var(--accent-green);
        }

        .step.active .step-icon {
            background: var(--accent-orange);
            animation: pulse 1.5s infinite;
        }

        .step-icon svg {
            width: 12px;
            height: 12px;
            fill: white;
        }

        .step-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
        }

        .step.completed .step-label,
        .step.active .step-label {
            color: var(--text-secondary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error {
            text-align: center;
            padding: 4rem 2rem;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            background: rgba(255, 71, 87, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .error-icon svg {
            width: 32px;
            height: 32px;
            fill: #ff4757;
        }

        .error h2 {
            margin-bottom: 0.5rem;
        }

        .error p {
            color: var(--text-secondary);
        }

        /* Delivered State */
        .delivered-banner {
            background: var(--accent-green-dim);
            border: 2px solid var(--accent-green);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .delivered-banner h2 {
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .delivered-banner p {
            color: var(--text-secondary);
        }

        .delivery-photo {
            width: 100%;
            border-radius: 12px;
            margin-top: 1rem;
        }

        /* Driver Story Card */
        .driver-story-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%);
            border: 1px solid #8b5cf6;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-header {
            margin-bottom: 0.75rem;
        }

        .story-badge {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .story-content {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .story-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .story-avatar svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .story-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        .story-footer {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Feedback Section */
        .feedback-section {
            margin-bottom: 1rem;
        }

        .feedback-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .feedback-card h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .star {
            font-size: 2.5rem;
            color: var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover,
        .star.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .star.active {
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .rating-label {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        /* Tip Section */
        .tip-section {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        .tip-prompt {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .tip-options {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tip-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tip-btn:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .tip-btn.selected {
            border-color: #8b5cf6;
            background: #8b5cf6;
            color: white;
        }

        .custom-tip-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            margin-top: 0.75rem;
        }

        .custom-tip-input .currency {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .custom-tip-input input {
            width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.1rem;
            text-align: center;
        }

        .custom-tip-input input:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .feedback-comment {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
            height: 80px;
            margin-bottom: 1rem;
        }

        .feedback-comment:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .submit-feedback-btn {
            width: 100%;
            padding: 1rem;
            background: var(--accent-green);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-feedback-btn:hover {
            background: #00e676;
            transform: translateY(-2px);
        }

        .submit-feedback-btn:disabled {
            background: var(--border-color);
            color: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        /* Thank You Card */
        .thank-you-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }

        .thank-you-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .thank-you-card h3 {
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .thank-you-card p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .order-again-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .order-again-btn:hover {
            background: #22c55e;
            transform: translateY(-2px);
        }

        /* Floating Help Button */
        .help-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d26a, #00a854);
            border: none;
            box-shadow: 0 4px 20px rgba(0, 210, 106, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .help-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 210, 106, 0.5);
        }

        .help-fab svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .help-fab-label {
            position: absolute;
            right: 70px;
            background: white;
            color: #1a1a2e;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .help-fab:hover .help-fab-label {
            opacity: 1;
        }

        /* Help Modal */
        .help-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 1rem;
        }

        .help-modal-overlay.active {
            display: flex;
        }

        .help-modal {
            background: var(--bg-secondary);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
        }

        .help-modal-header h3 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .help-options {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .help-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .help-option:hover {
            background: var(--border-color);
            transform: translateX(5px);
        }

        .help-option-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .help-option-icon.whatsapp {
            background: rgba(37, 211, 102, 0.15);
        }

        .help-option-icon.phone {
            background: rgba(59, 130, 246, 0.15);
        }

        .help-option-icon.faq {
            background: rgba(251, 191, 36, 0.15);
        }

        .help-option-text {
            text-align: left;
        }

        .help-option-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .help-option-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* FAQ Section */
        .faq-section {
            padding: 1rem;
            display: none;
        }

        .faq-section.active {
            display: block;
        }

        .faq-back {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--accent-green);
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 1rem;
            padding: 0;
        }

        .faq-item {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .faq-question {
            width: 100%;
            padding: 1rem;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .faq-question:hover {
            background: rgba(255,255,255,0.05);
        }

        .faq-question .arrow {
            transition: transform 0.3s ease;
        }

        .faq-item.open .faq-question .arrow {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .faq-item.open .faq-answer {
            max-height: 200px;
        }

        .faq-answer p {
            padding: 0 1rem 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--accent-green);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="loading-spinner"></div>
            <p>Finding your order...</p>
        </div>

        <!-- Error State -->
        <div class="error" id="errorState" style="display: none;">
            <div class="error-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </div>
            <h2>Order not found</h2>
            <p>This tracking link may have expired or is invalid.</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Logo -->
            <div class="app-logo">
                <span class="logo-yyc">YYC</span>
                <span class="logo-local">Local</span><span class="logo-first">First</span>
            </div>

            <!-- Header -->
            <div class="header">
                <div class="status-badge" id="statusBadge">
                    <span class="dot"></span>
                    <span id="statusText">On the way</span>
                </div>
                <h1 id="headerTitle">Your order is coming!</h1>
                <p id="headerSubtitle">Estimated arrival in a few minutes</p>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps" id="progressSteps">
                <div class="step completed" id="step1">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Confirmed</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Picked Up</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">On the way</span>
                </div>
                <div class="step" id="step4">
                    <div class="step-icon">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <span class="step-label">Delivered</span>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container">
                <div id="map">
                    
                </div>
                <button class="map-center-btn" id="centerOnDriver" title="Center on driver">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3" fill="currentColor"/>
                        <line x1="12" y1="2" x2="12" y2="6"/>
                        <line x1="12" y1="18" x2="12" y2="22"/>
                        <line x1="2" y1="12" x2="6" y2="12"/>
                        <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                    Center
                </button>
            </div>

            <!-- ETA Card -->
            <div class="eta-card" id="etaCard">
                <div class="eta-label">Estimated Arrival</div>
                <div class="eta-time"><span id="etaTime">--</span> <span>min</span></div>
                <div class="eta-distance" id="distanceText" style="color: #a0a0b8; font-size: 0.9rem; margin-top: 0.5rem;"></div>
            </div>

            <!-- Driver Card -->
            <div class="driver-card" id="driverCard">
                <div class="driver-avatar" id="driverAvatar">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="driver-info">
                    <div class="driver-name" id="driverName">Your driver</div>
                    <div class="driver-status" id="driverStatus">Picking up your order</div>
                </div>
                <button class="driver-action" id="callDriver" title="Message driver">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                </button>
            </div>

            <!-- Driver Story Card (shows while on route) -->
            <div class="driver-story-card" id="driverStoryCard" style="display: none;">
                <div class="story-header">
                    <span class="story-badge">üíú Meet Your Driver</span>
                </div>
                <div class="story-content">
                    <div class="story-avatar" id="storyAvatar">
                        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    </div>
                    <div class="story-text">
                        <p id="storyText">Your driver is a valued member of our community, helping connect local restaurants with neighbors like you.</p>
                    </div>
                </div>
                <div class="story-footer">
                    <span>üöó Supporting local families & businesses</span>
                </div>
            </div>

            <!-- Delivered Banner (hidden by default) -->
            <div class="delivered-banner" id="deliveredBanner" style="display: none;">
                <h2>‚úÖ Order Delivered!</h2>
                <p>Thank you for ordering with YYC LocalFirst</p>
                <img class="delivery-photo" id="deliveryPhoto" style="display: none;">
            </div>

            <!-- Feedback & Tip Section (hidden until delivered) -->
            <div class="feedback-section" id="feedbackSection" style="display: none;">
                <div class="feedback-card">
                    <h3>How was your delivery?</h3>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <p class="rating-label" id="ratingLabel">Tap to rate</p>
                    
                    <div class="tip-section" id="tipSection" style="display: none;">
                        <p class="tip-prompt">üíú Say thanks to <span id="tipDriverName">your driver</span> with a tip</p>
                        <div class="tip-options">
                            <button class="tip-btn" data-amount="2">$2</button>
                            <button class="tip-btn" data-amount="3">$3</button>
                            <button class="tip-btn" data-amount="5">$5</button>
                            <button class="tip-btn custom-tip" id="customTipBtn">Other</button>
                        </div>
                        <div class="custom-tip-input" id="customTipInput" style="display: none;">
                            <span class="currency">$</span>
                            <input type="number" id="customTipAmount" min="1" max="50" placeholder="0">
                        </div>
                    </div>
                    
                    <textarea class="feedback-comment" id="feedbackComment" placeholder="Any comments? (optional)"></textarea>
                    
                    <button class="submit-feedback-btn" id="submitFeedbackBtn">Submit Feedback</button>
                </div>
                
                <!-- Thank You Message (after submission) -->
                <div class="thank-you-card" id="thankYouCard" style="display: none;">
                    <div class="thank-you-icon">üíö</div>
                    <h3>Thank you!</h3>
                    <p>Your feedback helps us improve</p>
                    <button class="order-again-btn" id="orderAgainBtn">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z" fill="#25D366"/></svg>
                        Order again on WhatsApp
                    </button>
                </div>
            </div>

            <!-- Order Details -->
            <div class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-id" id="orderId">#ORDER</div>
                        <div class="restaurant-name" id="restaurantName">Restaurant</div>
                    </div>
                </div>
                <div class="order-items" id="orderItems">
                    Loading order details...
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="address-card">
                <div class="address-label">Delivering to</div>
                <div class="address-text" id="deliveryAddress">Loading address...</div>
            </div>

            <!-- Footer -->
            <div class="footer">
                Powered by <a href="#">YYC LocalFirst</a><br>
                Supporting local restaurants üíö
            </div>
        </div>
    </div>

    <!-- Floating Help Button -->
    <button class="help-fab" id="helpFab" aria-label="Need help?">
        <span class="help-fab-label">Need help?</span>
        <svg viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg>
    </button>

    <!-- Help Modal -->
    <div class="help-modal-overlay" id="helpModal">
        <div class="help-modal">
            <div class="help-modal-header">
                <h3>üí¨ How can we help?</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <!-- Main Help Options -->
            <div class="help-options" id="helpOptions">
                <a href="https://wa.me/14038265529?text=Hi! I need help with my order." class="help-option" target="_blank">
                    <div class="help-option-icon whatsapp">üí¨</div>
                    <div class="help-option-text">
                        <div class="help-option-title">Chat on WhatsApp</div>
                        <div class="help-option-desc">Get instant support</div>
                    </div>
                </a>
                
                <a href="tel:+14038265529" class="help-option">
                    <div class="help-option-icon phone">üìû</div>
                    <div class="help-option-text">
                        <div class="help-option-title">Call Us</div>
                        <div class="help-option-desc">Speak with our team</div>
                    </div>
                </a>
                
                <button class="help-option" id="showFaq">
                    <div class="help-option-icon faq">‚ùì</div>
                    <div class="help-option-text">
                        <div class="help-option-title">FAQs</div>
                        <div class="help-option-desc">Common questions answered</div>
                    </div>
                </button>
            </div>
            
            <!-- FAQ Section -->
            <div class="faq-section" id="faqSection">
                <button class="faq-back" id="faqBack">
                    ‚Üê Back to options
                </button>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Where is my order?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>You can track your order in real-time on this page. The map shows your driver's exact location. If the driver hasn't moved for a while, they may be picking up your order or in traffic.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How do I contact my driver?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>Tap the message icon next to your driver's name on the tracking page to send them a WhatsApp message directly.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How long does delivery take?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>Most deliveries arrive within 30-45 minutes. The estimated arrival time on your tracking page updates in real-time based on your driver's location and traffic.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Can I change my delivery address?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>If your driver hasn't picked up the order yet, contact us immediately via WhatsApp and we'll update your address. Once picked up, address changes may not be possible.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        How do I get a refund?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>If there's an issue with your order, please contact us on WhatsApp with your order number. We review all refund requests within 24 hours and prioritize your satisfaction.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Why support local restaurants?
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="faq-answer">
                        <p>We charge restaurants only 15% commission vs 25-30% from big chains. This means more money stays with local families and our Calgary community. Thank you for choosing local! üíö</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4T_RiDo2RqzDZNnhoUwwsrEQqf1AjUMs"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // STATE
        // ============================================
        let currentDelivery = null;
        let currentDriver = null;

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const mainContent = document.getElementById('mainContent');

        // ============================================
        // GET TRACKING TOKEN FROM URL
        // ============================================
        function getTrackingToken() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        function isDemoMode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('demo') === 'true';
        }

        // ============================================
        // DEMO DATA
        // ============================================
        const demoDelivery = {
            id: 'demo-001',
            tracking_token: 'demo',
            status: 'picked_up',
            customer_name: 'Demo Customer',
            customer_phone: '+14035551234',
            customer_address: '123 Demo Street NE, Calgary',
            customer_lat: 51.0747,
            customer_lng: -114.0719,
            restaurant_name: 'AB King Pizza',
            order_total: 45.99,
            created_at: new Date().toISOString()
        };

        const demoDriver = {
            id: 'demo-driver',
            name: 'Raj Singh',
            phone: '+14035559999',
            photo_url: null,
            vehicle_type: 'car',
            vehicle_color: 'Red',
            vehicle_model: 'Toyota Camry',
            current_lat: 51.0697,
            current_lng: -114.0800,
            is_online: true
        };

        // Demo mode: simulate driver movement
        let demoInterval = null;
        function startDemoMovement() {
            let step = 0;
            // Full route with many waypoints for smooth movement
            const route = [
                { lat: 51.0697, lng: -114.0800 },
                { lat: 51.0699, lng: -114.0796 },
                { lat: 51.0701, lng: -114.0792 },
                { lat: 51.0703, lng: -114.0788 },
                { lat: 51.0705, lng: -114.0784 },
                { lat: 51.0707, lng: -114.0780 },
                { lat: 51.0709, lng: -114.0776 },
                { lat: 51.0711, lng: -114.0772 },
                { lat: 51.0713, lng: -114.0768 },
                { lat: 51.0715, lng: -114.0764 },
                { lat: 51.0717, lng: -114.0760 },
                { lat: 51.0719, lng: -114.0756 },
                { lat: 51.0721, lng: -114.0752 },
                { lat: 51.0723, lng: -114.0748 },
                { lat: 51.0725, lng: -114.0744 },
                { lat: 51.0727, lng: -114.0740 },
                { lat: 51.0729, lng: -114.0736 },
                { lat: 51.0731, lng: -114.0732 },
                { lat: 51.0733, lng: -114.0728 },
                { lat: 51.0735, lng: -114.0724 },
                { lat: 51.0737, lng: -114.0722 },
                { lat: 51.0739, lng: -114.0720 },
                { lat: 51.0741, lng: -114.0719 },
                { lat: 51.0743, lng: -114.0719 },
                { lat: 51.0745, lng: -114.0719 },
                { lat: 51.0747, lng: -114.0719 }
            ];
            
            // 5x speed: 600ms instead of 3000ms
            demoInterval = setInterval(() => {
                if (step < route.length) {
                    currentDriver.current_lat = route[step].lat;
                    currentDriver.current_lng = route[step].lng;
                    updateDriverLocation();
                    step++;
                } else {
                    clearInterval(demoInterval);
                    // Mark as delivered
                    currentDelivery.status = 'delivered';
                    updateUI();
                }
            }, 600);
        }

        // ============================================
        // LOAD DELIVERY
        // ============================================
        async function loadDelivery() {
            const token = getTrackingToken();
            
            // Check for demo mode OR no token (auto-demo for preview)
            if (isDemoMode() || !token) {
                currentDelivery = demoDelivery;
                currentDriver = demoDriver;
                showContent();
                updateUI();
                startDemoMovement();
                return;
            }

            try {
                // Get delivery by tracking token
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('tracking_token', token)
                    .single();

                if (error || !delivery) {
                    showError();
                    return;
                }

                currentDelivery = delivery;

                // Get driver info if assigned
                if (delivery.driver_id) {
                    const { data: driver } = await supabaseClient
                        .from('drivers')
                        .select('*')
                        .eq('id', delivery.driver_id)
                        .single();
                    
                    currentDriver = driver;
                }

                showContent();
                updateUI();
                subscribeToUpdates();

            } catch (err) {
                console.error('Error loading delivery:', err);
                showError();
            }
        }

        // ============================================
        // SUBSCRIBE TO REALTIME UPDATES
        // ============================================
        function subscribeToUpdates() {
            // Subscribe to delivery updates
            supabaseClient
                .channel('tracking-channel')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'deliveries',
                        filter: `id=eq.${currentDelivery.id}`
                    }, 
                    async (payload) => {
                        console.log('Delivery update:', payload);
                        currentDelivery = payload.new;
                        updateUI();
                    }
                )
                .subscribe();

            // Subscribe to driver location updates if assigned
            if (currentDriver) {
                supabaseClient
                    .channel('driver-location-channel')
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'drivers',
                            filter: `id=eq.${currentDriver.id}`
                        }, 
                        (payload) => {
                            console.log('Driver location update:', payload);
                            currentDriver = payload.new;
                            updateDriverLocation();
                        }
                    )
                    .subscribe();
            }
        }

        // ============================================
        // UPDATE UI
        // ============================================
        function updateUI() {
            if (!currentDelivery) return;

            // Order details
            document.getElementById('orderId').textContent = `#${currentDelivery.order_id}`;
            document.getElementById('restaurantName').textContent = currentDelivery.restaurant_name;
            document.getElementById('orderItems').textContent = currentDelivery.items_summary || 'Order items';
            document.getElementById('deliveryAddress').textContent = currentDelivery.customer_address;

            // Driver info
            if (currentDriver) {
                document.getElementById('driverName').textContent = currentDriver.name;
                document.getElementById('driverCard').style.display = 'flex';
                
                // WhatsApp link
                document.getElementById('callDriver').onclick = () => {
                    const phone = currentDriver.phone.replace('+', '');
                    window.open(`https://wa.me/${phone}`, '_blank');
                };
            } else {
                document.getElementById('driverCard').style.display = 'none';
            }

            // Update based on status
            updateStatus(currentDelivery.status);
        }

        // ============================================
        // UPDATE STATUS
        // ============================================
        function updateStatus(status) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const driverStatus = document.getElementById('driverStatus');
            const etaCard = document.getElementById('etaCard');
            const deliveredBanner = document.getElementById('deliveredBanner');

            // Reset steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('completed', 'active');
            });

            switch (status) {
                case 'pending':
                    statusText.textContent = 'Order received';
                    statusBadge.className = 'status-badge pending';
                    headerTitle.textContent = 'Preparing your order';
                    headerSubtitle.textContent = 'Finding a driver for you';
                    driverStatus.textContent = 'Finding a driver...';
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('etaTime').textContent = '--';
                    break;

                case 'assigned':
                    statusText.textContent = 'Driver assigned';
                    statusBadge.className = 'status-badge pending';
                    headerTitle.textContent = 'Driver on the way to restaurant';
                    headerSubtitle.textContent = 'Your order will be picked up soon';
                    driverStatus.textContent = 'Heading to pickup';
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('etaTime').textContent = '15-20';
                    break;

                case 'picked_up':
                case 'delivering':
                    statusText.textContent = 'On the way';
                    statusBadge.className = 'status-badge';
                    headerTitle.textContent = 'Your order is on the way!';
                    headerSubtitle.textContent = 'Driver has picked up your food';
                    driverStatus.textContent = 'Delivering to you';
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('active');
                    document.getElementById('etaTime').textContent = '5-10';
                    
                    // Show driver story while on route
                    showDriverStory();
                    break;

                case 'delivered':
                    statusText.textContent = 'Delivered';
                    statusBadge.className = 'status-badge';
                    headerTitle.textContent = 'Order delivered!';
                    headerSubtitle.textContent = 'Enjoy your meal!';
                    driverStatus.textContent = 'Delivery completed';
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.add('completed');
                    });
                    etaCard.style.display = 'none';
                    deliveredBanner.style.display = 'block';
                    
                    // Hide driver story, show feedback section
                    document.getElementById('driverStoryCard').style.display = 'none';
                    document.getElementById('feedbackSection').style.display = 'block';
                    
                    // Set driver name in tip section
                    if (currentDriver) {
                        document.getElementById('tipDriverName').textContent = currentDriver.name;
                    }
                    
                    // Show delivery photo if available
                    if (currentDelivery.delivery_photo_url) {
                        const photo = document.getElementById('deliveryPhoto');
                        photo.src = currentDelivery.delivery_photo_url;
                        photo.style.display = 'block';
                    }
                    break;
            }
        }

        // ============================================
        // UPDATE DRIVER LOCATION ON MAP
        // ============================================
        function updateDriverLocation() {
            if (currentDriver && currentDriver.current_lat && currentDriver.current_lng) {
                console.log('Driver location:', currentDriver.current_lat, currentDriver.current_lng);
                updateDriverMarker();
            }
        }

        // ============================================
        // GOOGLE MAPS WITH DIRECTIONS
        // ============================================
        let map = null;
        let driverMarker = null;
        let customerMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let lastRouteUpdate = 0;
        let lastDriverLat = null;
        let lastDriverLng = null;
        let carRotation = 0;
        let routePath = []; // Store the route polyline points

        // Red car - top-down view
        const carImageBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAlCAYAAADV/m7fAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH6gEJFi8cJdVPngAAGZhJREFUaN7dmnusJdlV3n9r711V53Hvueee++i+/ZjunnEzw7w9MHZsY2wMEZBYiQMRxEFBAmEQ5B+CQYAgCYkIgZBIvIQl/gqJg0kMKJCXSIDB9piJ7QEN8+yemZ5+Td/uvs9z7nnVY++98kfVvd1jE0QiJYpypNI9t6pO1d5ffetb31q74P+DzxP3net+7UMPLX714hI/85Hv/b96b/nf+dHf/7YPM968Tcc4fCgJocAhRAUxBptkVBj668f48U98/P/4JP7a4489upSXPzSpyp+7dOnSHz///xKAP/6P/iGf+vVPMp9O6biM01nKyXnBjcfPmo2DmGgoXYilSVQERY2x0SPhC595uvo7//Qnw4Vnn+P6hZcxASyGxBhEFOMcggFVlIixFhVBo+LwZFlK68wZSB02KsWVN/GjMV6E0ns8EXFCFMvg3Pnl5a2bv/fCpUtZe239by122y/OSk/lPdE6Zr4k9wENnr5LuKfdZi0YxrMRZYx4ZxCBNG1hl9eYpcK/+P3f/wsB6L54x0ff+/WM+y3odTm4eoWbn/x3fOaVV+T+k6f7WSL3l+ije0ud86uX906oyMBA20hMDBgFDYj3xs4ff//79/77U5+6lnsuz2O8ZYNuWXQSYixEVK2xzhiMEUQRsUaMIoKIBhWNYqiUExq161THOHvdumRurInWJT6KRpdITIzz+daW1zR5rot8Zz7a/w69//4f3ZvlujMa6zgq08k+be/titBGZClxSd8pXZNm7QRN1UoU0Um71d5NFxa2tt//2P4HpyO9XZQM0ja/+7nP/cUY+LH3foBn1jqsb8/c7XtPrI8uXHiAvf1HMzUPt4x9tG3T8z0n/a4RUnE4I6TWYE29FdGTGYcTIe208MFTFRV+PvcGyYFC0FIVvPe2qioJ3ksIQSIqEZVCUatRRZCi1ep6cAT1YT4fxhCLYCRWUJUaY0BjCUUQU4yCbLx+sH/P473uzSc7vWdLMTFYG2Li1BsxUaQdYSWzds2V5WJ5ME6NS9zN2dTG6NUaU6Wtzjjr9TbtwsIXLif8+23ks/ecOTM5NvMsb+3yD57+/T8fQAX5ng998N3a7X/fybJ4Ynln+56eSGcpa7PUylhotWinKa0kpZU4EmdJrcOIYAUOioIYIXGOafDMtKLwnnkQDiKMypKpL5n6wLysKHxFUVVUMVKpElSZVxXWCMYaPIKoElVRFGIkhEgVPFUMFD4wyudsjcfsT+fYhQUeGCzz9oMx7fEMW8zINJIay0KaIefOIK0ORTHHW4Mzlld39yhnc3zlyauSArjv2HG2u9lkp99/uru29qvnYvJ7o+sv7iyWkZ9+9vk/G8Af+8D7GEn64OuL2W++fe3YA9+z0GctsTiXYa0BiQiCV6XSQFWVzOY543nBgbFcm065Pp1ybTIhd45JVIblnICgxlER0QgqUl9LBJFae+phKPP5nNlsTqfd4fiJDcqiRImAolGJGtEY7wCqoDGyu7vL7tY2icK9x47z8MYG6c1NyqtX6IZIah3LKyvsGSimM3pVYGN1hWPnzrKyvk4na6HAPHiGRUExnbC7tcMf3XiTF9tZefbYiT+5Zz7/Zyer4W9fdq34zz/7hS/VwJWobrNtv285ygPf4BK6RhhVFbEsKcuKvCzZG0/YG43Zmo4ZTSeMZnOKNKH3zndwzcDV8Yh5WRHnEVUYj8ekaVpDECNR6w0iqloDqjX3VSPz+YzKB86cPsvO9jaj0RARwYqts7sVWi5hIeuwmKUsJylpWTLLOvilPj7P2b12jc9duMBOVTJVxYmh3cr4rjNn+buPPMxoMuXmcMi13S2ev/gqk+dfYGkw4Oyx45zb2ODhwYDuxnHCvffx2OUNfu1TT6V/uDv8S+bMPb98cybD/SR96ksY+LWnTnP2kUcf953Wf3n3YPn4Ny0PSKS2JZdubfLKa68zGk8Ql5BkKS5LWEhSUptgrWCzlKw/QFothrMZe/kMZyxVDHhjqGLN3JJAqZEQIErNRiO2HohAQBFjWVzooRoQVRJjaBlDZgyJKi5EjPfMYsW4CuwXBftEcmuYq/CHzzzDaDIlSRMEQQFxhqUQ+fgHP8hXbpwkAD5G5rs73L70Om/ceJPre0O2VKl6CxxbXeOBU6d56ORpOvmc3/z0p/mPWUrSbT+V5uFbrLZ3/tVzn67H/eEvf5TPXXvDvesDX/PTp1ZXPvqR9XXWMRQx4L1nfzbFqMEYy/XJmCvDPfYmU2ahIskyFheXcM4hGhu2CL7MubfdpesSqqhHTysiNXB6Rz3U1sdVBRVDTUhtglqIErECTgypSWg5h00Mv7F9k4s+kqQJzjlQodvpcnPzBhcuXEREyLKMPJ9TVp6iKvibp07zM1/3l3HWYIypZUSVap4z295h59pVrl+7yqWdXS55z7zb5YF7TvEVC4v8ySsv8dTGiaCd3g+cf8b94k/FP6hn8Y2Pvcsc18nfTtaP/eK33neu/57BGpO8YB48AAbBiPDG3h4f+U+/w1ZU1jc26A8GrK6u0m63iSFQ+YoYAyF4ugo/+rYv51ynTYy+1iqtdaxGL4JC1IZ6TTDU8CkiijUWIxYrdRha4zDGgAGM8AtvvMbTec7qyirGWLwPqCqnT59mNptx6dIlNjc3mc1m7O7u4hJLd1bwbz70Ic4PljBimusbEEFN/eDivGCys8PNq1e5cvl1Lmxts12WLMbArazF5r3nX9Kl5b+yru7ax57+r7hz+fAdttP5yXPi+o+2u4QYSZzFOEM9WsEQuLi3Q9Xv8w3vfg9LvR5iDDFGqqqiKApMYQgh4BGyGFlMhEUnoA5T44WiiMaGfU14fbEtUK3PPUwuqtT2sOZwVEFEWDAphBmttEWMykJ/kfF4jLWWkydPcvLkSTY3N3nhhReYTCaUZcFIhOdu3OS+/jIBxZqIChgRROt72Fab/unT9E6f4t53PMGTW1tsvXaZN65cpTcZ09rbfXA3VN/6sZde/FlUcaLhvQV65qvOnKWTttGoiEgzeFANFDHyRlny5LvezfJS/3CmdyYtwtJSD+89e3v7oB7ViI8BYnOqKCIgR6A01knvhlHr428xVnLnPKmPGhX6SUIMAdWIMULiGoY25xpjOHXqFIPBgE6nwxee/TxliLy0u81fj6G+blREImoaAAE5nJcRkrTDyj3nWL7nLG+bzinzgov7O/Ibn3n6e79hsPrss48/+KwpY+yutzqcHfRRIorWUaZKjJEQA9OqhLVV+ku13jlnSZKExDmsMSRJQn+5T7fbbTSszrJVUHxUAkoAgtbiHTQSYqyP6Z3sHDUStB5F/b++5ViMEW2uvZqkqA/EGBEj+FCHcP1A7jycNE15+9vfzmOPPMp8nnNtPmfuK7Txl0EjXiNeQ73F+v8QQl0IeF/fo9OiszLgy86e44F295zMp99d3HfOOmOM+4oTG3SMoDHUg4b64hFC9GxNJ7y8uUkrwurqKlmWYp0liCeGQNTYPD1TTyBGNCpVrPfbKEeZtg7cL/7cxeZGH794/yHTUSHB0HMpNkZ88LjEMZvNqKoaGBGhqiqGwyHb29vcunWL/f0hIXiuDveYVCWZTRq6gMS7okBCEzF1BApAAIzB4jHjKRsC68E/0n/+pZ5bbHXN2X4fVSXEQ6bUzKmChxi4sr/P5198meTadfq9HqdPneLUPadY6i3SMi3KA8/Ozg7e15mb0FQNMTaQNACrYO42UPIWJWhYc+e4HlnsRj+bEwKejoUUZV4WuCzDe09RFNy+fZvr169z69Yt9vb2mM1mFEWBtZblwYD96ZRJWdBvtUEF0ebBHN6t0Vs5lBQf0Dyn3NkhXHqN8vpN5GDIQFlfmeUrbm11sLjUahFiIESl0po5IUYCEYuwPZkQrSFNU/KiYGtnh8l0zNJSj9XVNdKsTVUVFEVBCAFihFAnGOMSjtKG3PlrGmPDod42H9OwQgGNAQkBQkC9J1YV6gNViJDn7L15g+tv3qDfW2I6mbCzu8vKykrtDGIkBI/3FdZanHMsdLvMDw6Yz+bQWzoal4mxvkfl0bxAp1PC6IBquE+5t0+1t081OiDVgBhD8CWJxl63rAauv7iQWmeoQqi3w5JJI7GYM7t5m5sXLmKco5VliECWpSDCcH/E/t4I42zNeIX94YiVNOX2zZvcLiuWFxdZ7y01YX0HDELdXjoEW0KE4KGo0KIg5HPiPEfyObEoiZUnVgWECFEZo7w5G/NSDHSyFr3FHiEGfFXRHgwoioLpdEKSODrtLpX3WI1oVbH3qaeZrK5AmqIxonkBkwlhNqPMC0Ixh8rjG40MWkdmKnX9XGhElZaDgcu2dn0RlWRjgzx4psMh85s3Kbdu4/f3mRxMGKcp7Y3jdLpdNHgSZxFjEWfQqPhQUZQl08mUl16+gE8Snrlxk16Scm46xkbQEJHYsDP6Gu1GrwyCOYzdw/2NlYl3h3edOFGFonGNiJLnc7oLC3VPEYXoCcEDQpJkGBEgYqSugCa3txjfeBMVEDV3Gf1IoL5HRPFEKoXqMOGIYlHKOrqdKAtu/sbrk9HzU6bdLqPgORgfEMoS19C7QPCtDGMN1kBQg7EOYywiQiAg0YBKM3cln01x8ykZhkRhYg8lrzatpjErpkk8xghGzB3xM3dkMiJ3sqsqMdbuYCKGQiOoobe4SLfbZT6fE0LEh1rPRO78VtTgy4Kq8uQaKRrLZIQm69+d+eu84VFKVaomj0SFNCqFKF6MdWnWcaNQ6awqke0pBxqZAB5Im05D0fwwhEiMivee4APYenAxBqqq4uDggMlkgqJYYClCjwgCRaz9n2lYUH8/rHIgqmDtXVWJKqJ3Uog2liQ28hI0MkKZK3TabVyaMByOCMGztLTEbD4/ysZFWR5dM0TFiBBDoAi1/TENxyN1Oy0qDWCKb76XDSaxMXol4Ovsg5sliebUA54B4+YHHSADSgGJgeA9VeWJ/tBmNIwIkTzPyfO8zsBoXUVozZ+AUDVYWBSnh2ZZmuzHnb9HeVfuArPer1pDGZvJDUUoxDAYDGi1UvK8YDqZkiQJWZbV3k1gPs8Zzee0221m8xl4T4yBHMUph0JQGwdVPIfsq3Eo7wLQNkmuQAhKDGVZurzVjhMjtJoDOUp+ZB2gVCXRgIZAqJoKo6rqucVIURbkec7q6ipFUXBre6v2htKEQqNn5i5XJ6buBRqpi3prTH2O1Kx8q0PUI63TBmINypBIIcJyq4W1hlamVGVZX8/W8iIkGBGms5rB0+mUlvcgkRAVUaFZyqmtWwPe3ayrDqPw8JjWx6LgTdSxy9tdGSYpa3lJ2Whefmgwm4u0sKQNU0QspfcYa/HBUxQ5IXr6/SVGowNMozv+iyzzUdiKYMXgxOBMvVkxWBGsuePBmh5NY+ib8lIVDR4jsI8QrKXVbjflnMHZvB6z903IH3rRJklopIXikNobA6ExM4esOwTQHwEoVA0evnGjVW33i0jcd3ni4o1Wi7XxGBB8vXBB0DtC3tbIQlB8DCSJo6xKEufw3tflTlkynU7rsGlCML7FL98BTwQsNYiHaymJrQE1IjTl7FFbK6pijGJiLSUaDU6EPQBnscbUiZ363kdANwDGuwCsqopVhUylkYOjfvcRgP4uIH0jF3c7garZIjJRY/dc9CFcTFu8zTmM98TDuG98nUMw3rNSVbxZlSSpQ2O9LhFiRFUoS8+rr76GtRYfAqEpMeSukuwQxMNmgag2xbweLW3eqUTuanEd6qkIauo2lxhlL3hckuKco6qq+jqmjhK928vGgDG1VITKc9JYEu/vyIOCl7eC9sVAHkrQoUqXouTCTkjTXWdDzMvVAW/MRpzeHx/lvaDCHLACEiPLRc6Le3skLiHN0qOnG1URY5jO5w0LA6WAR8ilpr0oWI2YukdFNB7EYNXiAlhjamvTtJYcgtN6oSoVIRXBEppODngj7CsYY+6EajhMNOBjQDUQfAQVnLM1yGXJeWOxGo+61fHI993RucPvNMBZoA10EKYC0RhIks/r8f6+G0f/aaPp9Qu9/ulsVuKKAqeHlaGSNNnkRPSwt88bowPSLDsC1oVI4j2nY2Aprdcpes5SKGyJItbgXELiUlpJgkkdJk1xSYpa2zCrYVgTViYohIivCmJRUZUVVT5Bco8tKnwVuRUj0+mEyXRCmiSEphsTY8BXNatDo9Wqkd29PTYE7tWA5UubGnenLgO0raXdXWBxdYXl9WO0WxkHr7zKHpFR8JeiM790eWffu4uheuZUPvvx4cLCL1y+f7B04vIVWuMhHYEUQayjdA4nhq9utcitpZWmLLVaHGu3WesusNLusJJlLHcXMe2U2OnQXurjs4SQJpRpQmUc3tSsDMbijRCkeeJi8CHiQ92+77bapGKQ6LFRSYLHFSVmPqccH5Dv7vEd21s8u3mTl3e22JzOmCskacJCkZPYeq0sxkjasG82nfCBJOHYPCe5q9cjgLOGNGuR9Hp0VldZ3DjO8vpx2ks9bDvDz3Oufv5PuJznXFrqsXls5ddvf/7Zlz8rgjtmTLw+Hf7a+pn73v3pN9/8noeLOSebToh2Wjzw4COcP32GbKFFltYLSSZETFSqWGfhiSqTY8d5ziVsHuxD1kYN3Nq+zcJSD5W6e33Y2r/T2pLaLooQQqAqCpxz9Pp9nHOURXlUwYgIxkK23KfT79O79ywfLAq+cXuP7Vu3uPzmDV64eYOrm7fYSRw2bdHKUjrGMBwdMAiBr1OhGxWbZmT9Jdrr63SPHae7tkZrZUDaW8SlKRhLPp1w45ULjGdTNm9vcfHSJS4tLFBsHHsz9Hq/fupbPqQA7j+/9jrvP3fOt2bT324tdr794m1tr4mQKkheMNm8wUG7xZpZY6GzQCwLprduo+Mx83nFMLOUH/ganr69xXOv/SmzPMcaIXGW6WRCp9UhSdPD1HG0Dnzok4+SikBR5FTe0+0u0u/1jioK5bCZCjEqIXiiBjSCDQqzKRsGPrCxwdJ4wubBkJcPDriokV2pC4IPLyzy4GhG+8RJVp98gvbKGpKleIWoHlLHaDhiOtxntLvHzq3bXL95g739IRPv2VxdQe67FzMrP6FpfOXnP/nbbw39bz55anm0MvgPl27efs9X7exwRgOmKelawKJLWVhcoN3t0G63aGcZSauF67aR9XXGrQ63rONW5SmdYz9WjMuSqVciQqX12weKoNrkNmlss9SSXlQl81mOs5blfh8x5qgvWGfUuvJpVtQhKiEERqMhV65eQdTwrvPn+dq1AWu3brG7eZNkYZFMYCN4upOcbLmPrCwTnDCf5UxHE6ajIbPJmNlkwizPmcVIaR2SOLyzPGsTFh99hNXJ9PXdsvigDtYu/utP/cFbF9Z/8z3v2//6zz/zL5946MF3tirvjm3fYqEsMUWFlgUSPN4XFHtziHW1kmisM6YIHWs5227zcLdPd6mHDhax62uYe++DpUXmwTMNnmmI5CFSaCQYQ4w1ww4bDfM8x1hDliRHbx4I0gBZeysjdWZ0MaC+ZPe65bdeeYUX0oyYz3ny5BlaJ05QnN1jkKWIWAIwH084uH2b6e4eGiuy7gLt3gKdpUUQQ7CG6Czl/j7s7VO02zyVpZjBCgv59LZUxU/c+49/5NWf+Bvf9qXJ5/v7S1Tn7l+cJu5HRpn99pMaTxwvg2mnCS0gQ0k10lapRVjAqGK1+Rsj8+hptTq1LektkHYWMO02VBXiK+Jhb1rrRfv6NY9DD1jvDzEwj57EpaS9HgvLA3xZMdreJj8Y1Z3zEIgh4GMgD4FZUfDa3pCtsqKfGR5d20BjZEag2+42wIPmU7rzgsHBkBMGHvymb6bVH4CRo2VXn0+58Ht/yB8P9/nTpR6XsuyyVOV/Ozsef/yJYyuffbY/iB/75G/92S8XfeSxr2R7/017Q/W8ta0nnUm+whjzZZkx51qJPd1Ls+5S4ug6S4YhE8GIYpsKIChUweMRkpVVWouLjGYTNm9cJ5/M5j74PY3xllPmC1nLJmmCGFGrotGHCtQDvojRl0EPOquD6bGz9xRFWcSrl6/E/Z0drSuyeOiBYwAtiek71499+Oxs7n93Nv6NYZIVMSDd3qKce9v5LNfQH0+mx/xobyWZTe9bLOOgPZvQW1yi3ethbK3JMQRm4yk7pd8f9XsvjoL/o9Fo/KsXX3/t4ocfezie7rT4sWee/fNfsPy2xx/njYMdEg/fNTjLd1z8QjbIskGWZQ8suvY7+6l7+3qn3V5rdREN/SJUXR9DEkI0qkSDVAYmLetugQw38+l8K5+9Ng7hlXlVXZuV5e7xxcXqrz7yhKytLBOspW0zrYoyqokaIbbTBX3Fiv/Yr/zSURV18Cu/ytO/80l8YpjkOeqVg6piWOZ84fat+96RtT86Phh+/J88ufFHPzVexISE1VMn+K4f/GHk8YcFSHvLC22n5nxVVA9VMZ72lV8S1Zax4qJqocrIGHcja2fPr64MXnzj7/3w+N2//Iu00oynXnjuf+0N1a9/71cjvuL6jRtMZlMwwon2As9cveLW+qv2+GCZ7eFuNszz1AfvvA9CDIoxHrQg6Pwa+I/d/xCfmY/YLkuqEEhEuG9llffd/wi93gLBQstmhKrCiGLE1N7TGHZN5Eq7zeDLH+Lxt50jf/V1fv5nf5b9vV1UFWvr5dXzqWvlwwN531J3/rt2gTfyMdEHQgj80Ed/kE/8208wHO1hUUbDA2aTGbMY/8x5W2Ch1eb0ieOkrYxv/8Ef4Pu/87v/py9Y/g8g44LnwuhXZAAAAB50RVh0aWNjOmNvcHlyaWdodABHb29nbGUgSW5jLiAyMDE2rAszOAAAABR0RVh0aWNjOmRlc2NyaXB0aW9uAHNSR0K6kHMHAAAAAElFTkSuQmCC';
        
        function getCivicIcon(rotation) {
            // Car image points RIGHT (90 degrees)
            // Bearing: 0 = North (up), 90 = East (right), 180 = South, 270 = West
            // To make car point in direction of travel, subtract 90 degrees
            const adjustedRotation = rotation - 90;
            return 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
                    <g transform="rotate(${adjustedRotation}, 40, 40)">
                        <image href="${carImageBase64}" x="0" y="0" width="80" height="80"/>
                    </g>
                </svg>
            `);
        }
        
        let civicImageUrl = getCivicIcon(0);

        function getCarIcon(rotation) {
            return {
                url: civicImageUrl,
                scaledSize: new google.maps.Size(45, 45),
                anchor: new google.maps.Point(22, 22),
                rotation: rotation
            };
        }

        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        // Find closest point on route to snap the car
        function snapToRoute(driverPos) {
            if (!routePath || routePath.length === 0) return driverPos;
            
            let closestPoint = routePath[0];
            let closestDist = getDistance(driverPos, closestPoint);
            let closestIndex = 0;
            
            for (let i = 1; i < routePath.length; i++) {
                const dist = getDistance(driverPos, routePath[i]);
                if (dist < closestDist) {
                    closestDist = dist;
                    closestPoint = routePath[i];
                    closestIndex = i;
                }
            }
            
            // Only snap if within 100 meters of route
            if (closestDist < 100) {
                // Calculate bearing from next point on route
                if (closestIndex < routePath.length - 1) {
                    const nextPoint = routePath[closestIndex + 1];
                    carRotation = calculateBearing(
                        closestPoint.lat(), closestPoint.lng(),
                        nextPoint.lat(), nextPoint.lng()
                    );
                }
                return { lat: closestPoint.lat(), lng: closestPoint.lng() };
            }
            return driverPos;
        }

        function getDistance(pos1, pos2) {
            const lat1 = typeof pos1.lat === 'function' ? pos1.lat() : pos1.lat;
            const lng1 = typeof pos1.lng === 'function' ? pos1.lng() : pos1.lng;
            const lat2 = typeof pos2.lat === 'function' ? pos2.lat() : pos2.lat;
            const lng2 = typeof pos2.lng === 'function' ? pos2.lng() : pos2.lng;
            
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function initMap() {
            const defaultCenter = { lat: 51.1284, lng: -113.9490 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: defaultCenter,
                disableDefaultUI: true,
                zoomControl: true,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#1a1a2e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a2e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#6b6b80" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#353550" }] },
                    { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#8a8a8a" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e0e1a" }] }
                ]
            });

            // Initialize Directions Service
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true, // We'll use our own markers
                polylineOptions: {
                    strokeColor: '#00d26a',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });

            // Update map once data is loaded
            setTimeout(() => {
                if (currentDelivery) updateMapWithLocations();
            }, 1000);
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof google !== 'undefined') {
                initMap();
            }
        });

        function updateMapWithLocations() {
            if (!map || !currentDelivery) return;

            const customerLat = parseFloat(currentDelivery.customer_lat);
            const customerLng = parseFloat(currentDelivery.customer_lng);

            if (customerLat && customerLng) {
                const customerPos = { lat: customerLat, lng: customerLng };
                
                if (!customerMarker) {
                    customerMarker = new google.maps.Marker({
                        position: customerPos,
                        map: map,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="45" height="55" viewBox="0 0 45 55"><defs><linearGradient id="pinGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#00E676;stop-opacity:1" /><stop offset="100%" style="stop-color:#00C853;stop-opacity:1" /></linearGradient><filter id="shadow2" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/></filter></defs><path d="M22.5 0 C10 0 0 10 0 22.5 C0 35 22.5 55 22.5 55 C22.5 55 45 35 45 22.5 C45 10 35 0 22.5 0 Z" fill="url(#pinGrad)" filter="url(#shadow2)"/><circle cx="22.5" cy="20" r="12" fill="white"/><path d="M22.5 12 L14 19 L14 27 L19 27 L19 22 L26 22 L26 27 L31 27 L31 19 Z" fill="#00C853"/><circle cx="22.5" cy="20" r="2" fill="#00C853"/></svg>'),
                            scaledSize: new google.maps.Size(45, 55),
                            anchor: new google.maps.Point(22.5, 55)
                        },
                        title: 'Delivery Location'
                    });
                }
                map.setCenter(customerPos);
            }

            updateDriverMarker();
        }

        // Animation state
        let animationFrameId = null;
        let animationStartPos = null;
        let animationEndPos = null;
        let animationStartTime = null;
        const ANIMATION_DURATION = 500; // 500ms smooth transition (matches 600ms update interval)

        function animateMarker(marker, startPos, endPos, duration) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            animationStartPos = startPos;
            animationEndPos = endPos;
            animationStartTime = performance.now();
            
            function animate(currentTime) {
                const elapsed = currentTime - animationStartTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease in-out cubic for smooth acceleration and deceleration
                const easeProgress = progress < 0.5 
                    ? 4 * progress * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                
                const lat = animationStartPos.lat + (animationEndPos.lat - animationStartPos.lat) * easeProgress;
                const lng = animationStartPos.lng + (animationEndPos.lng - animationStartPos.lng) * easeProgress;
                
                marker.setPosition({ lat, lng });
                
                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                }
            }
            
            animationFrameId = requestAnimationFrame(animate);
        }

        function updateDriverMarker() {
            if (!map || !currentDriver) return;

            const driverLat = parseFloat(currentDriver.current_lat);
            const driverLng = parseFloat(currentDriver.current_lng);

            if (!driverLat || !driverLng) return;

            let driverPos = { lat: driverLat, lng: driverLng };
            
            // Calculate rotation based on direction of travel BEFORE snapping
            if (lastDriverLat !== null && lastDriverLng !== null) {
                const newRotation = calculateBearing(lastDriverLat, lastDriverLng, driverLat, driverLng);
                // Only update rotation if significant change (prevents jittering)
                if (Math.abs(newRotation - carRotation) > 10) {
                    carRotation = newRotation;
                }
            }
            
            // Snap to route if we have one
            if (routePath.length > 0) {
                driverPos = snapToRoute(driverPos);
            }

            // Create icon with current rotation
            const rotatedIcon = {
                url: getCivicIcon(carRotation),
                scaledSize: new google.maps.Size(65, 65),
                anchor: new google.maps.Point(32, 32)
            };

            if (driverMarker) {
                // Smooth animation to new position
                const currentPos = driverMarker.getPosition();
                if (currentPos && (lastDriverLat !== null)) {
                    // Only animate if there's actual movement
                    const distance = getDistance(
                        { lat: currentPos.lat(), lng: currentPos.lng() },
                        driverPos
                    );
                    if (distance > 5) { // More than 5 meters
                        animateMarker(driverMarker, 
                            { lat: currentPos.lat(), lng: currentPos.lng() }, 
                            driverPos, 
                            ANIMATION_DURATION
                        );
                    }
                } else {
                    driverMarker.setPosition(driverPos);
                }
                driverMarker.setIcon(rotatedIcon);
            } else {
                driverMarker = new google.maps.Marker({
                    position: driverPos,
                    map: map,
                    icon: rotatedIcon,
                    title: currentDriver.name,
                    zIndex: 1000
                });
            }
            
            lastDriverLat = driverLat;
            lastDriverLng = driverLng;

            // Update route every 5 seconds when driver is moving
            const now = Date.now();
            if (customerMarker && (now - lastRouteUpdate > 5000)) {
                lastRouteUpdate = now;
                calculateRoute(driverPos, customerMarker.getPosition());
            }

            // Fit bounds if both markers exist (only once, then let user control)
            if (customerMarker && !directionsRenderer.getDirections()) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(driverPos);
                bounds.extend(customerMarker.getPosition());
                map.fitBounds(bounds, { padding: 80 });
            }
        }

        function calculateRoute(origin, destination) {
            if (!directionsService || !directionsRenderer) return;

            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                drivingOptions: {
                    departureTime: new Date(),
                    trafficModel: 'bestguess'
                }
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Store route path for car snapping
                    routePath = result.routes[0].overview_path;
                    
                    // Get route info
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    // Update ETA display
                    const durationMins = Math.ceil(leg.duration.value / 60);
                    document.getElementById('etaTime').textContent = durationMins;
                    
                    // Update distance info if element exists
                    const distanceEl = document.getElementById('distanceText');
                    if (distanceEl) {
                        distanceEl.textContent = leg.distance.text;
                    }
                    
                    // Update header subtitle with live info
                    const subtitle = document.getElementById('headerSubtitle');
                    if (subtitle && currentDelivery.status === 'picked_up') {
                        subtitle.textContent = `${leg.distance.text} away ‚Ä¢ ${durationMins} min`;
                    }
                    
                    // Re-snap driver marker now that we have route
                    if (driverMarker && currentDriver) {
                        updateDriverMarker();
                    }
                }
            });
        }

        // ============================================
        // SHOW/HIDE STATES
        // ============================================
        function showContent() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            mainContent.style.display = 'block';
        }

        function showError() {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            mainContent.style.display = 'none';
        }

        // ============================================
        // DRIVER STORY
        // ============================================
        const driverStories = {
            default: "is a valued member of our community, helping connect local restaurants with neighbors like you. Every delivery supports local families and businesses.",
            // Add custom stories for specific drivers by their ID
        };

        function showDriverStory() {
            if (!currentDriver) return;
            
            const storyCard = document.getElementById('driverStoryCard');
            const storyAvatar = document.getElementById('storyAvatar');
            const storyText = document.getElementById('storyText');
            
            // Set driver photo if available
            if (currentDriver.photo_url) {
                storyAvatar.innerHTML = `<img src="${currentDriver.photo_url}" alt="${currentDriver.name}">`;
            }
            
            // Get custom story or default
            const story = driverStories[currentDriver.id] || driverStories.default;
            storyText.innerHTML = `<strong>${currentDriver.name}</strong> ${story}`;
            
            // Show the card with animation
            storyCard.style.display = 'block';
        }

        // ============================================
        // STAR RATING
        // ============================================
        let selectedRating = 0;
        let selectedTip = 0;

        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                updateStars(selectedRating);
                
                // Show tip section after rating
                if (selectedRating >= 1) {
                    document.getElementById('tipSection').style.display = 'block';
                    document.getElementById('submitFeedbackBtn').disabled = false;
                }
                
                // Update rating label
                const labels = ['', 'Poor', 'Fair', 'Good', 'Great', 'Excellent!'];
                document.getElementById('ratingLabel').textContent = labels[selectedRating];
            });
            
            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.dataset.rating);
                updateStars(rating);
            });
            
            star.addEventListener('mouseleave', function() {
                updateStars(selectedRating);
            });
        });

        function updateStars(rating) {
            document.querySelectorAll('.star').forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                star.classList.toggle('active', starRating <= rating);
            });
        }

        // ============================================
        // TIP SELECTION
        // ============================================
        document.querySelectorAll('.tip-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove selected from all
                document.querySelectorAll('.tip-btn').forEach(b => b.classList.remove('selected'));
                
                if (this.id === 'customTipBtn') {
                    document.getElementById('customTipInput').style.display = 'flex';
                    this.classList.add('selected');
                    selectedTip = 0;
                } else {
                    document.getElementById('customTipInput').style.display = 'none';
                    this.classList.add('selected');
                    selectedTip = parseInt(this.dataset.amount);
                }
            });
        });

        document.getElementById('customTipAmount')?.addEventListener('input', function() {
            selectedTip = parseInt(this.value) || 0;
        });

        // ============================================
        // SUBMIT FEEDBACK
        // ============================================
        document.getElementById('submitFeedbackBtn')?.addEventListener('click', async function() {
            if (selectedRating === 0) return;
            
            this.disabled = true;
            this.textContent = 'Submitting...';
            
            try {
                // Save feedback to Supabase
                const { error } = await supabaseClient
                    .from('deliveries')
                    .update({
                        customer_rating: selectedRating,
                        customer_feedback: document.getElementById('feedbackComment').value,
                        tip_amount: selectedTip
                    })
                    .eq('id', currentDelivery.id);
                
                if (error) throw error;
                
                // Update driver's tip total if tip was given
                if (selectedTip > 0 && currentDriver) {
                    // You could update driver earnings here
                    console.log(`Tip of $${selectedTip} for driver ${currentDriver.name}`);
                }
                
                // Show thank you message
                document.querySelector('.feedback-card').style.display = 'none';
                document.getElementById('thankYouCard').style.display = 'block';
                
            } catch (err) {
                console.error('Error submitting feedback:', err);
                this.disabled = false;
                this.textContent = 'Submit Feedback';
                alert('Failed to submit feedback. Please try again.');
            }
        });

        // Order again button - opens WhatsApp
        document.getElementById('orderAgainBtn')?.addEventListener('click', function() {
            // Replace with your WhatsApp business number
            window.open('https://wa.me/14038265529?text=Hi! I would like to place an order.', '_blank');
        });

        // ============================================
        // HELP BUTTON & FAQ
        // ============================================
        const helpFab = document.getElementById('helpFab');
        const helpModal = document.getElementById('helpModal');
        const closeModal = document.getElementById('closeModal');
        const showFaq = document.getElementById('showFaq');
        const faqBack = document.getElementById('faqBack');
        const helpOptions = document.getElementById('helpOptions');
        const faqSection = document.getElementById('faqSection');

        // Open help modal
        helpFab?.addEventListener('click', () => {
            helpModal.classList.add('active');
            helpOptions.style.display = 'flex';
            faqSection.classList.remove('active');
        });

        // Close help modal
        closeModal?.addEventListener('click', () => {
            helpModal.classList.remove('active');
        });

        // Close on overlay click
        helpModal?.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.remove('active');
            }
        });

        // Show FAQ section
        showFaq?.addEventListener('click', () => {
            helpOptions.style.display = 'none';
            faqSection.classList.add('active');
        });

        // Back to help options
        faqBack?.addEventListener('click', () => {
            faqSection.classList.remove('active');
            helpOptions.style.display = 'flex';
        });

        // FAQ accordion
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', function() {
                const item = this.parentElement;
                const isOpen = item.classList.contains('open');
                
                // Close all others
                document.querySelectorAll('.faq-item').forEach(i => i.classList.remove('open'));
                
                // Toggle current
                if (!isOpen) {
                    item.classList.add('open');
                }
            });
        });

        // ============================================
        // CENTER ON DRIVER BUTTON
        // ============================================
        document.getElementById('centerOnDriver')?.addEventListener('click', function() {
            if (driverMarker && map) {
                const pos = driverMarker.getPosition();
                if (pos) {
                    map.setCenter(pos);
                    map.setZoom(17);
                }
            } else if (customerMarker && map) {
                const pos = customerMarker.getPosition();
                if (pos) {
                    map.setCenter(pos);
                    map.setZoom(16);
                }
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================
        loadDelivery();
    </script>
</body>
</html>
