<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Owner Dashboard - YYC LocalFirst</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12131a;
            --bg-card-hover: #1a1b24;
            --bg-input: #1a1b24;
            --border: #2a2b35;
            --text-primary: #ffffff;
            --text-secondary: #8b8d9a;
            --text-muted: #5a5c6a;
            --accent-green: #00d26a;
            --accent-green-dim: rgba(0, 210, 106, 0.15);
            --accent-orange: #ff9f43;
            --accent-orange-dim: rgba(255, 159, 67, 0.15);
            --accent-red: #ff6b6b;
            --accent-red-dim: rgba(255, 107, 107, 0.15);
            --accent-blue: #4da6ff;
            --accent-blue-dim: rgba(77, 166, 255, 0.15);
            --accent-purple: #a78bfa;
            --accent-purple-dim: rgba(167, 139, 250, 0.15);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { font-size: 1.5rem; }
        .logo-text { font-size: 1.25rem; font-weight: 700; color: var(--accent-green); }
        .logo-badge { background: var(--accent-orange-dim); color: var(--accent-orange); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .date-filters { display: flex; gap: 0.35rem; background: var(--bg-dark); padding: 0.35rem; border-radius: 10px; border: 1px solid var(--border); flex-wrap: wrap; }
        .date-btn { padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 500; cursor: pointer; background: transparent; border: none; color: var(--text-secondary); transition: all 0.2s; }
        .date-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .date-btn.active { background: var(--accent-green); color: #000; }
        .user-menu { display: flex; align-items: center; gap: 0.75rem; padding-left: 1rem; border-left: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-orange), #ff7b00); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; color: #000; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { font-size: 0.8rem; font-weight: 600; }
        .user-role { font-size: 0.65rem; color: var(--text-secondary); }
        .logout-btn { padding: 0.5rem 0.75rem; background: var(--accent-red-dim); border: 1px solid var(--accent-red); border-radius: 8px; color: var(--accent-red); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .logout-btn:hover { background: var(--accent-red); color: white; }
        .profile-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 0.5rem; min-width: 200px; z-index: 1000; }
        .profile-dropdown.visible { display: block; }
        .profile-dropdown-item { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); }
        .profile-dropdown-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .main { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg-card); padding: 0.5rem; border-radius: 12px; border: 1px solid var(--border); flex-wrap: wrap; }
        .tab { padding: 0.75rem 1.25rem; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .tab.active { background: var(--accent-green); color: #000; }
        .tab-count { background: rgba(0,0,0,0.2); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
        .stat-card.highlight { border-color: var(--accent-green); background: linear-gradient(135deg, var(--bg-card), var(--accent-green-dim)); }
        .stat-card.warning { border-color: var(--accent-orange); background: linear-gradient(135deg, var(--bg-card), var(--accent-orange-dim)); }
        .stat-card.purple { border-color: var(--accent-purple); background: linear-gradient(135deg, var(--bg-card), var(--accent-purple-dim)); }
        .stat-label { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.75rem; font-weight: 700; }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
        .section-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem; }
        .section-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .section-title { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .btn { padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s; }
        .btn-primary { background: var(--accent-green); color: #000; }
        .btn-primary:hover { background: #00b85c; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .btn-danger { background: var(--accent-red-dim); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .btn-danger:hover { background: var(--accent-red); color: white; }
        .btn-purple { background: var(--accent-purple); color: #000; }
        .btn-purple:hover { background: #9171f8; }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
        .orders-list { max-height: 400px; overflow-y: auto; }
        .order-item { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: background 0.2s; }
        .order-item:hover { background: var(--bg-card-hover); }
        .order-status { width: 10px; height: 10px; border-radius: 50%; }
        .order-status.pending { background: var(--accent-orange); }
        .order-status.confirmed, .order-status.preparing { background: var(--accent-blue); }
        .order-status.ready { background: var(--accent-green); }
        .order-status.completed { background: var(--text-muted); }
        .order-info { flex: 1; }
        .order-number { font-weight: 600; margin-bottom: 0.25rem; }
        .order-customer { font-size: 0.85rem; color: var(--text-secondary); }
        .order-meta { text-align: right; }
        .order-total { font-weight: 700; color: var(--accent-green); }
        .order-time { font-size: 0.75rem; color: var(--text-muted); }
        .order-type { font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-top: 0.35rem; display: inline-block; }
        .order-type.delivery { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .order-type.pickup { background: var(--accent-orange-dim); color: var(--accent-orange); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem; }
        .menu-item-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
        .menu-item-card:hover { border-color: var(--accent-green); }
        .menu-item-card.unavailable { opacity: 0.6; }
        .menu-item-image { width: 100%; height: 140px; background: var(--bg-card-hover); display: flex; align-items: center; justify-content: center; font-size: 3rem; position: relative; }
        .menu-item-image img { width: 100%; height: 100%; object-fit: cover; }
        .unavailable-badge { position: absolute; top: 0.5rem; right: 0.5rem; background: var(--accent-red); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
        .menu-item-content { padding: 1rem; }
        .menu-item-name { font-weight: 600; margin-bottom: 0.25rem; }
        .menu-item-category { font-size: 0.75rem; color: var(--accent-orange); margin-bottom: 0.5rem; }
        .menu-item-description { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .menu-item-footer { display: flex; justify-content: space-between; align-items: center; }
        .menu-item-price { font-size: 1.1rem; font-weight: 700; color: var(--accent-green); }
        .menu-item-actions { display: flex; gap: 0.35rem; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.visible { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal.wide { max-width: 600px; }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.25rem; }
        .modal-footer { padding: 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-green); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        .form-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .form-checkbox input { width: 18px; height: 18px; accent-color: var(--accent-green); }
        .empty-state { padding: 3rem; text-align: center; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .order-status-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .status-btn { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; }
        .status-btn:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .status-btn.active { background: var(--accent-green); border-color: var(--accent-green); color: #000; }
        .alert { padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .alert.visible { display: block; }
        .alert.success { background: var(--accent-green-dim); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .alert.error { background: var(--accent-red-dim); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1rem; padding: 0 1rem; }
        .search-input { flex: 1; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; }
        
        /* Analytics Styles */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .item-rank { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        .item-rank:last-child { border-bottom: none; }
        .rank-number { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
        .rank-number.gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; }
        .rank-number.silver { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #000; }
        .rank-number.bronze { background: linear-gradient(135deg, #cd7f32, #b87333); color: #000; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; font-size: 0.9rem; }
        .rank-category { font-size: 0.75rem; color: var(--text-muted); }
        .rank-stats { text-align: right; }
        .rank-sold { font-weight: 700; color: var(--accent-green); }
        .rank-revenue { font-size: 0.75rem; color: var(--text-secondary); }
        .not-selling { color: var(--accent-red); }
        
        /* Promotions Styles */
        .promo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; padding: 1rem; }
        .promo-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; position: relative; }
        .promo-card.active { border-color: var(--accent-green); }
        .promo-card.inactive { opacity: 0.6; }
        .promo-badge { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
        .promo-badge.active { background: var(--accent-green-dim); color: var(--accent-green); }
        .promo-badge.scheduled { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .promo-badge.expired { background: var(--accent-red-dim); color: var(--accent-red); }
        .promo-type { font-size: 0.7rem; color: var(--accent-purple); text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem; }
        .promo-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; }
        .promo-desc { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .promo-details { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem; }
        .promo-details span { display: block; margin-bottom: 0.25rem; }
        .promo-actions { display: flex; gap: 0.5rem; }
        
        @media (max-width: 1200px) { .date-filters { order: 3; width: 100%; justify-content: center; } .analytics-grid { grid-template-columns: 1fr; } }
        @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .tabs { flex-wrap: wrap; } .menu-grid { grid-template-columns: 1fr; } .promo-grid { grid-template-columns: 1fr; } .form-row, .form-row-3 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üè™</span>
                <span class="logo-text">YYC LocalFirst</span>
                <span class="logo-badge">STORE</span>
            </div>
            <div class="header-right">
                <div class="date-filters">
                    <button class="date-btn active" data-range="today">Today</button>
                    <button class="date-btn" data-range="yesterday">Yesterday</button>
                    <button class="date-btn" data-range="week">7 Days</button>
                    <button class="date-btn" data-range="biweek">14 Days</button>
                    <button class="date-btn" data-range="month">30 Days</button>
                    <button class="date-btn" data-range="quarter">90 Days</button>
                    <button class="date-btn" data-range="half">6 Months</button>
                    <button class="date-btn" data-range="year">1 Year</button>
                    <button class="date-btn" data-range="all">All</button>
                </div>
                <div class="user-menu">
                    <div class="user-info" onclick="toggleProfileDropdown()">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <div>
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role">Store Owner</div>
                        </div>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-item" onclick="openProfileModal(event)">üì∑ Change Picture</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">üö™ Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="tabs">
            <button class="tab active" data-tab="orders" onclick="switchTab('orders')">üìã Orders <span class="tab-count" id="ordersCount">0</span></button>
            <button class="tab" data-tab="menu" onclick="switchTab('menu')">üçΩÔ∏è Menu <span class="tab-count" id="menuCount">0</span></button>
            <button class="tab" data-tab="promotions" onclick="switchTab('promotions')">üéÅ Promotions <span class="tab-count" id="promoCount">0</span></button>
            <button class="tab" data-tab="analytics" onclick="switchTab('analytics')">üìä Analytics</button>
        </div>

        <!-- Orders Tab -->
        <div id="ordersTab">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Orders <span id="dateRangeLabel">(Today)</span></div>
                    <div class="stat-value" id="statOrders">0</div>
                    <div class="stat-sub" id="statPendingSub">0 pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Sales</div>
                    <div class="stat-value blue" id="statTotalSales">$0</div>
                    <div class="stat-sub">Before platform fee</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">üí∞ Your Revenue</div>
                    <div class="stat-value green" id="statYourRevenue">$0</div>
                    <div class="stat-sub">Your earnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Order</div>
                    <div class="stat-value" id="statAvgOrder">$0</div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">üìã Orders</div>
                    <button class="btn btn-secondary btn-sm" onclick="loadOrders()">üîÑ Refresh</button>
                </div>
                <div class="orders-list" id="ordersList"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No orders yet</div></div></div>
            </div>
        </div>

        <!-- Menu Tab -->
        <div id="menuTab" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">üçΩÔ∏è Menu Items</div>
                    <button class="btn btn-primary" onclick="openAddItemModal()">‚ûï Add Item</button>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" id="menuSearch" placeholder="Search menu items..." oninput="filterMenuItems()">
                    <select class="form-select" style="width: auto;" id="categoryFilter" onchange="filterMenuItems()"><option value="">All Categories</option></select>
                </div>
                <div class="menu-grid" id="menuGrid"><div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div>No menu items yet</div></div></div>
            </div>
        </div>

        <!-- Promotions Tab -->
        <div id="promotionsTab" style="display: none;">
            <div class="stats-row">
                <div class="stat-card purple">
                    <div class="stat-label">Active Promotions</div>
                    <div class="stat-value purple" id="activePromos">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Scheduled</div>
                    <div class="stat-value blue" id="scheduledPromos">0</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">Promo Revenue</div>
                    <div class="stat-value green" id="promoRevenue">$0</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Promo Orders</div>
                    <div class="stat-value orange" id="promoOrders">0</div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">üéÅ Promotions & Specials</div>
                    <button class="btn btn-purple" onclick="openPromoModal()">‚ûï Create Promotion</button>
                </div>
                <div class="promo-grid" id="promoGrid">
                    <div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üéÅ</div><div>No promotions yet</div><p style="margin-top:0.5rem; font-size:0.85rem;">Create combos, happy hours, and special deals!</p></div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analyticsTab" style="display: none;">
            <div class="stats-row">
                <div class="stat-card highlight">
                    <div class="stat-label">Period Revenue</div>
                    <div class="stat-value green" id="statPeriodRevenue">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Items Sold</div>
                    <div class="stat-value blue" id="statItemsSold">0</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-label">Not Selling</div>
                    <div class="stat-value orange" id="statNotSelling">0</div>
                    <div class="stat-sub">Items with 0 orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Item Price</div>
                    <div class="stat-value" id="statAvgPrice">$0</div>
                </div>
            </div>
            <div class="analytics-grid">
                <div class="section-card">
                    <div class="section-header"><div class="section-title">üèÜ Top Sellers</div></div>
                    <div id="topSellers"><div class="empty-state"><div class="empty-state-icon">üìä</div><div>No sales data yet</div></div></div>
                </div>
                <div class="section-card">
                    <div class="section-header"><div class="section-title">‚ö†Ô∏è Not Selling</div></div>
                    <div id="notSelling"><div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>All items are selling!</div></div></div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header"><div class="section-title">üìà Category Performance</div></div>
                <div id="categoryPerformance" style="padding: 1rem;"></div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Item Modal -->
    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="itemModalTitle">Add Menu Item</div><button class="modal-close" onclick="closeItemModal()">&times;</button></div>
            <div class="modal-body">
                <div class="alert" id="itemAlert"></div>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    <div class="form-group"><label class="form-label">Item Name *</label><input type="text" class="form-input" id="itemName" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="itemDescription"></textarea></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Price *</label><input type="number" class="form-input" id="itemPrice" step="0.01" min="0" required></div>
                        <div class="form-group"><label class="form-label">Category *</label><select class="form-select" id="itemCategory" required><option value="">Select</option><option>Appetizers</option><option>Main Course</option><option>Pizza</option><option>Burgers</option><option>Sandwiches</option><option>Salads</option><option>Sides</option><option>Desserts</option><option>Beverages</option><option>Specials</option></select></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image</label>
                        <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer;" onclick="document.getElementById('itemImageFile').click()">
                            <input type="file" id="itemImageFile" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">
                            <div style="color: var(--text-secondary);">üìÅ Click to upload</div>
                        </div>
                        <div id="imagePreview" style="display: none; margin-top: 0.5rem;"></div>
                        <div style="text-align: center; color: var(--text-muted); font-size: 0.75rem; margin: 0.5rem 0;">‚Äî OR paste URL ‚Äî</div>
                        <input type="url" class="form-input" id="itemImage" placeholder="https://...">
                    </div>
                    <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="itemAvailable" checked> Item is available</label></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button><button class="btn btn-primary" onclick="saveItem(event)">üíæ Save</button></div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div class="modal-overlay" id="promoModal">
        <div class="modal wide">
            <div class="modal-header"><div class="modal-title" id="promoModalTitle">Create Promotion</div><button class="modal-close" onclick="closePromoModal()">&times;</button></div>
            <div class="modal-body">
                <div class="alert" id="promoAlert"></div>
                <form id="promoForm">
                    <input type="hidden" id="promoId">
                    <div class="form-group">
                        <label class="form-label">Promotion Type *</label>
                        <select class="form-select" id="promoType" onchange="updatePromoForm()" required>
                            <option value="">Select type...</option>
                            <option value="combo">üçî Combo Deal (Bundle items)</option>
                            <option value="bogo">üéÅ BOGO (Buy One Get One)</option>
                            <option value="discount">üí∞ Discount (% or $ off)</option>
                            <option value="freeitem">üÜì Free Item (with purchase)</option>
                            <option value="happyhour">üïê Happy Hour (time-based)</option>
                            <option value="slowtime">‚è∞ Slow Time Special</option>
                            <option value="firstorder">üÜï First Order Discount</option>
                            <option value="loyalty">‚≠ê Loyalty Reward</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Promotion Name *</label><input type="text" class="form-input" id="promoName" placeholder="e.g., Lunch Combo Special" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="promoDescription" placeholder="Describe your promotion..."></textarea></div>
                    
                    <div id="promoDetails">
                        <!-- Dynamic fields based on promo type -->
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Start Date</label><input type="date" class="form-input" id="promoStartDate"></div>
                        <div class="form-group"><label class="form-label">End Date</label><input type="date" class="form-input" id="promoEndDate"></div>
                    </div>
                    
                    <div class="form-row" id="timeRestriction" style="display:none;">
                        <div class="form-group"><label class="form-label">Start Time</label><input type="time" class="form-input" id="promoStartTime"></div>
                        <div class="form-group"><label class="form-label">End Time</label><input type="time" class="form-input" id="promoEndTime"></div>
                    </div>
                    
                    <div class="form-group" id="dayRestriction" style="display:none;">
                        <label class="form-label">Available Days</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="0"> Sun</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="1" checked> Mon</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="2" checked> Tue</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="3" checked> Wed</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="4" checked> Thu</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="5" checked> Fri</label>
                            <label class="form-checkbox"><input type="checkbox" name="promoDays" value="6"> Sat</label>
                        </div>
                    </div>
                    
                    <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="promoActive" checked> Promotion is active</label></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closePromoModal()">Cancel</button><button class="btn btn-purple" onclick="savePromo(event)">üíæ Save Promotion</button></div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal"><div class="modal-header"><div class="modal-title" id="orderModalTitle">Order</div><button class="modal-close" onclick="closeOrderModal()">&times;</button></div><div class="modal-body" id="orderModalBody"></div></div>
    </div>

    <!-- Delete Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><div class="modal-title">‚ö†Ô∏è Confirm Delete</div><button class="modal-close" onclick="closeDeleteModal()">&times;</button></div>
            <div class="modal-body"><p>Delete "<span id="deleteItemName"></span>"?</p></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button><button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><div class="modal-title">üì∑ Change Picture</div><button class="modal-close" onclick="closeProfileModal()">&times;</button></div>
            <div class="modal-body">
                <div class="alert" id="profileAlert"></div>
                <div style="text-align: center; margin-bottom: 1rem;"><div id="currentAvatarPreview" style="width: 100px; height: 100px; border-radius: 50%; background: var(--accent-orange); display: inline-flex; align-items: center; justify-content: center; font-size: 2.5rem; overflow: hidden;">üë§</div></div>
                <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer;" onclick="document.getElementById('profileImageFile').click()">
                    <input type="file" id="profileImageFile" accept="image/*" style="display: none;" onchange="handleProfileImageSelect(this)">
                    <div style="color: var(--text-secondary);">üìÅ Click to upload</div>
                </div>
                <div id="profileImagePreview" style="display: none; margin-top: 1rem; text-align: center;"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfilePicture()">üíæ Save</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const STORE_REVENUE_PERCENT = 85;

        let currentUser = null, restaurantId = null, orders = [], allOrders = [], menuItems = [], promotions = [];
        let currentTab = 'orders', currentDateRange = 'today', deleteItemId = null, deleteType = 'item', profileImageFile = null;

        // Simulated order items for analytics (in production, this comes from order_items table)
        let orderItems = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadRestaurant();
            await loadAllOrders();
            await loadMenuItems();
            await loadPromotions();
            setupDateFilters();
            setupRealtime();
            document.addEventListener('click', (e) => { if (!e.target.closest('.user-info')) document.getElementById('profileDropdown').classList.remove('visible'); });
        });

        async function loadUserInfo() {
            const userJson = localStorage.getItem('user');
            if (userJson) {
                currentUser = JSON.parse(userJson);
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                if (currentUser.id) {
                    const { data } = await db.from('app_users').select('avatar_url').eq('id', currentUser.id).single();
                    if (data && data.avatar_url) {
                        currentUser.profilePicture = data.avatar_url;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                    }
                }
                if (currentUser.profilePicture) document.getElementById('userAvatar').innerHTML = '<img src="' + currentUser.profilePicture + '">';
                else document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }
        }

        async function loadRestaurant() {
            if (currentUser && currentUser.restaurantId) restaurantId = currentUser.restaurantId;
            else { const { data } = await db.from('restaurants').select('id').limit(1).single(); if (data) restaurantId = data.id; }
        }

        function handleLogout() { if (confirm('Logout?')) { localStorage.removeItem('user'); localStorage.removeItem('sessionToken'); window.location.href = 'login.html'; } }
        function toggleProfileDropdown() { document.getElementById('profileDropdown').classList.toggle('visible'); }
        
        function openProfileModal(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.remove('visible');
            document.getElementById('profileAlert').className = 'alert';
            document.getElementById('profileImagePreview').style.display = 'none';
            profileImageFile = null;
            document.getElementById('currentAvatarPreview').innerHTML = document.getElementById('userAvatar').innerHTML;
            document.getElementById('profileModal').classList.add('visible');
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('visible'); }
        
        function handleProfileImageSelect(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { document.getElementById('profileAlert').className = 'alert error visible'; document.getElementById('profileAlert').textContent = 'Max 2MB'; return; }
                profileImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('profileImagePreview').innerHTML = '<img src="' + e.target.result + '" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">'; document.getElementById('profileImagePreview').style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }
        
        async function saveProfilePicture() {
            if (!profileImageFile) return;
            document.getElementById('profileAlert').className = 'alert success visible';
            document.getElementById('profileAlert').textContent = 'Uploading...';
            try {
                const fileName = 'profile-' + Date.now() + '.' + profileImageFile.name.split('.').pop();
                const { error } = await db.storage.from('images').upload('profiles/' + fileName, profileImageFile, { upsert: true });
                if (error) throw error;
                const { data: urlData } = db.storage.from('images').getPublicUrl('profiles/' + fileName);
                currentUser.profilePicture = urlData.publicUrl;
                localStorage.setItem('user', JSON.stringify(currentUser));
                if (currentUser.id) await db.from('app_users').update({ avatar_url: urlData.publicUrl }).eq('id', currentUser.id);
                document.getElementById('userAvatar').innerHTML = '<img src="' + urlData.publicUrl + '">';
                document.getElementById('profileAlert').textContent = 'Saved!';
                setTimeout(closeProfileModal, 1000);
            } catch (err) { document.getElementById('profileAlert').className = 'alert error visible'; document.getElementById('profileAlert').textContent = 'Failed'; }
        }

        function setupDateFilters() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDateRange = btn.dataset.range;
                    filterOrdersByDate();
                });
            });
        }

        function getDateRange() {
            const now = new Date();
            let start = new Date();
            switch(currentDateRange) {
                case 'today': start.setHours(0,0,0,0); break;
                case 'yesterday': start.setDate(start.getDate()-1); start.setHours(0,0,0,0); const endY = new Date(start); endY.setHours(23,59,59,999); return {start, end: endY};
                case 'week': start.setDate(start.getDate()-7); start.setHours(0,0,0,0); break;
                case 'biweek': start.setDate(start.getDate()-14); start.setHours(0,0,0,0); break;
                case 'month': start.setDate(start.getDate()-30); start.setHours(0,0,0,0); break;
                case 'quarter': start.setDate(start.getDate()-90); start.setHours(0,0,0,0); break;
                case 'half': start.setMonth(start.getMonth()-6); start.setHours(0,0,0,0); break;
                case 'year': start.setFullYear(start.getFullYear()-1); start.setHours(0,0,0,0); break;
                case 'all': start = new Date('2020-01-01'); break;
            }
            return { start, end: now };
        }

        function filterOrdersByDate() {
            const { start, end } = getDateRange();
            orders = allOrders.filter(o => { const d = new Date(o.created_at); return d >= start && d <= end; });
            renderOrders();
            updateOrderStats();
            updateAnalytics();
            const labels = { today: 'Today', yesterday: 'Yesterday', week: '7 Days', biweek: '14 Days', month: '30 Days', quarter: '90 Days', half: '6 Months', year: '1 Year', all: 'All Time' };
            document.getElementById('dateRangeLabel').textContent = '(' + labels[currentDateRange] + ')';
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="' + tab + '"]').classList.add('active');
            document.getElementById('ordersTab').style.display = tab === 'orders' ? 'block' : 'none';
            document.getElementById('menuTab').style.display = tab === 'menu' ? 'block' : 'none';
            document.getElementById('promotionsTab').style.display = tab === 'promotions' ? 'block' : 'none';
            document.getElementById('analyticsTab').style.display = tab === 'analytics' ? 'block' : 'none';
            if (tab === 'analytics') updateAnalytics();
        }

        // ========== ORDERS ==========
        async function loadAllOrders() {
            let query = db.from('orders').select('*').order('created_at', { ascending: false });
            if (restaurantId) query = query.eq('restaurant_id', restaurantId);
            const { data } = await query;
            allOrders = data || [];
            // Generate simulated order items for analytics demo
            generateOrderItems();
            filterOrdersByDate();
        }
        
        function generateOrderItems() {
            // Simulate order items based on orders and menu items
            orderItems = [];
            allOrders.forEach(order => {
                const numItems = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < numItems; i++) {
                    if (menuItems.length > 0) {
                        const randomItem = menuItems[Math.floor(Math.random() * menuItems.length)];
                        orderItems.push({
                            order_id: order.id,
                            menu_item_id: randomItem.id,
                            item_name: randomItem.name,
                            category: randomItem.category,
                            quantity: Math.floor(Math.random() * 2) + 1,
                            price: randomItem.base_price,
                            created_at: order.created_at
                        });
                    }
                }
            });
        }
        
        async function loadOrders() { await loadAllOrders(); }

        function renderOrders() {
            const container = document.getElementById('ordersList');
            document.getElementById('ordersCount').textContent = orders.length;
            if (orders.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No orders for this period</div></div>'; return; }
            container.innerHTML = orders.map(o => '<div class="order-item" onclick="openOrderModal(\'' + o.id + '\')"><div class="order-status ' + o.status + '"></div><div class="order-info"><div class="order-number">#' + (o.order_number || o.id.slice(0,6)) + '</div><div class="order-customer">' + (o.customer_name || 'Customer') + '</div></div><div class="order-meta"><div class="order-total">$' + (o.total || 0).toFixed(2) + '</div><div class="order-time">' + formatTime(o.created_at) + '</div><div class="order-type ' + (o.order_type || 'delivery') + '">' + (o.order_type === 'pickup' ? 'üèÉ Pickup' : 'üöó Delivery') + '</div></div></div>').join('');
        }

        function updateOrderStats() {
            const totalSales = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            const yourRevenue = totalSales * (STORE_REVENUE_PERCENT / 100);
            const pending = orders.filter(o => o.status === 'pending' || o.status === 'preparing').length;
            const avgOrder = orders.length > 0 ? totalSales / orders.length : 0;
            document.getElementById('statOrders').textContent = orders.length;
            document.getElementById('statTotalSales').textContent = '$' + totalSales.toFixed(2);
            document.getElementById('statYourRevenue').textContent = '$' + yourRevenue.toFixed(2);
            document.getElementById('statAvgOrder').textContent = '$' + avgOrder.toFixed(2);
            document.getElementById('statPendingSub').textContent = pending + ' pending';
        }

        function openOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId) || allOrders.find(o => o.id === orderId);
            if (!order) return;
            const total = order.total || 0;
            const yours = total * (STORE_REVENUE_PERCENT / 100);
            document.getElementById('orderModalTitle').textContent = 'Order #' + (order.order_number || order.id.slice(0,6));
            document.getElementById('orderModalBody').innerHTML = '<div style="margin-bottom:1rem;"><strong>Customer:</strong> ' + (order.customer_name || 'N/A') + '<br><strong>Phone:</strong> ' + (order.customer_phone || 'N/A') + '<br><strong>Address:</strong> ' + (order.customer_address || 'N/A') + '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;"><div style="background:var(--accent-blue-dim);padding:1rem;border-radius:8px;text-align:center;"><div style="font-size:0.8rem;color:var(--text-secondary);">Order Total</div><div style="font-size:1.25rem;font-weight:700;color:var(--accent-blue);">$' + total.toFixed(2) + '</div></div><div style="background:var(--accent-green-dim);padding:1rem;border-radius:8px;text-align:center;"><div style="font-size:0.8rem;color:var(--text-secondary);">Your Revenue</div><div style="font-size:1.25rem;font-weight:700;color:var(--accent-green);">$' + yours.toFixed(2) + '</div></div></div><div><strong>Status:</strong><div class="order-status-buttons"><button class="status-btn ' + (order.status === 'pending' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'pending\')">üì• Pending</button><button class="status-btn ' + (order.status === 'confirmed' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'confirmed\')">‚úÖ Confirmed</button><button class="status-btn ' + (order.status === 'preparing' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'preparing\')">üë®‚Äçüç≥ Preparing</button><button class="status-btn ' + (order.status === 'ready' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'ready\')">üîî Ready</button><button class="status-btn ' + (order.status === 'completed' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'completed\')">‚úîÔ∏è Done</button></div></div>';
            document.getElementById('orderModal').classList.add('visible');
        }
        function closeOrderModal() { document.getElementById('orderModal').classList.remove('visible'); }

        async function updateOrderStatus(orderId, status) {
            await db.from('orders').update({ status }).eq('id', orderId);
            const order = allOrders.find(o => o.id === orderId);
            if (order) order.status = status;
            filterOrdersByDate();
            openOrderModal(orderId);
        }

        // ========== MENU ITEMS ==========
        async function loadMenuItems() {
            let query = db.from('menu_items').select('*').order('category', { ascending: true });
            if (restaurantId) query = query.eq('restaurant_id', restaurantId);
            const { data } = await query;
            menuItems = data || [];
            renderMenuItems();
            updateCategoryFilter();
            generateOrderItems(); // Regenerate after menu loads
        }

        function renderMenuItems() {
            const container = document.getElementById('menuGrid');
            document.getElementById('menuCount').textContent = menuItems.length;
            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const filtered = menuItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) || (item.description || '').toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üçΩÔ∏è</div><div>' + (menuItems.length === 0 ? 'No menu items yet' : 'No items match') + '</div></div>'; return; }
            container.innerHTML = filtered.map(item => '<div class="menu-item-card ' + (item.is_available === false ? 'unavailable' : '') + '"><div class="menu-item-image">' + (item.image_url ? '<img src="' + item.image_url + '" onerror="this.parentElement.innerHTML=\'üçΩÔ∏è\'">' : 'üçΩÔ∏è') + (item.is_available === false ? '<span class="unavailable-badge">Unavailable</span>' : '') + '</div><div class="menu-item-content"><div class="menu-item-name">' + item.name + '</div><div class="menu-item-category">' + (item.category || '') + '</div><div class="menu-item-description">' + (item.description || '') + '</div><div class="menu-item-footer"><div class="menu-item-price">$' + (item.base_price || 0).toFixed(2) + '</div><div class="menu-item-actions"><button class="btn btn-secondary btn-sm" onclick="editItem(\'' + item.id + '\')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="openDeleteModal(\'' + item.id + '\',\'' + item.name.replace(/'/g, "\\'") + '\', \'item\')">üóëÔ∏è</button></div></div></div></div>').join('');
        }

        function filterMenuItems() { renderMenuItems(); }
        function updateCategoryFilter() {
            const categories = [...new Set(menuItems.map(item => item.category).filter(Boolean))];
            document.getElementById('categoryFilter').innerHTML = '<option value="">All</option>' + categories.map(cat => '<option>' + cat + '</option>').join('');
        }

        function openAddItemModal() {
            document.getElementById('itemModalTitle').textContent = 'Add Menu Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemAvailable').checked = true;
            document.getElementById('itemAlert').className = 'alert';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('itemImageFile').value = '';
            document.getElementById('itemModal').classList.add('visible');
        }

        function editItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            document.getElementById('itemModalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemPrice').value = item.base_price || '';
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemImage').value = item.image_url || '';
            document.getElementById('itemAvailable').checked = item.is_available !== false;
            document.getElementById('itemAlert').className = 'alert';
            document.getElementById('itemImageFile').value = '';
            const preview = document.getElementById('imagePreview');
            if (item.image_url) { preview.innerHTML = '<img src="' + item.image_url + '" style="max-width:100%;max-height:150px;border-radius:8px;">'; preview.style.display = 'block'; }
            else { preview.style.display = 'none'; }
            document.getElementById('itemModal').classList.add('visible');
        }

        function closeItemModal() { document.getElementById('itemModal').classList.remove('visible'); }

        async function saveItem(e) {
            if (e) e.preventDefault();
            const itemId = document.getElementById('itemId').value;
            let imageUrl = document.getElementById('itemImage').value.trim() || null;
            const imageFile = document.getElementById('itemImageFile').files[0];
            if (imageFile) {
                showItemAlert('success', 'Uploading...');
                const uploadedUrl = await uploadImage(imageFile);
                if (uploadedUrl) imageUrl = uploadedUrl;
                else { showItemAlert('error', 'Upload failed'); return; }
            }
            const itemData = { name: document.getElementById('itemName').value.trim(), description: document.getElementById('itemDescription').value.trim(), base_price: parseFloat(document.getElementById('itemPrice').value) || 0, category: document.getElementById('itemCategory').value, image_url: imageUrl, is_available: document.getElementById('itemAvailable').checked, restaurant_id: restaurantId };
            if (!itemData.name || !itemData.base_price || !itemData.category) { showItemAlert('error', 'Fill required fields'); return; }
            let error;
            if (itemId) { const result = await db.from('menu_items').update(itemData).eq('id', itemId); error = result.error; }
            else { const result = await db.from('menu_items').insert([itemData]); error = result.error; }
            if (error) showItemAlert('error', error.message);
            else { showItemAlert('success', 'Saved!'); setTimeout(() => { closeItemModal(); loadMenuItems(); }, 1000); }
        }

        async function uploadImage(file) {
            try {
                const fileName = Date.now() + '-' + Math.random().toString(36).substring(7) + '.' + file.name.split('.').pop();
                const { error } = await db.storage.from('images').upload('menu-items/' + fileName, file);
                if (error) return null;
                const { data: urlData } = db.storage.from('images').getPublicUrl('menu-items/' + fileName);
                return urlData.publicUrl;
            } catch (err) { return null; }
        }

        function handleImageSelect(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('imagePreview').innerHTML = '<img src="' + e.target.result + '" style="max-width:100%;max-height:150px;border-radius:8px;">'; document.getElementById('imagePreview').style.display = 'block'; };
                reader.readAsDataURL(file);
                document.getElementById('itemImage').value = '';
            }
        }

        function showItemAlert(type, message) { const alert = document.getElementById('itemAlert'); alert.className = 'alert ' + type + ' visible'; alert.textContent = message; }

        // ========== PROMOTIONS ==========
        async function loadPromotions() {
            // In production, load from database
            // For now, use localStorage
            const saved = localStorage.getItem('store_promotions_' + restaurantId);
            promotions = saved ? JSON.parse(saved) : [];
            renderPromotions();
            updatePromoStats();
        }
        
        function savePromotionsLocal() {
            localStorage.setItem('store_promotions_' + restaurantId, JSON.stringify(promotions));
        }

        function renderPromotions() {
            const container = document.getElementById('promoGrid');
            document.getElementById('promoCount').textContent = promotions.filter(p => p.is_active).length;
            
            if (promotions.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üéÅ</div><div>No promotions yet</div><p style="margin-top:0.5rem; font-size:0.85rem;">Create combos, happy hours, and special deals!</p></div>';
                return;
            }
            
            container.innerHTML = promotions.map(p => {
                const status = getPromoStatus(p);
                return '<div class="promo-card ' + (p.is_active ? 'active' : 'inactive') + '"><span class="promo-badge ' + status + '">' + status.toUpperCase() + '</span><div class="promo-type">' + getPromoTypeLabel(p.type) + '</div><div class="promo-name">' + p.name + '</div><div class="promo-desc">' + (p.description || '') + '</div><div class="promo-details">' + getPromoDetails(p) + '</div><div class="promo-actions"><button class="btn btn-secondary btn-sm" onclick="editPromo(\'' + p.id + '\')">‚úèÔ∏è Edit</button><button class="btn btn-danger btn-sm" onclick="openDeleteModal(\'' + p.id + '\',\'' + p.name.replace(/'/g, "\\'") + '\', \'promo\')">üóëÔ∏è</button></div></div>';
            }).join('');
        }
        
        function getPromoStatus(p) {
            if (!p.is_active) return 'expired';
            const now = new Date();
            if (p.start_date && new Date(p.start_date) > now) return 'scheduled';
            if (p.end_date && new Date(p.end_date) < now) return 'expired';
            return 'active';
        }
        
        function getPromoTypeLabel(type) {
            const labels = { combo: 'üçî Combo Deal', bogo: 'üéÅ BOGO', discount: 'üí∞ Discount', freeitem: 'üÜì Free Item', happyhour: 'üïê Happy Hour', slowtime: '‚è∞ Slow Time', firstorder: 'üÜï First Order', loyalty: '‚≠ê Loyalty' };
            return labels[type] || type;
        }
        
        function getPromoDetails(p) {
            let html = '';
            if (p.discount_percent) html += '<span>üí∞ ' + p.discount_percent + '% off</span>';
            if (p.discount_amount) html += '<span>üíµ $' + p.discount_amount + ' off</span>';
            if (p.combo_price) html += '<span>üè∑Ô∏è Combo price: $' + p.combo_price + '</span>';
            if (p.free_item) html += '<span>üÜì Free: ' + p.free_item + '</span>';
            if (p.start_time && p.end_time) html += '<span>‚è∞ ' + p.start_time + ' - ' + p.end_time + '</span>';
            if (p.start_date) html += '<span>üìÖ From: ' + p.start_date + '</span>';
            if (p.end_date) html += '<span>üìÖ Until: ' + p.end_date + '</span>';
            if (p.min_purchase) html += '<span>üõí Min: $' + p.min_purchase + '</span>';
            return html || '<span>No restrictions</span>';
        }
        
        function updatePromoStats() {
            const active = promotions.filter(p => getPromoStatus(p) === 'active').length;
            const scheduled = promotions.filter(p => getPromoStatus(p) === 'scheduled').length;
            document.getElementById('activePromos').textContent = active;
            document.getElementById('scheduledPromos').textContent = scheduled;
            // Simulated promo stats
            document.getElementById('promoRevenue').textContent = '$' + (active * 150).toFixed(0);
            document.getElementById('promoOrders').textContent = active * 12;
        }

        function openPromoModal() {
            document.getElementById('promoModalTitle').textContent = 'Create Promotion';
            document.getElementById('promoForm').reset();
            document.getElementById('promoId').value = '';
            document.getElementById('promoActive').checked = true;
            document.getElementById('promoAlert').className = 'alert';
            document.getElementById('promoDetails').innerHTML = '';
            document.getElementById('timeRestriction').style.display = 'none';
            document.getElementById('dayRestriction').style.display = 'none';
            document.getElementById('promoModal').classList.add('visible');
        }
        
        function editPromo(promoId) {
            const promo = promotions.find(p => p.id === promoId);
            if (!promo) return;
            document.getElementById('promoModalTitle').textContent = 'Edit Promotion';
            document.getElementById('promoId').value = promo.id;
            document.getElementById('promoType').value = promo.type;
            document.getElementById('promoName').value = promo.name;
            document.getElementById('promoDescription').value = promo.description || '';
            document.getElementById('promoStartDate').value = promo.start_date || '';
            document.getElementById('promoEndDate').value = promo.end_date || '';
            document.getElementById('promoActive').checked = promo.is_active;
            updatePromoForm();
            // Fill type-specific fields after form update
            setTimeout(() => {
                if (promo.discount_percent) document.getElementById('discountPercent') && (document.getElementById('discountPercent').value = promo.discount_percent);
                if (promo.discount_amount) document.getElementById('discountAmount') && (document.getElementById('discountAmount').value = promo.discount_amount);
                if (promo.combo_price) document.getElementById('comboPrice') && (document.getElementById('comboPrice').value = promo.combo_price);
                if (promo.min_purchase) document.getElementById('minPurchase') && (document.getElementById('minPurchase').value = promo.min_purchase);
                if (promo.free_item) document.getElementById('freeItem') && (document.getElementById('freeItem').value = promo.free_item);
                if (promo.start_time) document.getElementById('promoStartTime').value = promo.start_time;
                if (promo.end_time) document.getElementById('promoEndTime').value = promo.end_time;
            }, 100);
            document.getElementById('promoModal').classList.add('visible');
        }
        
        function closePromoModal() { document.getElementById('promoModal').classList.remove('visible'); }
        
        function updatePromoForm() {
            const type = document.getElementById('promoType').value;
            const details = document.getElementById('promoDetails');
            const timeDiv = document.getElementById('timeRestriction');
            const dayDiv = document.getElementById('dayRestriction');
            
            timeDiv.style.display = ['happyhour', 'slowtime'].includes(type) ? 'grid' : 'none';
            dayDiv.style.display = ['happyhour', 'slowtime'].includes(type) ? 'block' : 'none';
            
            let html = '';
            switch(type) {
                case 'combo':
                    html = '<div class="form-group"><label class="form-label">Items in Combo</label><textarea class="form-textarea" id="comboItems" placeholder="e.g., Burger + Fries + Drink"></textarea></div><div class="form-group"><label class="form-label">Combo Price ($)</label><input type="number" class="form-input" id="comboPrice" step="0.01" placeholder="9.99"></div>';
                    break;
                case 'bogo':
                    html = '<div class="form-group"><label class="form-label">Buy Item</label><input type="text" class="form-input" id="buyItem" placeholder="e.g., Any Pizza"></div><div class="form-group"><label class="form-label">Get Item</label><input type="text" class="form-input" id="getItem" placeholder="e.g., Second Pizza 50% off"></div>';
                    break;
                case 'discount':
                    html = '<div class="form-row"><div class="form-group"><label class="form-label">Discount %</label><input type="number" class="form-input" id="discountPercent" placeholder="e.g., 20"></div><div class="form-group"><label class="form-label">OR $ Off</label><input type="number" class="form-input" id="discountAmount" step="0.01" placeholder="e.g., 5.00"></div></div><div class="form-group"><label class="form-label">Min Purchase ($)</label><input type="number" class="form-input" id="minPurchase" step="0.01" placeholder="e.g., 25.00"></div>';
                    break;
                case 'freeitem':
                    html = '<div class="form-group"><label class="form-label">Free Item</label><input type="text" class="form-input" id="freeItem" placeholder="e.g., Free Pop, Free Garlic Bread"></div><div class="form-group"><label class="form-label">Min Purchase ($)</label><input type="number" class="form-input" id="minPurchase" step="0.01" placeholder="e.g., 20.00"></div>';
                    break;
                case 'happyhour':
                case 'slowtime':
                    html = '<div class="form-row"><div class="form-group"><label class="form-label">Discount %</label><input type="number" class="form-input" id="discountPercent" placeholder="e.g., 25"></div><div class="form-group"><label class="form-label">Applies To</label><select class="form-select" id="appliesTo"><option value="all">All Items</option><option value="drinks">Drinks Only</option><option value="appetizers">Appetizers Only</option><option value="selected">Selected Items</option></select></div></div>';
                    break;
                case 'firstorder':
                    html = '<div class="form-row"><div class="form-group"><label class="form-label">Discount %</label><input type="number" class="form-input" id="discountPercent" placeholder="e.g., 15"></div><div class="form-group"><label class="form-label">OR $ Off</label><input type="number" class="form-input" id="discountAmount" step="0.01" placeholder="e.g., 10.00"></div></div>';
                    break;
                case 'loyalty':
                    html = '<div class="form-group"><label class="form-label">Orders Required</label><input type="number" class="form-input" id="ordersRequired" placeholder="e.g., 10"></div><div class="form-group"><label class="form-label">Reward</label><input type="text" class="form-input" id="rewardItem" placeholder="e.g., Free Meal up to $15"></div>';
                    break;
            }
            details.innerHTML = html;
        }
        
        async function savePromo(e) {
            if (e) e.preventDefault();
            const type = document.getElementById('promoType').value;
            const name = document.getElementById('promoName').value.trim();
            if (!type || !name) { showPromoAlert('error', 'Fill required fields'); return; }
            
            const promoData = {
                id: document.getElementById('promoId').value || 'promo_' + Date.now(),
                type,
                name,
                description: document.getElementById('promoDescription').value.trim(),
                start_date: document.getElementById('promoStartDate').value || null,
                end_date: document.getElementById('promoEndDate').value || null,
                start_time: document.getElementById('promoStartTime').value || null,
                end_time: document.getElementById('promoEndTime').value || null,
                is_active: document.getElementById('promoActive').checked,
                discount_percent: document.getElementById('discountPercent')?.value || null,
                discount_amount: document.getElementById('discountAmount')?.value || null,
                combo_price: document.getElementById('comboPrice')?.value || null,
                min_purchase: document.getElementById('minPurchase')?.value || null,
                free_item: document.getElementById('freeItem')?.value || null,
                restaurant_id: restaurantId
            };
            
            const existingIndex = promotions.findIndex(p => p.id === promoData.id);
            if (existingIndex >= 0) promotions[existingIndex] = promoData;
            else promotions.push(promoData);
            
            savePromotionsLocal();
            showPromoAlert('success', 'Saved!');
            setTimeout(() => { closePromoModal(); renderPromotions(); updatePromoStats(); }, 1000);
        }
        
        function showPromoAlert(type, message) { const alert = document.getElementById('promoAlert'); alert.className = 'alert ' + type + ' visible'; alert.textContent = message; }

        // ========== ANALYTICS ==========
        function updateAnalytics() {
            const { start, end } = getDateRange();
            const periodItems = orderItems.filter(i => { const d = new Date(i.created_at); return d >= start && d <= end; });
            
            // Calculate item sales
            const itemSales = {};
            periodItems.forEach(item => {
                if (!itemSales[item.menu_item_id]) {
                    itemSales[item.menu_item_id] = { id: item.menu_item_id, name: item.item_name, category: item.category, quantity: 0, revenue: 0 };
                }
                itemSales[item.menu_item_id].quantity += item.quantity;
                itemSales[item.menu_item_id].revenue += item.quantity * item.price;
            });
            
            const salesArray = Object.values(itemSales).sort((a, b) => b.quantity - a.quantity);
            const totalItemsSold = salesArray.reduce((sum, i) => sum + i.quantity, 0);
            const totalRevenue = salesArray.reduce((sum, i) => sum + i.revenue, 0);
            const notSellingItems = menuItems.filter(m => !salesArray.find(s => s.id === m.id));
            const avgPrice = menuItems.length > 0 ? menuItems.reduce((sum, m) => sum + (m.base_price || 0), 0) / menuItems.length : 0;
            
            document.getElementById('statPeriodRevenue').textContent = '$' + (totalRevenue * STORE_REVENUE_PERCENT / 100).toFixed(2);
            document.getElementById('statItemsSold').textContent = totalItemsSold;
            document.getElementById('statNotSelling').textContent = notSellingItems.length;
            document.getElementById('statAvgPrice').textContent = '$' + avgPrice.toFixed(2);
            
            // Top Sellers
            const topContainer = document.getElementById('topSellers');
            if (salesArray.length === 0) {
                topContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No sales data yet</div></div>';
            } else {
                topContainer.innerHTML = salesArray.slice(0, 10).map((item, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return '<div class="item-rank"><div class="rank-number ' + rankClass + '">' + (i + 1) + '</div><div class="rank-info"><div class="rank-name">' + item.name + '</div><div class="rank-category">' + (item.category || '') + '</div></div><div class="rank-stats"><div class="rank-sold">' + item.quantity + ' sold</div><div class="rank-revenue">$' + item.revenue.toFixed(2) + '</div></div></div>';
                }).join('');
            }
            
            // Not Selling
            const notContainer = document.getElementById('notSelling');
            if (notSellingItems.length === 0) {
                notContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div>All items are selling!</div></div>';
            } else {
                notContainer.innerHTML = notSellingItems.slice(0, 10).map(item => '<div class="item-rank"><div class="rank-number" style="background:var(--accent-red-dim);color:var(--accent-red);">‚ö†Ô∏è</div><div class="rank-info"><div class="rank-name">' + item.name + '</div><div class="rank-category">' + (item.category || '') + '</div></div><div class="rank-stats"><div class="rank-sold not-selling">0 sold</div><div class="rank-revenue">$' + (item.base_price || 0).toFixed(2) + '</div></div></div>').join('');
            }
            
            // Category Performance
            const catPerf = {};
            salesArray.forEach(item => {
                const cat = item.category || 'Other';
                if (!catPerf[cat]) catPerf[cat] = { quantity: 0, revenue: 0 };
                catPerf[cat].quantity += item.quantity;
                catPerf[cat].revenue += item.revenue;
            });
            
            const catContainer = document.getElementById('categoryPerformance');
            const catArray = Object.entries(catPerf).sort((a, b) => b[1].revenue - a[1].revenue);
            if (catArray.length === 0) {
                catContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No category data yet</div></div>';
            } else {
                const maxRev = Math.max(...catArray.map(c => c[1].revenue));
                catContainer.innerHTML = catArray.map(([cat, data]) => {
                    const pct = maxRev > 0 ? (data.revenue / maxRev * 100) : 0;
                    return '<div style="margin-bottom:1rem;"><div style="display:flex;justify-content:space-between;margin-bottom:0.25rem;"><span style="font-weight:600;">' + cat + '</span><span style="color:var(--accent-green);">$' + data.revenue.toFixed(2) + ' (' + data.quantity + ' items)</span></div><div style="background:var(--bg-dark);border-radius:4px;height:8px;overflow:hidden;"><div style="background:var(--accent-green);height:100%;width:' + pct + '%;border-radius:4px;"></div></div></div>';
                }).join('');
            }
        }

        // ========== DELETE ==========
        function openDeleteModal(id, name, type) { 
            deleteItemId = id; 
            deleteType = type;
            document.getElementById('deleteItemName').textContent = name; 
            document.getElementById('deleteModal').classList.add('visible'); 
        }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('visible'); deleteItemId = null; }
        async function confirmDelete() { 
            if (!deleteItemId) return; 
            if (deleteType === 'promo') {
                promotions = promotions.filter(p => p.id !== deleteItemId);
                savePromotionsLocal();
                renderPromotions();
                updatePromoStats();
            } else {
                await db.from('menu_items').delete().eq('id', deleteItemId); 
                loadMenuItems(); 
            }
            closeDeleteModal(); 
        }

        function setupRealtime() { db.channel('store-orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => loadAllOrders()).subscribe(); }
        function formatTime(dateString) { if (!dateString) return ''; const date = new Date(dateString); const diff = new Date() - date; if (diff < 60000) return 'Just now'; if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago'; if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); return date.toLocaleDateString(); }
    </script>
</body>
</html>
