<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Owner Dashboard - YYC LocalFirst</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth-guard.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12131a;
            --bg-card-hover: #1a1b24;
            --bg-input: #1a1b24;
            --border: #2a2b35;
            --text-primary: #ffffff;
            --text-secondary: #8b8d9a;
            --text-muted: #5a5c6a;
            --accent-green: #00d26a;
            --accent-green-dim: rgba(0, 210, 106, 0.15);
            --accent-orange: #ff9f43;
            --accent-orange-dim: rgba(255, 159, 67, 0.15);
            --accent-red: #ff6b6b;
            --accent-red-dim: rgba(255, 107, 107, 0.15);
            --accent-blue: #4da6ff;
            --accent-blue-dim: rgba(77, 166, 255, 0.15);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; }
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { font-size: 1.5rem; }
        .logo-text { font-size: 1.25rem; font-weight: 700; color: var(--accent-green); }
        .logo-badge { background: var(--accent-orange-dim); color: var(--accent-orange); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .date-filters { display: flex; gap: 0.25rem; background: var(--bg-dark); padding: 0.3rem; border-radius: 8px; border: 1px solid var(--border); }
        .date-btn { padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 500; cursor: pointer; background: transparent; border: none; color: var(--text-secondary); transition: all 0.2s; }
        .date-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .date-btn.active { background: var(--accent-green); color: #000; }
        .user-menu { display: flex; align-items: center; gap: 0.75rem; padding-left: 1rem; border-left: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; position: relative; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-orange), #ff7b00); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; color: #000; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-name { font-size: 0.8rem; font-weight: 600; }
        .user-role { font-size: 0.65rem; color: var(--text-secondary); }
        .logout-btn { padding: 0.5rem 0.75rem; background: var(--accent-red-dim); border: 1px solid var(--accent-red); border-radius: 8px; color: var(--accent-red); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .logout-btn:hover { background: var(--accent-red); color: white; }
        .profile-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 0.5rem; min-width: 200px; z-index: 1000; }
        .profile-dropdown.visible { display: block; }
        .profile-dropdown-item { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); }
        .profile-dropdown-item:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .main { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg-card); padding: 0.5rem; border-radius: 12px; border: 1px solid var(--border); }
        .tab { padding: 0.75rem 1.5rem; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .tab.active { background: var(--accent-green); color: #000; }
        .tab-count { background: rgba(0,0,0,0.2); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
        .stat-card.highlight { border-color: var(--accent-green); background: linear-gradient(135deg, var(--bg-card), var(--accent-green-dim)); }
        .stat-label { color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.75rem; font-weight: 700; }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
        .section-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 1.5rem; }
        .section-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .btn { padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s; }
        .btn-primary { background: var(--accent-green); color: #000; }
        .btn-primary:hover { background: #00b85c; }
        .btn-secondary { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-secondary:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .btn-danger { background: var(--accent-red-dim); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .btn-danger:hover { background: var(--accent-red); color: white; }
        .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.75rem; }
        .orders-list { max-height: 400px; overflow-y: auto; }
        .order-item { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: background 0.2s; }
        .order-item:hover { background: var(--bg-card-hover); }
        .order-status { width: 10px; height: 10px; border-radius: 50%; }
        .order-status.pending { background: var(--accent-orange); }
        .order-status.confirmed, .order-status.preparing { background: var(--accent-blue); }
        .order-status.ready { background: var(--accent-green); }
        .order-status.completed { background: var(--text-muted); }
        .order-info { flex: 1; }
        .order-number { font-weight: 600; margin-bottom: 0.25rem; }
        .order-customer { font-size: 0.85rem; color: var(--text-secondary); }
        .order-meta { text-align: right; }
        .order-total { font-weight: 700; color: var(--accent-green); }
        .order-time { font-size: 0.75rem; color: var(--text-muted); }
        .order-type { font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; margin-top: 0.35rem; display: inline-block; }
        .order-type.delivery { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .order-type.pickup { background: var(--accent-orange-dim); color: var(--accent-orange); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem; }
        .menu-item-card { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
        .menu-item-card:hover { border-color: var(--accent-green); }
        .menu-item-card.unavailable { opacity: 0.6; }
        .menu-item-image { width: 100%; height: 140px; background: var(--bg-card-hover); display: flex; align-items: center; justify-content: center; font-size: 3rem; position: relative; }
        .menu-item-image img { width: 100%; height: 100%; object-fit: cover; }
        .unavailable-badge { position: absolute; top: 0.5rem; right: 0.5rem; background: var(--accent-red); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; }
        .menu-item-content { padding: 1rem; }
        .menu-item-name { font-weight: 600; margin-bottom: 0.25rem; }
        .menu-item-category { font-size: 0.75rem; color: var(--accent-orange); margin-bottom: 0.5rem; }
        .menu-item-description { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .menu-item-footer { display: flex; justify-content: space-between; align-items: center; }
        .menu-item-price { font-size: 1.1rem; font-weight: 700; color: var(--accent-green); }
        .menu-item-actions { display: flex; gap: 0.35rem; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.visible { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.25rem; }
        .modal-footer { padding: 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-green); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .form-checkbox input { width: 18px; height: 18px; accent-color: var(--accent-green); }
        .empty-state { padding: 3rem; text-align: center; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
        .order-status-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .status-btn { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-secondary); cursor: pointer; font-size: 0.8rem; }
        .status-btn:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .status-btn.active { background: var(--accent-green); border-color: var(--accent-green); color: #000; }
        .alert { padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .alert.visible { display: block; }
        .alert.success { background: var(--accent-green-dim); border: 1px solid var(--accent-green); color: var(--accent-green); }
        .alert.error { background: var(--accent-red-dim); border: 1px solid var(--accent-red); color: var(--accent-red); }
        .search-bar { display: flex; gap: 0.75rem; margin-bottom: 1rem; padding: 0 1rem; }
        .search-input { flex: 1; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; }
        .revenue-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 8px; margin: 1rem; }
        .revenue-item { text-align: center; padding: 1rem; border-radius: 8px; }
        .revenue-item.total { background: var(--accent-blue-dim); border: 1px solid var(--accent-blue); }
        .revenue-item.yours { background: var(--accent-green-dim); border: 1px solid var(--accent-green); }
        .revenue-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .revenue-value { font-size: 1.5rem; font-weight: 700; }
        .revenue-item.total .revenue-value { color: var(--accent-blue); }
        .revenue-item.yours .revenue-value { color: var(--accent-green); }
        @media (max-width: 1000px) { .date-filters { display: none; } }
        @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .tabs { flex-wrap: wrap; } .menu-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üè™</span>
                <span class="logo-text">YYC LocalFirst</span>
                <span class="logo-badge">STORE</span>
            </div>
            <div class="header-right">
                <div class="date-filters">
                    <button class="date-btn active" data-range="today">Today</button>
                    <button class="date-btn" data-range="yesterday">Yesterday</button>
                    <button class="date-btn" data-range="week">7 Days</button>
                    <button class="date-btn" data-range="month">30 Days</button>
                    <button class="date-btn" data-range="all">All</button>
                </div>
                <div class="user-menu">
                    <div class="user-info" onclick="toggleProfileDropdown()">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <div>
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role">Store Owner</div>
                        </div>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-item" onclick="openProfileModal(event)">üì∑ Change Picture</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">üö™ Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="tabs">
            <button class="tab active" data-tab="orders" onclick="switchTab('orders')">üìã Orders <span class="tab-count" id="ordersCount">0</span></button>
            <button class="tab" data-tab="menu" onclick="switchTab('menu')">üçΩÔ∏è Menu <span class="tab-count" id="menuCount">0</span></button>
            <button class="tab" data-tab="analytics" onclick="switchTab('analytics')">üìä Analytics</button>
        </div>

        <div id="ordersTab">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Orders <span id="dateRangeLabel">(Today)</span></div>
                    <div class="stat-value" id="statOrders">0</div>
                    <div class="stat-sub" id="statPendingSub">0 pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Sales</div>
                    <div class="stat-value blue" id="statTotalSales">$0</div>
                    <div class="stat-sub">Before fees</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-label">üí∞ Your Revenue</div>
                    <div class="stat-value green" id="statYourRevenue">$0</div>
                    <div class="stat-sub">After platform fee</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Order</div>
                    <div class="stat-value" id="statAvgOrder">$0</div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">üìã Recent Orders</div>
                    <button class="btn btn-secondary btn-sm" onclick="loadOrders()">üîÑ Refresh</button>
                </div>
                <div class="orders-list" id="ordersList"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No orders yet</div></div></div>
            </div>
        </div>

        <div id="menuTab" style="display: none;">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">üçΩÔ∏è Menu Items</div>
                    <button class="btn btn-primary" onclick="openAddItemModal()">‚ûï Add Item</button>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" id="menuSearch" placeholder="Search menu items..." oninput="filterMenuItems()">
                    <select class="form-select" style="width: auto;" id="categoryFilter" onchange="filterMenuItems()"><option value="">All Categories</option></select>
                </div>
                <div class="menu-grid" id="menuGrid"><div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div>No menu items yet</div></div></div>
            </div>
        </div>

        <div id="analyticsTab" style="display: none;">
            <div class="stats-row">
                <div class="stat-card"><div class="stat-label">This Week Sales</div><div class="stat-value blue" id="statWeekSales">$0</div></div>
                <div class="stat-card highlight"><div class="stat-label">This Week Revenue</div><div class="stat-value green" id="statWeekRevenue">$0</div></div>
                <div class="stat-card"><div class="stat-label">This Month Sales</div><div class="stat-value blue" id="statMonthSales">$0</div></div>
                <div class="stat-card highlight"><div class="stat-label">This Month Revenue</div><div class="stat-value green" id="statMonthRevenue">$0</div></div>
            </div>
            <div class="section-card">
                <div class="section-header"><div class="section-title">üí∞ Revenue Summary</div></div>
                <div class="revenue-summary">
                    <div class="revenue-item total"><div class="revenue-label">Total Sales (All Time)</div><div class="revenue-value" id="allTimeSales">$0</div></div>
                    <div class="revenue-item yours"><div class="revenue-label">Your Revenue (All Time)</div><div class="revenue-value" id="allTimeRevenue">$0</div></div>
                </div>
                <div style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;">Total Orders: <strong id="totalOrdersCount">0</strong> ‚Ä¢ Menu Items: <strong id="totalMenuItems">0</strong></div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-title" id="itemModalTitle">Add Menu Item</div><button class="modal-close" onclick="closeItemModal()">&times;</button></div>
            <div class="modal-body">
                <div class="alert" id="itemAlert"></div>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    <div class="form-group"><label class="form-label">Item Name *</label><input type="text" class="form-input" id="itemName" required></div>
                    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="itemDescription"></textarea></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Price *</label><input type="number" class="form-input" id="itemPrice" step="0.01" min="0" required></div>
                        <div class="form-group"><label class="form-label">Category *</label><select class="form-select" id="itemCategory" required><option value="">Select</option><option>Appetizers</option><option>Main Course</option><option>Pizza</option><option>Burgers</option><option>Sandwiches</option><option>Salads</option><option>Sides</option><option>Desserts</option><option>Beverages</option><option>Specials</option></select></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image</label>
                        <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer;" onclick="document.getElementById('itemImageFile').click()">
                            <input type="file" id="itemImageFile" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">
                            <div style="color: var(--text-secondary);">üìÅ Click to upload</div>
                        </div>
                        <div id="imagePreview" style="display: none; margin-top: 0.5rem;"></div>
                        <div style="text-align: center; color: var(--text-muted); font-size: 0.75rem; margin: 0.5rem 0;">‚Äî OR paste URL ‚Äî</div>
                        <input type="url" class="form-input" id="itemImage" placeholder="https://...">
                    </div>
                    <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="itemAvailable" checked> Item is available</label></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button><button class="btn btn-primary" onclick="saveItem(event)">üíæ Save</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal"><div class="modal-header"><div class="modal-title" id="orderModalTitle">Order</div><button class="modal-close" onclick="closeOrderModal()">&times;</button></div><div class="modal-body" id="orderModalBody"></div></div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><div class="modal-title">‚ö†Ô∏è Confirm Delete</div><button class="modal-close" onclick="closeDeleteModal()">&times;</button></div>
            <div class="modal-body"><p>Delete "<span id="deleteItemName"></span>"?</p></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button><button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Delete</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><div class="modal-title">üì∑ Change Picture</div><button class="modal-close" onclick="closeProfileModal()">&times;</button></div>
            <div class="modal-body">
                <div class="alert" id="profileAlert"></div>
                <div style="text-align: center; margin-bottom: 1rem;"><div id="currentAvatarPreview" style="width: 100px; height: 100px; border-radius: 50%; background: var(--accent-orange); display: inline-flex; align-items: center; justify-content: center; font-size: 2.5rem; overflow: hidden;">üë§</div></div>
                <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer;" onclick="document.getElementById('profileImageFile').click()">
                    <input type="file" id="profileImageFile" accept="image/*" style="display: none;" onchange="handleProfileImageSelect(this)">
                    <div style="color: var(--text-secondary);">üìÅ Click to upload</div>
                </div>
                <div id="profileImagePreview" style="display: none; margin-top: 1rem; text-align: center;"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfilePicture()">üíæ Save</button></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const STORE_REVENUE_PERCENT = 85;

        let currentUser = null, restaurantId = null, orders = [], allOrders = [], menuItems = [], currentTab = 'orders', currentDateRange = 'today', deleteItemId = null, profileImageFile = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadRestaurant();
            await loadAllOrders();
            await loadMenuItems();
            setupDateFilters();
            setupRealtime();
            document.addEventListener('click', (e) => { if (!e.target.closest('.user-info')) document.getElementById('profileDropdown').classList.remove('visible'); });
        });

        async function loadUserInfo() {
            const userJson = localStorage.getItem('user');
            if (userJson) {
                currentUser = JSON.parse(userJson);
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                if (currentUser.profilePicture) document.getElementById('userAvatar').innerHTML = '<img src="' + currentUser.profilePicture + '">';
                else document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }
        }

        async function loadRestaurant() {
            if (currentUser && currentUser.restaurantId) restaurantId = currentUser.restaurantId;
            else { const { data } = await db.from('restaurants').select('id').limit(1).single(); if (data) restaurantId = data.id; }
        }

        function handleLogout() { if (confirm('Logout?')) { localStorage.removeItem('user'); localStorage.removeItem('sessionToken'); window.location.href = 'login.html'; } }
        function toggleProfileDropdown() { document.getElementById('profileDropdown').classList.toggle('visible'); }
        
        function openProfileModal(e) {
            if (e) e.stopPropagation();
            document.getElementById('profileDropdown').classList.remove('visible');
            document.getElementById('profileAlert').className = 'alert';
            document.getElementById('profileImagePreview').style.display = 'none';
            profileImageFile = null;
            document.getElementById('currentAvatarPreview').innerHTML = document.getElementById('userAvatar').innerHTML;
            document.getElementById('profileModal').classList.add('visible');
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('visible'); }
        
        function handleProfileImageSelect(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { document.getElementById('profileAlert').className = 'alert error visible'; document.getElementById('profileAlert').textContent = 'Max 2MB'; return; }
                profileImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('profileImagePreview').innerHTML = '<img src="' + e.target.result + '" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">'; document.getElementById('profileImagePreview').style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }
        
        async function saveProfilePicture() {
            if (!profileImageFile) return;
            document.getElementById('profileAlert').className = 'alert success visible';
            document.getElementById('profileAlert').textContent = 'Uploading...';
            try {
                const fileName = 'profile-' + Date.now() + '.' + profileImageFile.name.split('.').pop();
                const { error } = await db.storage.from('images').upload('profiles/' + fileName, profileImageFile, { upsert: true });
                if (error) throw error;
                const { data: urlData } = db.storage.from('images').getPublicUrl('profiles/' + fileName);
                currentUser.profilePicture = urlData.publicUrl;
                localStorage.setItem('user', JSON.stringify(currentUser));
                document.getElementById('userAvatar').innerHTML = '<img src="' + urlData.publicUrl + '">';
                document.getElementById('profileAlert').textContent = 'Saved!';
                setTimeout(closeProfileModal, 1000);
            } catch (err) { document.getElementById('profileAlert').className = 'alert error visible'; document.getElementById('profileAlert').textContent = 'Failed'; }
        }

        function setupDateFilters() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDateRange = btn.dataset.range;
                    filterOrdersByDate();
                });
            });
        }

        function getDateRange() {
            const now = new Date();
            let start = new Date();
            switch(currentDateRange) {
                case 'today': start.setHours(0,0,0,0); break;
                case 'yesterday': start.setDate(start.getDate()-1); start.setHours(0,0,0,0); const end = new Date(start); end.setHours(23,59,59,999); return {start, end};
                case 'week': start.setDate(start.getDate()-7); start.setHours(0,0,0,0); break;
                case 'month': start.setDate(start.getDate()-30); start.setHours(0,0,0,0); break;
                case 'all': start = new Date('2020-01-01'); break;
            }
            return { start, end: now };
        }

        function filterOrdersByDate() {
            const { start, end } = getDateRange();
            orders = allOrders.filter(o => { const d = new Date(o.created_at); return d >= start && d <= end; });
            renderOrders();
            updateOrderStats();
            const labels = { today: 'Today', yesterday: 'Yesterday', week: '7 Days', month: '30 Days', all: 'All Time' };
            document.getElementById('dateRangeLabel').textContent = '(' + labels[currentDateRange] + ')';
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="' + tab + '"]').classList.add('active');
            document.getElementById('ordersTab').style.display = tab === 'orders' ? 'block' : 'none';
            document.getElementById('menuTab').style.display = tab === 'menu' ? 'block' : 'none';
            document.getElementById('analyticsTab').style.display = tab === 'analytics' ? 'block' : 'none';
            if (tab === 'analytics') loadAnalytics();
        }

        async function loadAllOrders() {
            let query = db.from('orders').select('*').order('created_at', { ascending: false });
            if (restaurantId) query = query.eq('restaurant_id', restaurantId);
            const { data } = await query;
            allOrders = data || [];
            filterOrdersByDate();
        }
        async function loadOrders() { await loadAllOrders(); }

        function renderOrders() {
            const container = document.getElementById('ordersList');
            document.getElementById('ordersCount').textContent = orders.length;
            if (orders.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No orders</div></div>'; return; }
            container.innerHTML = orders.map(o => '<div class="order-item" onclick="openOrderModal(\'' + o.id + '\')"><div class="order-status ' + o.status + '"></div><div class="order-info"><div class="order-number">#' + (o.order_number || o.id.slice(0,6)) + '</div><div class="order-customer">' + (o.customer_name || 'Customer') + '</div></div><div class="order-meta"><div class="order-total">$' + (o.total || 0).toFixed(2) + '</div><div class="order-time">' + formatTime(o.created_at) + '</div><div class="order-type ' + (o.order_type || 'delivery') + '">' + (o.order_type === 'pickup' ? 'üèÉ Pickup' : 'üöó Delivery') + '</div></div></div>').join('');
        }

        function updateOrderStats() {
            const totalSales = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            const yourRevenue = totalSales * (STORE_REVENUE_PERCENT / 100);
            const pending = orders.filter(o => o.status === 'pending' || o.status === 'preparing').length;
            const avgOrder = orders.length > 0 ? totalSales / orders.length : 0;
            document.getElementById('statOrders').textContent = orders.length;
            document.getElementById('statTotalSales').textContent = '$' + totalSales.toFixed(0);
            document.getElementById('statYourRevenue').textContent = '$' + yourRevenue.toFixed(0);
            document.getElementById('statAvgOrder').textContent = '$' + avgOrder.toFixed(0);
            document.getElementById('statPendingSub').textContent = pending + ' pending';
        }

        function openOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            const total = order.total || 0;
            const yours = total * (STORE_REVENUE_PERCENT / 100);
            document.getElementById('orderModalTitle').textContent = 'Order #' + (order.order_number || order.id.slice(0,6));
            document.getElementById('orderModalBody').innerHTML = '<div style="margin-bottom:1rem;"><strong>Customer:</strong> ' + (order.customer_name || 'N/A') + '<br><strong>Phone:</strong> ' + (order.customer_phone || 'N/A') + '<br><strong>Address:</strong> ' + (order.customer_address || 'N/A') + '</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;"><div style="background:var(--accent-blue-dim);padding:1rem;border-radius:8px;text-align:center;"><div style="font-size:0.8rem;color:var(--text-secondary);">Order Total</div><div style="font-size:1.25rem;font-weight:700;color:var(--accent-blue);">$' + total.toFixed(2) + '</div></div><div style="background:var(--accent-green-dim);padding:1rem;border-radius:8px;text-align:center;"><div style="font-size:0.8rem;color:var(--text-secondary);">Your Revenue</div><div style="font-size:1.25rem;font-weight:700;color:var(--accent-green);">$' + yours.toFixed(2) + '</div></div></div><div><strong>Status:</strong><div class="order-status-buttons"><button class="status-btn ' + (order.status === 'pending' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'pending\')">üì• Pending</button><button class="status-btn ' + (order.status === 'confirmed' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'confirmed\')">‚úÖ Confirmed</button><button class="status-btn ' + (order.status === 'preparing' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'preparing\')">üë®‚Äçüç≥ Preparing</button><button class="status-btn ' + (order.status === 'ready' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'ready\')">üîî Ready</button><button class="status-btn ' + (order.status === 'completed' ? 'active' : '') + '" onclick="updateOrderStatus(\'' + order.id + '\',\'completed\')">‚úîÔ∏è Done</button></div></div>';
            document.getElementById('orderModal').classList.add('visible');
        }
        function closeOrderModal() { document.getElementById('orderModal').classList.remove('visible'); }

        async function updateOrderStatus(orderId, status) {
            await db.from('orders').update({ status }).eq('id', orderId);
            const order = allOrders.find(o => o.id === orderId);
            if (order) order.status = status;
            filterOrdersByDate();
            openOrderModal(orderId);
        }

        async function loadMenuItems() {
            let query = db.from('menu_items').select('*').order('category', { ascending: true });
            if (restaurantId) query = query.eq('restaurant_id', restaurantId);
            const { data } = await query;
            menuItems = data || [];
            renderMenuItems();
            updateCategoryFilter();
        }

        function renderMenuItems() {
            const container = document.getElementById('menuGrid');
            document.getElementById('menuCount').textContent = menuItems.length;
            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const filtered = menuItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) || (item.description || '').toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üçΩÔ∏è</div><div>' + (menuItems.length === 0 ? 'No menu items yet' : 'No items match') + '</div></div>'; return; }
            container.innerHTML = filtered.map(item => '<div class="menu-item-card ' + (item.is_available === false ? 'unavailable' : '') + '"><div class="menu-item-image">' + (item.image_url ? '<img src="' + item.image_url + '" onerror="this.parentElement.innerHTML=\'üçΩÔ∏è\'">' : 'üçΩÔ∏è') + (item.is_available === false ? '<span class="unavailable-badge">Unavailable</span>' : '') + '</div><div class="menu-item-content"><div class="menu-item-name">' + item.name + '</div><div class="menu-item-category">' + (item.category || '') + '</div><div class="menu-item-description">' + (item.description || '') + '</div><div class="menu-item-footer"><div class="menu-item-price">$' + (item.base_price || 0).toFixed(2) + '</div><div class="menu-item-actions"><button class="btn btn-secondary btn-sm" onclick="editItem(\'' + item.id + '\')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="openDeleteModal(\'' + item.id + '\',\'' + item.name.replace(/'/g, "\\'") + '\')">üóëÔ∏è</button></div></div></div></div>').join('');
        }

        function filterMenuItems() { renderMenuItems(); }
        function updateCategoryFilter() {
            const categories = [...new Set(menuItems.map(item => item.category).filter(Boolean))];
            document.getElementById('categoryFilter').innerHTML = '<option value="">All</option>' + categories.map(cat => '<option>' + cat + '</option>').join('');
        }

        function openAddItemModal() {
            document.getElementById('itemModalTitle').textContent = 'Add Menu Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemAvailable').checked = true;
            document.getElementById('itemAlert').className = 'alert';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('itemImageFile').value = '';
            document.getElementById('itemModal').classList.add('visible');
        }

        function editItem(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            document.getElementById('itemModalTitle').textContent = 'Edit Menu Item';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemPrice').value = item.base_price || '';
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemImage').value = item.image_url || '';
            document.getElementById('itemAvailable').checked = item.is_available !== false;
            document.getElementById('itemAlert').className = 'alert';
            document.getElementById('itemImageFile').value = '';
            const preview = document.getElementById('imagePreview');
            if (item.image_url) { preview.innerHTML = '<img src="' + item.image_url + '" style="max-width:100%;max-height:150px;border-radius:8px;">'; preview.style.display = 'block'; }
            else { preview.style.display = 'none'; }
            document.getElementById('itemModal').classList.add('visible');
        }

        function closeItemModal() { document.getElementById('itemModal').classList.remove('visible'); }

        async function saveItem(e) {
            if (e) e.preventDefault();
            const itemId = document.getElementById('itemId').value;
            let imageUrl = document.getElementById('itemImage').value.trim() || null;
            const imageFile = document.getElementById('itemImageFile').files[0];
            if (imageFile) {
                showItemAlert('success', 'Uploading...');
                const uploadedUrl = await uploadImage(imageFile);
                if (uploadedUrl) imageUrl = uploadedUrl;
                else { showItemAlert('error', 'Upload failed'); return; }
            }
            const itemData = { name: document.getElementById('itemName').value.trim(), description: document.getElementById('itemDescription').value.trim(), base_price: parseFloat(document.getElementById('itemPrice').value) || 0, category: document.getElementById('itemCategory').value, image_url: imageUrl, is_available: document.getElementById('itemAvailable').checked, restaurant_id: restaurantId };
            if (!itemData.name || !itemData.base_price || !itemData.category) { showItemAlert('error', 'Fill required fields'); return; }
            let error;
            if (itemId) { const result = await db.from('menu_items').update(itemData).eq('id', itemId); error = result.error; }
            else { const result = await db.from('menu_items').insert([itemData]); error = result.error; }
            if (error) showItemAlert('error', error.message);
            else { showItemAlert('success', 'Saved!'); setTimeout(() => { closeItemModal(); loadMenuItems(); }, 1000); }
        }

        async function uploadImage(file) {
            try {
                const fileName = Date.now() + '-' + Math.random().toString(36).substring(7) + '.' + file.name.split('.').pop();
                const { error } = await db.storage.from('images').upload('menu-items/' + fileName, file);
                if (error) return null;
                const { data: urlData } = db.storage.from('images').getPublicUrl('menu-items/' + fileName);
                return urlData.publicUrl;
            } catch (err) { return null; }
        }

        function handleImageSelect(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { document.getElementById('imagePreview').innerHTML = '<img src="' + e.target.result + '" style="max-width:100%;max-height:150px;border-radius:8px;">'; document.getElementById('imagePreview').style.display = 'block'; };
                reader.readAsDataURL(file);
                document.getElementById('itemImage').value = '';
            }
        }

        function showItemAlert(type, message) { const alert = document.getElementById('itemAlert'); alert.className = 'alert ' + type + ' visible'; alert.textContent = message; }
        function openDeleteModal(itemId, itemName) { deleteItemId = itemId; document.getElementById('deleteItemName').textContent = itemName; document.getElementById('deleteModal').classList.add('visible'); }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('visible'); deleteItemId = null; }
        async function confirmDelete() { if (!deleteItemId) return; await db.from('menu_items').delete().eq('id', deleteItemId); closeDeleteModal(); loadMenuItems(); }

        async function loadAnalytics() {
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            const weekOrders = allOrders.filter(o => new Date(o.created_at) >= weekAgo);
            const monthOrders = allOrders.filter(o => new Date(o.created_at) >= monthAgo);
            const weekSales = weekOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const monthSales = monthOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const allTimeSales = allOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            document.getElementById('statWeekSales').textContent = '$' + weekSales.toFixed(0);
            document.getElementById('statWeekRevenue').textContent = '$' + (weekSales * STORE_REVENUE_PERCENT / 100).toFixed(0);
            document.getElementById('statMonthSales').textContent = '$' + monthSales.toFixed(0);
            document.getElementById('statMonthRevenue').textContent = '$' + (monthSales * STORE_REVENUE_PERCENT / 100).toFixed(0);
            document.getElementById('allTimeSales').textContent = '$' + allTimeSales.toFixed(0);
            document.getElementById('allTimeRevenue').textContent = '$' + (allTimeSales * STORE_REVENUE_PERCENT / 100).toFixed(0);
            document.getElementById('totalOrdersCount').textContent = allOrders.length;
            document.getElementById('totalMenuItems').textContent = menuItems.length;
        }

        function setupRealtime() { db.channel('store-orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => loadAllOrders()).subscribe(); }
        function formatTime(dateString) { if (!dateString) return ''; const date = new Date(dateString); const diff = new Date() - date; if (diff < 60000) return 'Just now'; if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago'; if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); return date.toLocaleDateString(); }
    </script>
</body>
</html>
