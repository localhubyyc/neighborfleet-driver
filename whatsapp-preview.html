<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LocalFirst YYC</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%;
            width: 100%;
            background: #0b141a; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }
        
        .app { 
            width: 100%;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: #0b141a;
            position: relative;
        }
        
        @media (min-width: 481px) {
            .app {
                border-left: 1px solid #2a3942;
                border-right: 1px solid #2a3942;
            }
        }
        
        /* Header */
        .header { 
            background: #075E54; 
            padding: 16px 20px; 
            display: flex; 
            align-items: center; 
            gap: 14px;
            flex-shrink: 0;
        }
        .header .back {
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            display: none;
        }
        .header.has-back .back { display: block; }
        .header .avatar { 
            width: 48px; height: 48px; 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 16px;
        }
        .header .info { flex: 1; }
        .header .name { font-weight: 700; font-size: 22px; }
        .header .status { font-size: 14px; color: #a8d8c8; }
        
        /* Content area */
        .content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
        }
        
        /* Page title */
        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Messages */
        .msg { margin-bottom: 16px; }
        .bubble { 
            padding: 14px 18px; 
            font-size: 16px; 
            line-height: 1.5; 
            border-radius: 16px;
            background: #202c33;
        }
        
        /* Savings banner */
        .banner { 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center; 
            margin-bottom: 20px;
        }
        .banner .big { font-size: 26px; font-weight: 800; }
        .banner .sub { font-size: 14px; margin-top: 6px; opacity: 0.95; }
        
        /* Buttons */
        .buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
        .btn { 
            background: transparent; 
            border: 2px solid #00a884; 
            color: #00a884; 
            padding: 16px 18px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer;
            text-align: center;
        }
        .btn:active { background: rgba(0,168,132,0.15); }
        .btn.primary { background: #00a884; color: white; border: none; }
        .btn.primary:active { background: #008f72; }
        
        /* Restaurant button */
        .restaurant-btn {
            background: #00a884;
            border: none;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .restaurant-btn:active { background: #008f72; }
        .restaurant-btn .icon { font-size: 28px; width: 40px; text-align: center; }
        .restaurant-btn .info { flex: 1; }
        .restaurant-btn .name { font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px; }
        .restaurant-btn .meta { font-size: 13px; color: rgba(255,255,255,0.85); display: flex; gap: 10px; }
        .restaurant-btn .arrow { font-size: 20px; color: rgba(255,255,255,0.7); }
        
        /* Category button */
        .category-btn {
            background: #202c33;
            border: none;
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
        }
        .category-btn:active { background: #2a3a43; }
        .category-btn .icon { font-size: 32px; }
        .category-btn .label { font-size: 17px; font-weight: 600; flex: 1; }
        .category-btn .arrow { font-size: 20px; color: #8696a0; }
        
        /* Special card */
        .special-card {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .special-card:active { opacity: 0.9; }
        .special-card .tag { font-size: 11px; font-weight: 700; text-transform: uppercase; opacity: 0.9; margin-bottom: 6px; }
        .special-card .name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .special-card .desc { font-size: 13px; opacity: 0.9; margin-bottom: 8px; }
        .special-card .price-row { display: flex; align-items: center; gap: 10px; }
        .special-card .old-price { font-size: 14px; text-decoration: line-through; opacity: 0.7; }
        .special-card .new-price { font-size: 20px; font-weight: 800; }
        
        /* Menu item card */
        .menu-item {
            background: #202c33;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 14px;
            cursor: pointer;
        }
        .menu-item:active { background: #2a3a43; }
        .menu-item img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        .menu-item .body { padding: 14px; }
        .menu-item .name { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .menu-item .desc { font-size: 13px; color: #8696a0; margin-bottom: 8px; line-height: 1.4; }
        .menu-item .price { font-size: 18px; font-weight: 700; color: #25D366; }
        .menu-item .size-note { font-size: 12px; color: #8696a0; }
        
        /* Custom pizza option */
        .custom-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: none;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 14px;
            cursor: pointer;
            text-align: center;
            width: 100%;
        }
        .custom-btn:active { opacity: 0.9; }
        .custom-btn .icon { font-size: 40px; margin-bottom: 8px; }
        .custom-btn .label { font-size: 18px; font-weight: 700; }
        .custom-btn .sub { font-size: 13px; opacity: 0.9; margin-top: 4px; }
        
        /* Input field */
        .input-bubble {
            background: #202c33;
            border-radius: 12px;
            padding: 14px;
            margin-top: 16px;
        }
        .input-bubble input {
            width: 100%;
            background: #2a3942;
            border: none;
            border-radius: 10px;
            padding: 16px 18px;
            color: white;
            font-size: 17px;
            outline: none;
            margin-bottom: 12px;
        }
        .input-bubble input::placeholder { color: #8696a0; }
        
        /* Section header */
        .section-header {
            font-size: 14px;
            font-weight: 600;
            color: #8696a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 14px;
            padding-left: 4px;
        }
        
        /* Disclaimer */
        .disclaimer {
            font-size: 11px;
            color: #8696a0;
            text-align: center;
            margin-top: 16px;
        }
        
        /* Loading */
        .spinner { 
            width: 20px; height: 20px; 
            border: 2px solid #2a3942; 
            border-top-color: #25D366; 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Cart badge */
        .cart-badge {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #00a884;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 100;
        }
        .cart-badge:active { background: #008f72; }
        .cart-badge.show { display: block; }
    </style>
</head>
<body>
    <div class="app">
        <div class="header" id="header">
            <div class="back" id="backBtn">‚Üê</div>
            <div class="avatar" id="avatar">LF</div>
            <div class="info">
                <div class="name" id="headerName">LocalFirst YYC</div>
                <div class="status" id="headerStatus">online</div>
            </div>
        </div>
        
        <div class="content" id="content"></div>
        
        <div class="cart-badge" id="cartBadge">üõí View Cart (0) - $0.00</div>
    </div>

    <script>
        // ============================================
        // CONFIG
        // ============================================
        var SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        var db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================================
        // STATE
        // ============================================
        var state = {
            page: 'welcome',
            customer: null,
            restaurant: null,
            menuItems: [],
            categories: [],
            cart: [],
            history: []
        };
        
        var params = new URLSearchParams(window.location.search);
        var hasPromo = params.has('promo');
        
        var content = document.getElementById('content');
        var header = document.getElementById('header');
        var cartBadge = document.getElementById('cartBadge');
        
        // ============================================
        // STORAGE
        // ============================================
        function saveCustomer() {
            if (state.customer) {
                localStorage.setItem('localfirst_customer', JSON.stringify(state.customer));
            }
        }
        
        function loadCustomer() {
            var saved = localStorage.getItem('localfirst_customer');
            if (saved) {
                try { state.customer = JSON.parse(saved); return true; } catch(e) {}
            }
            return false;
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function navigate(page, addToHistory) {
            if (addToHistory !== false && state.page) {
                state.history.push(state.page);
            }
            state.page = page;
            header.className = state.history.length > 0 ? 'header has-back' : 'header';
        }
        
        function goBack() {
            if (state.history.length > 0) {
                var prevPage = state.history.pop();
                renderPage(prevPage, false);
            }
        }
        
        document.getElementById('backBtn').addEventListener('click', goBack);
        
        // ============================================
        // RENDER HELPERS
        // ============================================
        function render(html) {
            content.innerHTML = html;
            attachListeners();
            content.scrollTop = 0;
        }
        
        function attachListeners() {
            content.querySelectorAll('[data-action]').forEach(function(el) {
                el.addEventListener('click', function() {
                    handleAction(this.getAttribute('data-action'), this.getAttribute('data-value'));
                });
            });
            
            content.querySelectorAll('.input-submit').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var inputId = this.getAttribute('data-input');
                    var action = this.getAttribute('data-action');
                    var input = document.getElementById(inputId);
                    if (input && input.value.trim()) {
                        handleInput(action, input.value.trim());
                    }
                });
            });
            
            content.querySelectorAll('input').forEach(function(inp) {
                inp.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        var btn = content.querySelector('.input-submit');
                        if (btn) btn.click();
                    }
                });
                setTimeout(function() { inp.focus(); }, 100);
            });
        }
        
        function updateCart() {
            var count = state.cart.length;
            var total = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            cartBadge.textContent = 'üõí View Cart (' + count + ') - $' + total.toFixed(2);
            cartBadge.className = count > 0 ? 'cart-badge show' : 'cart-badge';
        }
        
        // ============================================
        // PAGES
        // ============================================
        function renderPage(page, addToHistory) {
            navigate(page, addToHistory);
            
            switch(page) {
                case 'welcome': showWelcome(); break;
                case 'restaurants': showRestaurants(); break;
                case 'restaurant_home': showRestaurantHome(); break;
                case 'specials': showSpecials(); break;
                case 'menu': showMenu(); break;
                case 'category': showCategory(state.currentCategory); break;
            }
        }
        
        // PAGE: Welcome
        function showWelcome() {
            setHeader('LocalFirst YYC', 'LF', 'online');
            
            var html = '';
            var isReturningCustomer = loadCustomer() && state.customer.name;
            
            // Only show promo banner for NEW customers
            if (hasPromo && !isReturningCustomer) {
                html += '<div class="banner"><div class="big">üéâ YOU SAVE $6.99!</div><div class="sub">FREE delivery within 3 km*</div></div>';
            }
            
            if (isReturningCustomer) {
                var savedAddr = state.customer.address || 'My Location';
                html += '<div class="bubble">' +
                    'üëã Welcome back, <b>' + state.customer.name + '</b>!<br><br>Deliver to your saved address?' +
                    '<div class="buttons">' +
                    '<button class="btn primary" data-action="use_saved_address">üìç ' + savedAddr + '</button>' +
                    '<button class="btn" data-action="share_location">üìç Update with GPS</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è Type New Address</button>' +
                    '</div></div>';
            } else {
                html += '<div class="bubble">' +
                    'üëã Welcome to <b>LocalFirst YYC</b>!<br><br>' +
                    'Order from Calgary\'s best local restaurants.<br>' +
                    'üöó FREE delivery within 3 km*<br><br>' +
                    'What\'s your name?' +
                    '</div>' +
                    '<div class="input-bubble">' +
                    '<input type="text" id="name_input" placeholder="Enter your name" autocomplete="off">' +
                    '<button class="btn primary input-submit" data-input="name_input" data-action="submit_name">Continue</button>' +
                    '</div>';
            }
            
            render(html);
        }
        
        // PAGE: Restaurants
        function showRestaurants() {
            var restaurants = [
                { id: '1', icon: 'üçï', name: 'AB King Pizza', rating: '4.8', distance: '0.8 km', time: '25 min' },
                { id: '2', icon: 'üçî', name: 'Burger Barn', rating: '4.7', distance: '1.2 km', time: '30 min' },
                { id: '3', icon: 'üçó', name: 'Wing House', rating: '4.6', distance: '1.5 km', time: '35 min' },
                { id: '4', icon: 'üåÆ', name: 'Taco Fiesta', rating: '4.5', distance: '2.0 km', time: '35 min' },
                { id: '5', icon: 'üçú', name: 'Noodle King', rating: '4.7', distance: '2.2 km', time: '40 min' }
            ];
            
            var html = '<div class="page-title">üçΩÔ∏è Restaurants Near You</div>';
            
            restaurants.forEach(function(r) {
                html += '<div class="restaurant-btn" data-action="select_restaurant" data-value="' + r.id + '">' +
                    '<div class="icon">' + r.icon + '</div>' +
                    '<div class="info">' +
                    '<div class="name">' + r.name + '</div>' +
                    '<div class="meta"><span>‚≠ê ' + r.rating + '</span><span>üìç ' + r.distance + '</span><span>üïê ' + r.time + '</span></div>' +
                    '</div>' +
                    '<div class="arrow">‚Ä∫</div>' +
                    '</div>';
            });
            
            html += '<div class="disclaimer">*FREE delivery within 3 km. $2.99 for 3-5 km.</div>';
            
            render(html);
        }
        
        // PAGE: Restaurant Home (Specials vs Menu)
        function showRestaurantHome() {
            setHeader(state.restaurant.name, state.restaurant.name.substring(0,2), 'online');
            
            var html = '<div class="bubble" style="text-align: center; margin-bottom: 20px;">' +
                'üëã Welcome to <b>' + state.restaurant.name + '</b>!<br>' +
                'üöó FREE delivery* ‚Ä¢ üïê ~30 min' +
                '</div>';
            
            html += '<div class="section-header">üî• Today\'s Specials</div>';
            html += '<div class="category-btn" data-action="show_specials">' +
                '<div class="icon">‚≠ê</div>' +
                '<div class="label">Special of the Day</div>' +
                '<div class="arrow">‚Ä∫</div>' +
                '</div>';
            
            html += '<div class="section-header">üìã Full Menu</div>';
            html += '<div class="category-btn" data-action="show_menu">' +
                '<div class="icon">üìñ</div>' +
                '<div class="label">Browse Menu</div>' +
                '<div class="arrow">‚Ä∫</div>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Specials
        function showSpecials() {
            var html = '<div class="page-title">‚≠ê Today\'s Specials</div>';
            
            // 3 special items
            var specials = [
                { 
                    id: 's1',
                    tag: 'üî• Most Popular', 
                    name: 'Family Feast Deal', 
                    desc: '2 Large Pizzas + Wings + 2L Pop',
                    oldPrice: 54.99,
                    newPrice: 39.99
                },
                { 
                    id: 's2',
                    tag: '‚ö° Limited Time', 
                    name: 'Lunch Special', 
                    desc: 'Medium 2-Topping Pizza + Can Pop',
                    oldPrice: 18.99,
                    newPrice: 12.99
                },
                { 
                    id: 's3',
                    tag: '‚ù§Ô∏è Customer Favorite', 
                    name: 'Wing Wednesday', 
                    desc: '2 lbs Wings + Fries + Dip',
                    oldPrice: 28.99,
                    newPrice: 19.99
                }
            ];
            
            specials.forEach(function(s) {
                html += '<div class="special-card" data-action="add_special" data-value="' + s.id + '">' +
                    '<div class="tag">' + s.tag + '</div>' +
                    '<div class="name">' + s.name + '</div>' +
                    '<div class="desc">' + s.desc + '</div>' +
                    '<div class="price-row">' +
                    '<span class="old-price">$' + s.oldPrice.toFixed(2) + '</span>' +
                    '<span class="new-price">$' + s.newPrice.toFixed(2) + '</span>' +
                    '</div>' +
                    '</div>';
            });
            
            html += '<div class="buttons" style="margin-top: 20px;">' +
                '<button class="btn" data-action="show_menu">üìã View Full Menu</button>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Menu Categories
        function showMenu() {
            var html = '<div class="page-title">üìã Menu</div>';
            
            var categories = [
                { id: 'pizza', icon: 'üçï', name: 'Pizza' },
                { id: 'donair', icon: 'üåØ', name: 'Donair' },
                { id: 'wings', icon: 'üçó', name: 'Wings' },
                { id: 'salads', icon: 'ü•ó', name: 'Salads' },
                { id: 'sides', icon: 'üçü', name: 'Sides' },
                { id: 'drinks', icon: 'ü•§', name: 'Drinks' },
                { id: 'combos', icon: 'üéÅ', name: 'Combos' }
            ];
            
            categories.forEach(function(cat) {
                html += '<div class="category-btn" data-action="show_category" data-value="' + cat.id + '">' +
                    '<div class="icon">' + cat.icon + '</div>' +
                    '<div class="label">' + cat.name + '</div>' +
                    '<div class="arrow">‚Ä∫</div>' +
                    '</div>';
            });
            
            render(html);
        }
        
        // PAGE: Category Items (e.g., Pizza)
        function showCategory(categoryId) {
            state.currentCategory = categoryId;
            
            var categoryNames = {
                'pizza': 'Pizza',
                'donair': 'Donair',
                'wings': 'Wings',
                'salads': 'Salads',
                'sides': 'Sides',
                'drinks': 'Drinks',
                'combos': 'Combos'
            };
            
            var html = '<div class="page-title">üçï ' + (categoryNames[categoryId] || 'Menu') + '</div>';
            
            // Custom option for pizza
            if (categoryId === 'pizza') {
                html += '<div class="custom-btn" data-action="custom_pizza">' +
                    '<div class="icon">üé®</div>' +
                    '<div class="label">Build Your Own Pizza</div>' +
                    '<div class="sub">Choose your toppings</div>' +
                    '</div>';
                
                html += '<div class="section-header">Signature Pizzas</div>';
            }
            
            // Get items from database or use demo
            var items = getItemsForCategory(categoryId);
            
            items.forEach(function(item) {
                html += '<div class="menu-item" data-action="select_item" data-value="' + item.id + '">' +
                    '<img src="' + item.image + '" onerror="this.src=\'https://placehold.co/400x160/1a1a2e/25D366?text=' + encodeURIComponent(item.name) + '\'">' +
                    '<div class="body">' +
                    '<div class="name">' + item.name + '</div>' +
                    '<div class="desc">' + item.desc + '</div>' +
                    '<div class="price">From $' + item.price.toFixed(2) + '</div>' +
                    '<div class="size-note">Available in S, M, L, XL</div>' +
                    '</div>' +
                    '</div>';
            });
            
            render(html);
        }
        
        // Demo items for categories
        function getItemsForCategory(categoryId) {
            var items = {
                'pizza': [
                    { id: 'p1', name: 'Pepperoni Classic', desc: 'Pepperoni, mozzarella, signature sauce', price: 14.99, image: 'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400&h=200&fit=crop' },
                    { id: 'p2', name: 'Meat Lovers', desc: 'Pepperoni, sausage, bacon, ham, beef', price: 18.99, image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop' },
                    { id: 'p3', name: 'Hawaiian', desc: 'Ham, pineapple, mozzarella', price: 15.99, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop' },
                    { id: 'p4', name: 'Veggie Supreme', desc: 'Mushrooms, peppers, onions, olives, tomatoes', price: 16.99, image: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400&h=200&fit=crop' },
                    { id: 'p5', name: 'BBQ Chicken', desc: 'Grilled chicken, BBQ sauce, red onions', price: 17.99, image: 'https://images.unsplash.com/photo-1593560708920-61dd98c46a4e?w=400&h=200&fit=crop' },
                    { id: 'p6', name: 'Canadian', desc: 'Pepperoni, mushrooms, bacon', price: 16.99, image: 'https://images.unsplash.com/photo-1571407970349-bc81e7e96d47?w=400&h=200&fit=crop' }
                ],
                'donair': [
                    { id: 'd1', name: 'Classic Donair', desc: 'Shaved beef, sweet sauce, tomatoes, onions', price: 12.99, image: 'https://images.unsplash.com/photo-1561651823-34feb02250e4?w=400&h=200&fit=crop' },
                    { id: 'd2', name: 'Chicken Donair', desc: 'Grilled chicken, garlic sauce, veggies', price: 13.99, image: 'https://images.unsplash.com/photo-1529006557810-274b9b2fc783?w=400&h=200&fit=crop' }
                ],
                'wings': [
                    { id: 'w1', name: 'Classic Wings', desc: 'Choose your flavor: Hot, Mild, BBQ, Honey Garlic', price: 14.99, image: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400&h=200&fit=crop' },
                    { id: 'w2', name: 'Boneless Wings', desc: 'Crispy boneless bites with your choice of sauce', price: 13.99, image: 'https://images.unsplash.com/photo-1567620832903-9fc6debc209f?w=400&h=200&fit=crop' }
                ],
                'salads': [
                    { id: 's1', name: 'Caesar Salad', desc: 'Romaine, parmesan, croutons, caesar dressing', price: 9.99, image: 'https://images.unsplash.com/photo-1550304943-4f24f54ddde9?w=400&h=200&fit=crop' },
                    { id: 's2', name: 'Greek Salad', desc: 'Tomatoes, cucumbers, feta, olives, red onion', price: 10.99, image: 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=200&fit=crop' }
                ],
                'sides': [
                    { id: 'si1', name: 'Garlic Bread', desc: 'Toasted with garlic butter', price: 4.99, image: 'https://images.unsplash.com/photo-1619535860434-ba1d8fa12536?w=400&h=200&fit=crop' },
                    { id: 'si2', name: 'Fries', desc: 'Crispy golden fries', price: 5.99, image: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400&h=200&fit=crop' }
                ],
                'drinks': [
                    { id: 'dr1', name: 'Pop (Can)', desc: 'Coke, Sprite, Fanta, Ginger Ale', price: 1.99, image: 'https://images.unsplash.com/photo-1581636625402-29b2a704ef13?w=400&h=200&fit=crop' },
                    { id: 'dr2', name: 'Pop (2L)', desc: 'Coke, Sprite, Fanta', price: 3.99, image: 'https://images.unsplash.com/photo-1624552184280-9e9631bbeee9?w=400&h=200&fit=crop' }
                ],
                'combos': [
                    { id: 'c1', name: 'Pizza + Wings Combo', desc: 'Large pizza + 1lb wings + 2L pop', price: 34.99, image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop' },
                    { id: 'c2', name: 'Family Pack', desc: '2 Large pizzas + 2lb wings + 2L pop', price: 49.99, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop' }
                ]
            };
            
            return items[categoryId] || [];
        }
        
        // ============================================
        // HEADER
        // ============================================
        function setHeader(name, initials, status) {
            document.getElementById('headerName').textContent = name;
            document.getElementById('avatar').textContent = initials;
            document.getElementById('headerStatus').textContent = status;
        }
        
        // ============================================
        // ACTIONS
        // ============================================
        function handleAction(action, value) {
            console.log('Action:', action, value);
            
            switch(action) {
                case 'share_location':
                    getLocation();
                    break;
                case 'type_address':
                    showAddressInput();
                    break;
                case 'use_saved_address':
                    // Quick confirmation then go to restaurants
                    var addr = state.customer ? state.customer.address : 'Your location';
                    var confirmHtml = '<div class="bubble">‚úÖ <b>Delivering to:</b><br>' + addr + '</div>';
                    render(confirmHtml);
                    setTimeout(function() {
                        renderPage('restaurants');
                    }, 500);
                    break;
                case 'confirm_address':
                    renderPage('restaurants');
                    break;
                case 'select_restaurant':
                    selectRestaurant(value);
                    break;
                case 'show_specials':
                    renderPage('specials');
                    break;
                case 'show_menu':
                    renderPage('menu');
                    break;
                case 'show_category':
                    state.currentCategory = value;
                    renderPage('category');
                    break;
                case 'select_item':
                    addToCart(value);
                    break;
                case 'add_special':
                    addSpecialToCart(value);
                    break;
                case 'custom_pizza':
                    alert('üé® Custom Pizza Builder\n\nThis will open the pizza customization screen.\n\nComing in next update!');
                    break;
            }
        }
        
        function handleInput(action, value) {
            if (action === 'submit_name') {
                state.customer = state.customer || {};
                state.customer.name = value;
                saveCustomer();
                showAddressPrompt();
            }
            else if (action === 'submit_address') {
                state.customer = state.customer || {};
                state.customer.address = value;
                saveCustomer();
                showAddressConfirm(value);
            }
        }
        
        // ============================================
        // HELPERS
        // ============================================
        function showAddressPrompt() {
            // Check if we have a saved address
            var savedAddress = state.customer ? state.customer.address : null;
            
            var html = '<div class="bubble">' +
                'Nice to meet you, <b>' + state.customer.name + '</b>! üëã<br><br>Where should we deliver?';
            
            if (savedAddress) {
                html += '<div class="buttons">' +
                    '<button class="btn primary" data-action="use_saved_address">üìç ' + savedAddress + '</button>' +
                    '<button class="btn" data-action="share_location">üìç Update with GPS</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è Type New Address</button>' +
                    '</div>';
            } else {
                html += '<div class="buttons">' +
                    '<button class="btn primary" data-action="share_location">üìç Share My Location</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è Type Address</button>' +
                    '</div>';
            }
            
            html += '</div>';
            render(html);
        }
        
        function showAddressInput() {
            // Pre-fill with saved address if available
            var savedAddress = state.customer && state.customer.address ? state.customer.address : '';
            
            var html = '<div class="bubble">üìç Enter your delivery address:</div>' +
                '<div class="input-bubble">' +
                '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" value="' + savedAddress + '" autocomplete="off">' +
                '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                '</div>';
            render(html);
        }
        
        function showAddressConfirm(address) {
            var html = '<div class="bubble">' +
                '‚úÖ <b>Delivering to:</b><br>' + address + '<br><br>' +
                'üöó FREE delivery within 3 km*' +
                '<div class="buttons">' +
                '<button class="btn primary" data-action="confirm_address">‚úì Looks Good!</button>' +
                '<button class="btn" data-action="type_address">‚úèÔ∏è Change</button>' +
                '</div></div>';
            render(html);
        }
        
        function getLocation() {
            var html = '<div class="bubble"><span class="spinner"></span> Finding your exact location...</div>';
            render(html);
            
            if (!navigator.geolocation) {
                setTimeout(function() {
                    var errorHtml = '<div class="bubble">üìç GPS not available on this device.<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                }, 500);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    console.log('GPS Success:', pos.coords.latitude, pos.coords.longitude);
                    reverseGeocode(pos.coords.latitude, pos.coords.longitude);
                },
                function(err) {
                    console.log('GPS Error:', err.message);
                    var errorMsg = 'Could not get location.';
                    if (err.code === 1) {
                        errorMsg = 'Location permission denied.';
                    } else if (err.code === 2) {
                        errorMsg = 'Location unavailable.';
                    } else if (err.code === 3) {
                        errorMsg = 'Location request timed out.';
                    }
                    
                    var errorHtml = '<div class="bubble">üìç ' + errorMsg + '<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }
        
        function reverseGeocode(lat, lng) {
            var url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&addressdetails=1';
            
            console.log('Fetching address from:', url);
            
            fetch(url, {
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(function(res) { 
                    if (!res.ok) throw new Error('Network error');
                    return res.json(); 
                })
                .then(function(data) {
                    console.log('Geocode result:', data);
                    
                    var fullAddress = 'Calgary, AB';
                    
                    if (data && data.address) {
                        var addr = data.address;
                        var houseNum = addr.house_number || '';
                        var street = addr.road || addr.street || addr.pedestrian || addr.footway || '';
                        var city = addr.city || addr.town || addr.village || addr.suburb || 'Calgary';
                        
                        if (houseNum && street) {
                            fullAddress = houseNum + ' ' + street + ', ' + city;
                        } else if (street) {
                            fullAddress = street + ', ' + city;
                        } else if (data.display_name) {
                            // Use first 2-3 parts of display name
                            var parts = data.display_name.split(',');
                            fullAddress = parts.slice(0, 3).join(',').trim();
                        }
                    }
                    
                    console.log('Final address:', fullAddress);
                    
                    state.customer = state.customer || {};
                    state.customer.address = fullAddress;
                    state.customer.lat = lat;
                    state.customer.lng = lng;
                    saveCustomer();
                    showAddressConfirm(fullAddress);
                })
                .catch(function(err) {
                    console.log('Geocode error:', err);
                    // Still save the coordinates even if geocoding fails
                    state.customer = state.customer || {};
                    state.customer.lat = lat;
                    state.customer.lng = lng;
                    
                    // Ask user to type address
                    var errorHtml = '<div class="bubble">üìç Found your location but couldn\'t get street address.<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                });
        }
        
        function selectRestaurant(id) {
            var restaurants = {
                '1': { id: '1', name: 'AB King Pizza', icon: 'üçï' },
                '2': { id: '2', name: 'Burger Barn', icon: 'üçî' },
                '3': { id: '3', name: 'Wing House', icon: 'üçó' },
                '4': { id: '4', name: 'Taco Fiesta', icon: 'üåÆ' },
                '5': { id: '5', name: 'Noodle King', icon: 'üçú' }
            };
            state.restaurant = restaurants[id] || { id: id, name: 'Restaurant' };
            renderPage('restaurant_home');
        }
        
        function addToCart(itemId) {
            // Find item and add to cart
            var allItems = [];
            ['pizza', 'donair', 'wings', 'salads', 'sides', 'drinks', 'combos'].forEach(function(cat) {
                allItems = allItems.concat(getItemsForCategory(cat));
            });
            
            var item = allItems.find(function(i) { return i.id === itemId; });
            if (item) {
                state.cart.push({ id: item.id, name: item.name, price: item.price });
                updateCart();
                alert('‚úÖ Added to cart!\n\n' + item.name + ' - $' + item.price.toFixed(2));
            }
        }
        
        function addSpecialToCart(specialId) {
            var specials = {
                's1': { name: 'Family Feast Deal', price: 39.99 },
                's2': { name: 'Lunch Special', price: 12.99 },
                's3': { name: 'Wing Wednesday', price: 19.99 }
            };
            var special = specials[specialId];
            if (special) {
                state.cart.push({ id: specialId, name: special.name, price: special.price });
                updateCart();
                alert('‚úÖ Added to cart!\n\n' + special.name + ' - $' + special.price.toFixed(2));
            }
        }
        
        // Cart badge click
        cartBadge.addEventListener('click', function() {
            alert('üõí Cart\n\n' + state.cart.map(function(i) {
                return i.name + ' - $' + i.price.toFixed(2);
            }).join('\n') + '\n\n---\nCheckout coming next!');
        });
        
        // ============================================
        // INIT
        // ============================================
        function init() {
            renderPage('welcome', false);
        }
        
        init();
    </script>
</body>
</html>
