<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LocalFirst YYC</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%;
            width: 100%;
            background: #0b141a; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }
        
        .app { 
            width: 100%;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: #0b141a;
            position: relative;
        }
        
        @media (min-width: 481px) {
            .app {
                border-left: 1px solid #2a3942;
                border-right: 1px solid #2a3942;
            }
        }
        
        /* Header */
        .header { 
            background: #075E54; 
            padding: 16px 20px; 
            display: flex; 
            align-items: center; 
            gap: 14px;
            flex-shrink: 0;
        }
        .header .back {
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            display: none;
        }
        .header.has-back .back { display: block; }
        .header .avatar { 
            width: 48px; height: 48px; 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 16px;
        }
        .header .info { flex: 1; }
        .header .name { font-weight: 700; font-size: 22px; }
        .header .status { font-size: 14px; color: #a8d8c8; }
        
        /* Content area */
        .content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
        }
        
        /* Page title */
        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Messages */
        .msg { margin-bottom: 16px; }
        .bubble { 
            padding: 14px 18px; 
            font-size: 16px; 
            line-height: 1.5; 
            border-radius: 16px;
            background: #202c33;
        }
        
        /* Savings banner */
        .banner { 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            border-radius: 16px; 
            padding: 20px; 
            text-align: center; 
            margin-bottom: 20px;
        }
        .banner .big { font-size: 26px; font-weight: 800; }
        .banner .sub { font-size: 14px; margin-top: 6px; opacity: 0.95; }
        
        /* Buttons */
        .buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
        .btn { 
            background: transparent; 
            border: 2px solid #00a884; 
            color: #00a884; 
            padding: 16px 18px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer;
            text-align: center;
        }
        .btn:active { background: rgba(0,168,132,0.15); }
        .btn.primary { background: #00a884; color: white; border: none; }
        .btn.primary:active { background: #008f72; }
        
        /* Restaurant button */
        .restaurant-btn {
            background: #00a884;
            border: none;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .restaurant-btn:active { background: #008f72; }
        .restaurant-btn .icon { font-size: 28px; width: 40px; text-align: center; }
        .restaurant-btn .info { flex: 1; }
        .restaurant-btn .name { font-size: 18px; font-weight: 700; color: white; margin-bottom: 4px; }
        .restaurant-btn .meta { font-size: 13px; color: rgba(255,255,255,0.85); display: flex; gap: 10px; }
        .restaurant-btn .arrow { font-size: 20px; color: rgba(255,255,255,0.7); }
        
        /* Category button */
        .category-btn {
            background: #202c33;
            border: none;
            border-radius: 12px;
            padding: 18px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
        }
        .category-btn:active { background: #2a3a43; }
        .category-btn .icon { font-size: 32px; }
        .category-btn .label { font-size: 17px; font-weight: 600; flex: 1; }
        .category-btn .arrow { font-size: 20px; color: #8696a0; }
        
        /* Menu item card */
        .menu-item {
            background: #202c33;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 14px;
            cursor: pointer;
        }
        .menu-item:active { background: #2a3a43; }
        .menu-item img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        .menu-item .body { padding: 14px; }
        .menu-item .name { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .menu-item .desc { font-size: 13px; color: #8696a0; margin-bottom: 8px; line-height: 1.4; }
        .menu-item .price { font-size: 18px; font-weight: 700; color: #25D366; }
        .menu-item .size-note { font-size: 12px; color: #8696a0; }
        
        /* Custom pizza option */
        .custom-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: none;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 14px;
            cursor: pointer;
            text-align: center;
            width: 100%;
        }
        .custom-btn:active { opacity: 0.9; }
        .custom-btn .icon { font-size: 40px; margin-bottom: 8px; }
        .custom-btn .label { font-size: 18px; font-weight: 700; }
        .custom-btn .sub { font-size: 13px; opacity: 0.9; margin-top: 4px; }
        
        /* Input field */
        .input-bubble {
            background: #202c33;
            border-radius: 12px;
            padding: 14px;
            margin-top: 16px;
        }
        .input-bubble input {
            width: 100%;
            background: #2a3942;
            border: none;
            border-radius: 10px;
            padding: 16px 18px;
            color: white;
            font-size: 17px;
            outline: none;
            margin-bottom: 12px;
        }
        .input-bubble input::placeholder { color: #8696a0; }
        
        /* Section header */
        .section-header {
            font-size: 14px;
            font-weight: 600;
            color: #8696a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 14px;
            padding-left: 4px;
        }
        
        /* Disclaimer */
        .disclaimer {
            font-size: 11px;
            color: #8696a0;
            text-align: center;
            margin-top: 16px;
        }
        
        /* Loading */
        .spinner { 
            width: 20px; height: 20px; 
            border: 2px solid #2a3942; 
            border-top-color: #25D366; 
            border-radius: 50%; 
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Cart badge */
        .cart-badge {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #00a884;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 100;
        }
        .cart-badge:active { background: #008f72; }
        .cart-badge.show { display: block; }
        
        /* Size selection */
        .size-btn {
            background: #202c33;
            border: 2px solid #2a3942;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .size-btn:active { background: #2a3a43; border-color: #00a884; }
        .size-btn .size-label {
            font-size: 18px;
            font-weight: 700;
        }
        .size-btn .size-name {
            font-size: 14px;
            color: #8696a0;
            margin-left: 8px;
        }
        .size-btn .size-price {
            font-size: 18px;
            font-weight: 700;
            color: #25D366;
        }
        .size-btn.popular {
            border-color: #00a884;
            background: rgba(0, 168, 132, 0.1);
        }
        .size-btn.popular .popular-tag {
            background: #00a884;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* Item detail image */
        .item-hero {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .item-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .item-desc {
            font-size: 15px;
            color: #8696a0;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        /* Topping button */
        .topping-btn {
            background: #202c33;
            border: 2px solid #2a3942;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .topping-btn:active { background: #2a3a43; }
        .topping-btn.selected {
            border-color: #25D366;
            background: rgba(37, 211, 102, 0.1);
        }
        .topping-btn .check {
            width: 24px;
            height: 24px;
            border: 2px solid #8696a0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .topping-btn.selected .check {
            background: #25D366;
            border-color: #25D366;
            color: white;
        }
        .topping-btn .topping-name {
            flex: 1;
            margin-left: 12px;
            font-size: 15px;
        }
        .topping-btn .topping-price {
            font-size: 14px;
            color: #8696a0;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header" id="header">
            <div class="back" id="backBtn">‚Üê</div>
            <div class="avatar" id="avatar">LF</div>
            <div class="info">
                <div class="name" id="headerName">LocalFirst YYC</div>
                <div class="status" id="headerStatus">online</div>
            </div>
        </div>
        
        <div class="content" id="content"></div>
        
        <div class="cart-badge" id="cartBadge">üõí View Cart (0) - $0.00</div>
    </div>

    <script>
        // ============================================
        // CONFIG
        // ============================================
        var SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        var db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================================
        // STATE
        // ============================================
        var state = {
            page: 'welcome',
            customer: null,
            restaurant: null,
            menuItems: [],
            categories: [],
            cart: [],
            history: [],
            currentCategory: null,
            selectedItem: null,
            selectedSize: null,
            selectedToppings: [],
            selectedSpecial: null,
            specials: [],
            customPizzaToppings: [],
            tip: 0,
            // Discount tracking
            firstOrderDiscount: isFirstTimeCustomer,
            discountPercent: 10,
            freeDelivery: true,
            orderDiscount: 0,
            // Order tracking
            lastOrders: [],
            codAllowed: true,
            codBlockReason: null,
            selectedPaymentMethod: null,
            displayPaymentMethod: null,
            assignedDriver: null
        };
        
        var params = new URLSearchParams(window.location.search);
        var hasPromo = params.has('promo');
        var isFirstTimeCustomer = !localStorage.getItem('localfirst_customer') && !localStorage.getItem('localfirst_first_order_used');
        
        var content = document.getElementById('content');
        var header = document.getElementById('header');
        var cartBadge = document.getElementById('cartBadge');
        
        // ============================================
        // STORAGE
        // ============================================
        function saveCustomer() {
            if (state.customer) {
                localStorage.setItem('localfirst_customer', JSON.stringify(state.customer));
            }
        }
        
        function loadCustomer() {
            var saved = localStorage.getItem('localfirst_customer');
            if (saved) {
                try { state.customer = JSON.parse(saved); return true; } catch(e) {}
            }
            return false;
        }
        
        // ============================================
        // ORDER TRACKING - DATABASE
        // ============================================
        
        // Save order to database
        function saveOrderToDatabase(orderData) {
            var customer = state.customer || {};
            
            var order = {
                order_number: orderData.orderNumber,
                customer_name: customer.name || 'Guest',
                customer_phone: customer.phone || null,
                customer_address: customer.address || null,
                customer_lat: customer.lat || null,
                customer_lng: customer.lng || null,
                restaurant_id: state.restaurant ? state.restaurant.id : null,
                restaurant_name: state.restaurant ? state.restaurant.name : null,
                items: JSON.stringify(state.cart),
                subtotal: state.cart.reduce(function(s, i) { return s + i.price; }, 0),
                discount: orderData.discount || 0,
                discount_type: state.firstOrderDiscount ? 'first_order' : null,
                delivery_fee: state.firstOrderDiscount ? 0 : 0, // Currently always free
                tip: state.tip,
                total: orderData.total,
                payment_method: orderData.paymentMethod,
                payment_status: orderData.paymentMethod === 'cash' ? 'pending' : 'paid',
                delivery_status: 'preparing',
                cod_successful: null, // Will be updated after delivery
                created_at: new Date().toISOString()
            };
            
            console.log('Saving order to database:', order);
            
            // Save to Supabase
            db.from('orders').insert([order]).then(function(res) {
                console.log('Order saved:', res);
                if (res.error) {
                    console.error('Error saving order:', res.error);
                }
            }).catch(function(err) {
                console.error('Failed to save order:', err);
            });
            
            // Also save locally
            var localOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]');
            localOrders.push(order);
            localStorage.setItem('localfirst_orders', JSON.stringify(localOrders.slice(-20))); // Keep last 20
            
            return order;
        }
        
        // Load customer's order history
        function loadCustomerHistory() {
            var customer = state.customer;
            if (!customer || !customer.name) return;
            
            // Load from local storage first (faster)
            var localOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]');
            state.lastOrders = localOrders.filter(function(o) {
                return o.customer_name === customer.name || o.customer_address === customer.address;
            });
            
            // Check COD eligibility
            checkCODEligibility();
            
            // Also try to load from database
            db.from('orders')
                .select('*')
                .or('customer_name.eq.' + customer.name + ',customer_address.eq.' + customer.address)
                .order('created_at', { ascending: false })
                .limit(10)
                .then(function(res) {
                    if (res.data && res.data.length > 0) {
                        state.lastOrders = res.data;
                        checkCODEligibility();
                        console.log('Loaded customer history:', res.data);
                    }
                }).catch(function(err) {
                    console.log('Could not load history from DB:', err);
                });
        }
        
        // Check if customer is eligible for COD
        function checkCODEligibility() {
            state.codAllowed = true;
            state.codBlockReason = null;
            
            if (!state.lastOrders || state.lastOrders.length === 0) {
                return; // New customer, allow COD
            }
            
            // Check for failed COD payments
            var failedCOD = state.lastOrders.filter(function(o) {
                return o.payment_method === 'cash' && o.cod_successful === false;
            });
            
            if (failedCOD.length > 0) {
                state.codAllowed = false;
                state.codBlockReason = 'Previous cash payment was unsuccessful. Please use card payment.';
                console.log('COD blocked - failed payment history');
                return;
            }
            
            // Check for pending COD (unpaid)
            var pendingCOD = state.lastOrders.filter(function(o) {
                return o.payment_method === 'cash' && o.payment_status === 'pending';
            });
            
            if (pendingCOD.length >= 2) {
                state.codAllowed = false;
                state.codBlockReason = 'Too many pending cash payments. Please use card payment.';
                console.log('COD blocked - too many pending');
            }
        }
        
        // Mark COD order as successful or failed (called by driver/admin)
        function updateCODStatus(orderNumber, successful) {
            // Update in database
            db.from('orders')
                .update({ 
                    cod_successful: successful,
                    payment_status: successful ? 'paid' : 'failed'
                })
                .eq('order_number', orderNumber)
                .then(function(res) {
                    console.log('COD status updated:', res);
                }).catch(function(err) {
                    console.error('Failed to update COD status:', err);
                });
            
            // Update locally
            var localOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]');
            localOrders.forEach(function(o) {
                if (o.order_number === orderNumber) {
                    o.cod_successful = successful;
                    o.payment_status = successful ? 'paid' : 'failed';
                }
            });
            localStorage.setItem('localfirst_orders', JSON.stringify(localOrders));
        }
        
        // DEMO: Simulate a failed COD to test blocking
        // Call this from console: simulateFailedCOD()
        window.simulateFailedCOD = function() {
            var customer = state.customer || { name: 'Test User', address: 'Test Address' };
            var fakeOrder = {
                order_number: 'LF-FAKE-' + Date.now(),
                customer_name: customer.name,
                customer_address: customer.address,
                restaurant_name: 'Test Restaurant',
                payment_method: 'cash',
                payment_status: 'failed',
                cod_successful: false,
                total: 25.99,
                created_at: new Date().toISOString()
            };
            
            var localOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]');
            localOrders.push(fakeOrder);
            localStorage.setItem('localfirst_orders', JSON.stringify(localOrders));
            
            state.lastOrders = localOrders;
            checkCODEligibility();
            
            console.log('Simulated failed COD. COD allowed:', state.codAllowed);
            alert('Failed COD simulated!\n\nCOD now blocked: ' + (state.codAllowed ? 'No' : 'Yes') + '\n\nGo to payment page to see the blocked COD option.');
        };
        
        // DEMO: Reset COD status
        window.resetCODStatus = function() {
            localStorage.removeItem('localfirst_orders');
            state.lastOrders = [];
            state.codAllowed = true;
            state.codBlockReason = null;
            console.log('COD status reset');
            alert('COD status reset!\n\nCOD is now allowed again.');
        };
        
        // DEMO: View order history
        window.viewOrderHistory = function() {
            var localOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]');
            console.table(localOrders);
            return localOrders;
        };
        
        // DEMO: View saved customer data
        window.viewCustomer = function() {
            var customer = JSON.parse(localStorage.getItem('localfirst_customer') || 'null');
            console.log('=== Saved Customer ===');
            console.log('Name:', customer ? customer.name : 'none');
            console.log('Address:', customer ? customer.address : 'none');
            console.log('Phone:', customer ? customer.phone : 'none');
            console.log('Lat/Lng:', customer ? (customer.lat + ', ' + customer.lng) : 'none');
            console.log('Full data:', customer);
            return customer;
        };
        
        // DEMO: Reset everything (fresh start)
        window.resetEverything = function() {
            localStorage.removeItem('localfirst_customer');
            localStorage.removeItem('localfirst_orders');
            localStorage.removeItem('localfirst_first_order_used');
            state.customer = null;
            state.lastOrders = [];
            state.codAllowed = true;
            state.codBlockReason = null;
            state.firstOrderDiscount = true;
            console.log('Everything reset! Refresh the page.');
            alert('Everything reset!\n\nRefresh the page to see the new customer welcome screen with discount.');
            location.reload();
        };
        
        // ============================================
        // DELIVERY MODULE
        // ============================================
        var deliveryState = {
            mode: 'customer', // 'customer' or 'driver'
            activeOrders: [],
            driverLocation: { lat: 51.0447, lng: -114.0719 },
            deliveryStatus: 'pending' // 'pending', 'preparing', 'picked_up', 'arriving', 'delivered'
        };
        
        // Demo drivers for assignment
        var availableDrivers = [
            { id: 'd1', name: 'Ahmed', phone: '14035551001', vehicle: 'Honda Civic', rating: 4.9, available: true, 
              location: { lat: 51.0450, lng: -114.0700 }, story: "Delivering for LocalFirst YYC", image: 'data:image/jpeg;base64,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' },
            { id: 'd2', name: 'Priya Sharma', phone: '14035551002', vehicle: 'Toyota Corolla', rating: 4.8, available: true,
              location: { lat: 51.0440, lng: -114.0750 }, story: "Working to support my family back home" },
            { id: 'd3', name: 'Marcus Williams', phone: '14035551003', vehicle: 'Ford Focus', rating: 4.7, available: false,
              location: { lat: 51.0460, lng: -114.0680 }, story: "Saving up to start my own business" }
        ];
        
        // DEMO: Switch to driver mode
        window.driverMode = function() {
            deliveryState.mode = 'driver';
            console.log('üöó Switched to DRIVER MODE');
            showDriverDashboard();
        };
        
        // DEMO: Switch to customer mode
        window.customerMode = function() {
            deliveryState.mode = 'customer';
            console.log('üë§ Switched to CUSTOMER MODE');
            renderPage('welcome');
        };
        
        // DEMO: Simulate order flow
        window.simulateDelivery = function() {
            if (!state.orderNumber) {
                console.log('No active order. Place an order first!');
                alert('No active order!\n\nPlace an order first, then run simulateDelivery()');
                return;
            }
            
            console.log('üöÄ Starting delivery simulation for order', state.orderNumber);
            
            // Step 1: Preparing (immediate)
            setTimeout(function() {
                deliveryState.deliveryStatus = 'preparing';
                console.log('üë®‚Äçüç≥ Order is being prepared...');
                updateDeliveryUI();
            }, 1000);
            
            // Step 2: Driver picked up (5 seconds)
            setTimeout(function() {
                deliveryState.deliveryStatus = 'picked_up';
                console.log('üöó Driver has picked up the order!');
                updateDeliveryUI();
            }, 5000);
            
            // Step 3: Arriving (10 seconds)
            setTimeout(function() {
                deliveryState.deliveryStatus = 'arriving';
                console.log('üìç Driver is arriving soon!');
                updateDeliveryUI();
            }, 10000);
            
            // Step 4: Delivered (15 seconds)
            setTimeout(function() {
                deliveryState.deliveryStatus = 'delivered';
                console.log('‚úÖ Order delivered!');
                updateDeliveryUI();
            }, 15000);
        };
        
        // Show driver dashboard
        function showDriverDashboard() {
            setHeader('Driver Dashboard', 'üöó', 'online');
            
            var pendingOrders = JSON.parse(localStorage.getItem('localfirst_orders') || '[]')
                .filter(function(o) { return o.delivery_status !== 'delivered'; })
                .slice(-5);
            
            var html = '<div style="padding: 10px 0;">';
            
            // Driver status toggle
            html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">' +
                '<div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">DRIVER STATUS</div>' +
                '<div style="font-size: 24px; font-weight: 800;">üü¢ ONLINE</div>' +
                '<div style="font-size: 13px; margin-top: 8px;">Ready to accept orders</div>' +
                '</div>';
            
            // Stats
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px; text-align: center;">' +
                '<div style="font-size: 24px; font-weight: 700; color: #25D366;">$127</div>' +
                '<div style="font-size: 11px; color: #8696a0;">Today</div></div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px; text-align: center;">' +
                '<div style="font-size: 24px; font-weight: 700;">8</div>' +
                '<div style="font-size: 11px; color: #8696a0;">Deliveries</div></div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px; text-align: center;">' +
                '<div style="font-size: 24px; font-weight: 700;">‚≠ê 4.9</div>' +
                '<div style="font-size: 11px; color: #8696a0;">Rating</div></div>' +
                '</div>';
            
            // Pending orders
            html += '<div style="font-size: 14px; font-weight: 600; color: #8696a0; margin-bottom: 12px;">üìã AVAILABLE ORDERS</div>';
            
            if (pendingOrders.length === 0) {
                html += '<div style="background: #202c33; border-radius: 12px; padding: 30px; text-align: center;">' +
                    '<div style="font-size: 40px; margin-bottom: 10px;">üïê</div>' +
                    '<div style="font-size: 16px; color: #8696a0;">No orders available</div>' +
                    '<div style="font-size: 13px; color: #8696a0; margin-top: 6px;">New orders will appear here</div>' +
                    '</div>';
            } else {
                pendingOrders.forEach(function(order) {
                    var statusColor = order.delivery_status === 'preparing' ? '#ffaa00' : '#25D366';
                    var statusText = order.delivery_status === 'preparing' ? 'üç≥ Preparing' : 'üì¶ Ready';
                    
                    html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 12px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
                        '<div style="font-size: 18px; font-weight: 700;">#' + order.order_number + '</div>' +
                        '<div style="background: ' + statusColor + '22; color: ' + statusColor + '; padding: 4px 10px; border-radius: 20px; font-size: 12px;">' + statusText + '</div>' +
                        '</div>' +
                        '<div style="font-size: 14px; margin-bottom: 8px;">üçΩÔ∏è ' + (order.restaurant_name || 'Restaurant') + '</div>' +
                        '<div style="font-size: 13px; color: #8696a0; margin-bottom: 8px;">üìç ' + (order.customer_address || 'Address') + '</div>' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="font-size: 16px; font-weight: 700; color: #25D366;">$' + (order.total || 0).toFixed(2);
                    
                    if (order.payment_method === 'cash') {
                        html += ' <span style="background: #ffaa0033; color: #ffaa00; padding: 2px 8px; border-radius: 10px; font-size: 11px;">COD</span>';
                    }
                    
                    html += '</div>' +
                        '<button class="btn primary" style="padding: 8px 16px; font-size: 13px;" data-action="accept_order" data-value="' + order.order_number + '">Accept</button>' +
                        '</div></div>';
                });
            }
            
            // Back to customer mode
            html += '<div style="margin-top: 20px; text-align: center;">' +
                '<button class="btn" data-action="switch_to_customer" style="background: #2a3942;">‚Üê Back to Customer View</button>' +
                '</div>';
            
            html += '</div>';
            render(html);
        }
        
        // Update delivery tracking UI
        function updateDeliveryUI() {
            if (state.page === 'confirmed' || state.page === 'tracking') {
                // Re-render if on tracking page
                if (deliveryState.deliveryStatus === 'delivered') {
                    showDeliveryComplete();
                }
            }
        }
        
        // Show delivery complete
        function showDeliveryComplete() {
            var html = '<div style="text-align: center; padding: 40px 0;">' +
                '<div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>' +
                '<div style="font-size: 28px; font-weight: 800; color: #25D366; margin-bottom: 10px;">Delivered!</div>' +
                '<div style="font-size: 16px; color: #8696a0; margin-bottom: 30px;">Enjoy your meal!</div>' +
                '</div>';
            
            html += '<div style="background: linear-gradient(135deg, #1a3020, #0d2010); border: 1px solid #25D366; border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 20px;">' +
                '<div style="font-size: 16px; font-weight: 600; color: #25D366; margin-bottom: 12px;">Rate your experience</div>' +
                '<div style="font-size: 32px; letter-spacing: 8px;" data-action="rate_order">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>' +
                '</div>';
            
            html += '<div class="buttons">' +
                '<button class="btn primary" data-action="new_order" style="font-size: 16px;">Order Again üçï</button>' +
                '</div>';
            
            render(html);
        }
        
        // DEMO: Show broadcast message composer
        window.showBroadcast = function() {
            console.log('üì¢ Opening broadcast message composer...');
            showBroadcastComposer();
        };
        
        // Broadcast message composer
        function showBroadcastComposer() {
            setHeader('üì¢ Broadcast', 'BC', 'online');
            
            // Get all customers
            var customers = JSON.parse(localStorage.getItem('localfirst_orders') || '[]')
                .reduce(function(acc, order) {
                    if (order.customer_phone && !acc.find(function(c) { return c.phone === order.customer_phone; })) {
                        acc.push({ name: order.customer_name, phone: order.customer_phone });
                    }
                    return acc;
                }, []);
            
            var html = '<div style="padding: 10px 0;">';
            
            html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">üì¢ Weekly Special Broadcast</div>' +
                '<div style="font-size: 13px; opacity: 0.9;">Send promotions to all customers via WhatsApp</div>' +
                '</div>';
            
            // Stats
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-size: 14px; color: #8696a0; margin-bottom: 8px;">Audience</div>' +
                '<div style="font-size: 24px; font-weight: 700;">' + customers.length + ' customers</div>' +
                '<div style="font-size: 12px; color: #8696a0;">with saved phone numbers</div>' +
                '</div>';
            
            // Message templates
            html += '<div style="font-size: 14px; font-weight: 600; color: #8696a0; margin-bottom: 12px;">üìù MESSAGE TEMPLATES</div>';
            
            var templates = [
                { id: 'weekly', title: 'üçï Weekly Special', preview: 'This week only! Get 20% off all pizzas...' },
                { id: 'flash', title: '‚ö° Flash Sale', preview: 'FREE delivery for the next 2 hours...' },
                { id: 'loyalty', title: 'üíö Loyalty Reward', preview: 'Thanks for being a LocalFirst customer...' },
                { id: 'new', title: 'üÜï New Restaurant', preview: 'We just added a new restaurant...' }
            ];
            
            templates.forEach(function(t) {
                html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer;" data-action="select_template" data-value="' + t.id + '">' +
                    '<div style="font-size: 15px; font-weight: 600; margin-bottom: 6px;">' + t.title + '</div>' +
                    '<div style="font-size: 13px; color: #8696a0;">' + t.preview + '</div>' +
                    '</div>';
            });
            
            // Custom message
            html += '<div style="margin-top: 20px;">' +
                '<div style="font-size: 14px; font-weight: 600; color: #8696a0; margin-bottom: 12px;">‚úèÔ∏è OR WRITE CUSTOM MESSAGE</div>' +
                '<textarea id="broadcast_message" style="width: 100%; height: 100px; background: #202c33; border: 1px solid #2a3942; border-radius: 12px; padding: 12px; color: #e9edef; font-size: 14px; resize: none;" placeholder="Type your message here..."></textarea>' +
                '<button class="btn primary" style="width: 100%; margin-top: 12px;" data-action="send_broadcast">üì§ Send to All Customers</button>' +
                '</div>';
            
            html += '<div style="margin-top: 20px; text-align: center;">' +
                '<button class="btn" data-action="back_to_customer" style="background: #2a3942;">‚Üê Back</button>' +
                '</div>';
            
            html += '</div>';
            render(html);
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function navigate(page, addToHistory) {
            if (addToHistory !== false && state.page) {
                state.history.push(state.page);
            }
            state.page = page;
            header.className = state.history.length > 0 ? 'header has-back' : 'header';
        }
        
        function goBack() {
            if (state.history.length > 0) {
                var prevPage = state.history.pop();
                renderPage(prevPage, false);
            }
        }
        
        document.getElementById('backBtn').addEventListener('click', goBack);
        
        // ============================================
        // RENDER HELPERS
        // ============================================
        function render(html) {
            content.innerHTML = html;
            attachListeners();
            content.scrollTop = 0;
        }
        
        function attachListeners() {
            content.querySelectorAll('[data-action]').forEach(function(el) {
                el.addEventListener('click', function() {
                    handleAction(this.getAttribute('data-action'), this.getAttribute('data-value'));
                });
            });
            
            content.querySelectorAll('.input-submit').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var inputId = this.getAttribute('data-input');
                    var action = this.getAttribute('data-action');
                    var input = document.getElementById(inputId);
                    if (input && input.value.trim()) {
                        handleInput(action, input.value.trim());
                    }
                });
            });
            
            // Special handler for combined name+phone form
            var customerBtn = document.getElementById('submit_customer_btn');
            if (customerBtn) {
                customerBtn.addEventListener('click', function() {
                    var nameInput = document.getElementById('name_input');
                    var phoneInput = document.getElementById('phone_input');
                    var name = nameInput ? nameInput.value.trim() : '';
                    var phone = phoneInput ? phoneInput.value.trim().replace(/\D/g, '') : '';
                    
                    if (!name) {
                        nameInput.focus();
                        nameInput.style.border = '2px solid #ff6b6b';
                        return;
                    }
                    if (!phone || phone.length < 10) {
                        phoneInput.focus();
                        phoneInput.style.border = '2px solid #ff6b6b';
                        phoneInput.placeholder = 'Please enter valid phone';
                        return;
                    }
                    
                    // Save customer with real phone
                    state.customer = state.customer || {};
                    state.customer.name = name;
                    state.customer.phone = phone.length === 10 ? '1' + phone : phone;
                    console.log('üì± Real customer phone:', state.customer.phone);
                    saveCustomer();
                    showAddressPrompt();
                });
            }
            
            content.querySelectorAll('input').forEach(function(inp) {
                inp.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        // If name+phone form, handle specially
                        var customerBtn = document.getElementById('submit_customer_btn');
                        if (customerBtn && (inp.id === 'name_input' || inp.id === 'phone_input')) {
                            if (inp.id === 'name_input') {
                                // Move to phone field
                                var phoneInput = document.getElementById('phone_input');
                                if (phoneInput) phoneInput.focus();
                            } else {
                                // Submit the form
                                customerBtn.click();
                            }
                        } else {
                            var btn = content.querySelector('.input-submit');
                            if (btn) btn.click();
                        }
                    }
                });
            });
            
            // Focus first input, or name_input specifically
            var firstInput = document.getElementById('name_input') || content.querySelector('input');
            if (firstInput) setTimeout(function() { firstInput.focus(); }, 100);
        }
        
        function updateCart() {
            var count = state.cart.length;
            var total = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            cartBadge.textContent = 'üõí View Cart (' + count + ') - $' + total.toFixed(2);
            cartBadge.className = count > 0 ? 'cart-badge show' : 'cart-badge';
        }
        
        // ============================================
        // PAGES
        // ============================================
        function renderPage(page, addToHistory) {
            navigate(page, addToHistory);
            
            switch(page) {
                case 'welcome': showWelcome(); break;
                case 'restaurants': showRestaurants(); break;
                case 'restaurant_home': showRestaurantHome(); break;
                case 'specials': showSpecials(); break;
                case 'special_detail': showSpecialDetail(); break;
                case 'menu': showMenu(); break;
                case 'category': showCategory(state.currentCategory); break;
                case 'item_detail': showItemDetail(); break;
                case 'item_toppings': showToppingsPage(); break;
                case 'item_added': showItemAdded(); break;
                case 'cart': showCartPage(); break;
                case 'tip': showTipPage(); break;
                case 'payment': showPaymentPage(); break;
                case 'credit_cards': showCreditCardPage(); break;
                case 'confirmed': showConfirmedPage(); break;
                case 'custom_pizza': showCustomPizzaPage(); break;
                case 'custom_pizza_size': showCustomPizzaSizePage(); break;
            }
        }
        
        // PAGE: Welcome
        function showWelcome() {
            setHeader('LocalFirst YYC', 'LF', 'online');
            
            var html = '';
            var isReturningCustomer = loadCustomer() && state.customer.name;
            
            // Debug: Log what's saved
            console.log('=== Welcome Page Debug ===');
            console.log('Is returning customer:', isReturningCustomer);
            console.log('Customer data:', state.customer);
            console.log('Saved address:', state.customer ? state.customer.address : 'none');
            console.log('========================');
            
            if (isReturningCustomer) {
                // Returning customer - show their info (from WhatsApp)
                var savedAddr = state.customer.address || 'Not set yet';
                var phone = state.customer.phone || state.customer.whatsapp_phone || '';
                var displayPhone = phone ? formatPhone(phone) : '';
                
                html += '<div style="text-align: center; padding: 20px 0;">' +
                    '<div style="font-size: 50px; margin-bottom: 10px;">üëã</div>' +
                    '<div style="font-size: 24px; font-weight: 700;">Welcome back,</div>' +
                    '<div style="font-size: 28px; font-weight: 800; color: #25D366;">' + state.customer.name + '!</div>' +
                    '</div>';
                
                // Show their WhatsApp info card
                html += '<div style="background: #202c33; border-radius: 16px; padding: 16px; margin-bottom: 16px;">' +
                    '<div style="font-size: 12px; color: #8696a0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">üì± Your WhatsApp Account</div>' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700;">' + 
                    (state.customer.name ? state.customer.name.charAt(0).toUpperCase() : '?') + '</div>' +
                    '<div style="flex: 1;">' +
                    '<div style="font-size: 16px; font-weight: 600;">' + state.customer.name + '</div>' +
                    '<div style="font-size: 14px; color: #25D366;">' + displayPhone + '</div>' +
                    '</div>' +
                    '<div style="font-size: 20px;">‚úì</div>' +
                    '</div>' +
                    '</div>';
                
                // Delivery address card
                html += '<div style="background: #202c33; border-radius: 16px; padding: 16px; margin-bottom: 20px;">' +
                    '<div style="font-size: 12px; color: #8696a0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">üìç Delivery Address</div>' +
                    '<div style="font-size: 16px; margin-bottom: 16px;">' + savedAddr + '</div>' +
                    '<div class="buttons">' +
                    '<button class="btn primary" data-action="use_saved_address">‚úì Deliver Here</button>' +
                    '<button class="btn" data-action="share_location">üìç Update Location</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è New Address</button>' +
                    '</div></div>';
            } else {
                // NEW CUSTOMER - Show compelling welcome with discount
                
                // Hero section with logo
                html += '<div style="text-align: center; padding: 10px 0 20px;">' +
                    '<div style="font-size: 60px; margin-bottom: 10px;">üçï</div>' +
                    '<div style="font-size: 28px; font-weight: 800; color: #25D366;">LocalFirst YYC</div>' +
                    '<div style="font-size: 14px; color: #8696a0; margin-top: 4px;">Support Local. Eat Amazing.</div>' +
                    '</div>';
                
                // First order discount banner
                html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">' +
                    '<div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9; margin-bottom: 8px;">üéâ First Order Special</div>' +
                    '<div style="font-size: 32px; font-weight: 800; margin-bottom: 6px;">FREE DELIVERY</div>' +
                    '<div style="font-size: 16px; opacity: 0.95;">+ 10% OFF your first order!</div>' +
                    '<div style="font-size: 13px; margin-top: 10px; opacity: 0.8;">Save up to $8.99 today</div>' +
                    '</div>';
                
                // Why LocalFirst
                html += '<div style="background: #202c33; border-radius: 16px; padding: 18px; margin-bottom: 20px;">' +
                    '<div style="font-size: 14px; font-weight: 600; color: #25D366; margin-bottom: 14px; text-align: center;">Why Order with LocalFirst?</div>' +
                    '<div style="display: flex; flex-direction: column; gap: 12px;">' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 24px;">üíö</div>' +
                    '<div style="font-size: 13px; color: #e9edef;"><b>100% Local</b> ‚Äî Every dollar stays in Calgary</div>' +
                    '</div>' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 24px;">üë©‚Äçüç≥</div>' +
                    '<div style="font-size: 13px; color: #e9edef;"><b>Real Stories</b> ‚Äî Meet the families behind the food</div>' +
                    '</div>' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<div style="font-size: 24px;">üöó</div>' +
                    '<div style="font-size: 13px; color: #e9edef;"><b>Fair Pay</b> ‚Äî Drivers keep 100% of tips</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
                
                // Name and phone input
                html += '<div style="background: #202c33; border-radius: 16px; padding: 20px;">' +
                    '<div style="font-size: 15px; color: #e9edef; margin-bottom: 14px; text-align: center;">Let\'s get started!</div>' +
                    '<div class="input-bubble" style="margin: 0 0 12px 0;">' +
                    '<input type="text" id="name_input" placeholder="Your first name" autocomplete="given-name" style="font-size: 18px; text-align: center;">' +
                    '</div>' +
                    '<div class="input-bubble" style="margin: 0 0 12px 0;">' +
                    '<input type="tel" id="phone_input" placeholder="Your phone (403) 555-1234" autocomplete="tel" style="font-size: 18px; text-align: center;">' +
                    '</div>' +
                    '<button class="btn primary" id="submit_customer_btn" style="font-size: 16px; width: 100%;">Get My Discount ‚Üí</button>' +
                    '<div style="font-size: 11px; color: #8696a0; text-align: center; margin-top: 14px; line-height: 1.5;">' +
                    'üîí Your info is only used for delivery updates' +
                    '</div>' +
                    '</div>';
            }
            
            render(html);
        }
        
        // PAGE: Restaurants
        function showRestaurants() {
            var restaurants = [
                { id: '1', icon: 'üçï', name: 'AB King Pizza', rating: '4.8', distance: '0.8 km', time: '25 min' },
                { id: '2', icon: 'üçî', name: 'Burger Barn', rating: '4.7', distance: '1.2 km', time: '30 min' },
                { id: '3', icon: 'üçó', name: 'Wing House', rating: '4.6', distance: '1.5 km', time: '35 min' },
                { id: '4', icon: 'üåÆ', name: 'Taco Fiesta', rating: '4.5', distance: '2.0 km', time: '35 min' },
                { id: '5', icon: 'üçú', name: 'Noodle King', rating: '4.7', distance: '2.2 km', time: '40 min' }
            ];
            
            var html = '<div class="page-title">üçΩÔ∏è Restaurants Near You</div>';
            
            restaurants.forEach(function(r) {
                html += '<div class="restaurant-btn" data-action="select_restaurant" data-value="' + r.id + '">' +
                    '<div class="icon">' + r.icon + '</div>' +
                    '<div class="info">' +
                    '<div class="name">' + r.name + '</div>' +
                    '<div class="meta"><span>‚≠ê ' + r.rating + '</span><span>üìç ' + r.distance + '</span><span>üïê ' + r.time + '</span></div>' +
                    '</div>' +
                    '<div class="arrow">‚Ä∫</div>' +
                    '</div>';
            });
            
            html += '<div class="disclaimer">*FREE delivery within 3 km. $2.99 for 3-5 km.</div>';
            
            render(html);
        }
        
        // PAGE: Restaurant Home (Specials vs Menu)
        function showRestaurantHome() {
            setHeader(state.restaurant.name, state.restaurant.name.substring(0,2), 'online');
            
            // Get delivery time from restaurant data or default
            var deliveryTime = state.restaurant.time || '30-40 min';
            
            var html = '<div class="bubble" style="text-align: center; margin-bottom: 20px;">' +
                'üëã Welcome to <b style="font-size: 20px;">' + state.restaurant.name + '</b>!<br>' +
                'üöó FREE delivery* ‚Ä¢ üïê ~' + deliveryTime +
                '</div>';
            
            html += '<div class="section-header" style="font-size: 16px;">üî• TODAY\'S SPECIALS</div>';
            html += '<div class="category-btn" data-action="show_specials" style="padding: 20px;">' +
                '<div class="icon" style="font-size: 36px;">‚≠ê</div>' +
                '<div class="label" style="font-size: 19px;">Special of the Day</div>' +
                '<div class="arrow">‚Ä∫</div>' +
                '</div>';
            
            html += '<div class="section-header">üìã FULL MENU</div>';
            html += '<div class="category-btn" data-action="show_menu">' +
                '<div class="icon">üìñ</div>' +
                '<div class="label">Browse Menu</div>' +
                '<div class="arrow">‚Ä∫</div>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Specials
        function showSpecials() {
            var html = '<div class="page-title">‚≠ê Today\'s Specials</div>';
            
            // 3 special items with images - using green/teal theme instead of orange
            var specials = [
                { 
                    id: 's1',
                    tag: 'üî• Most Popular', 
                    name: 'Family Feast Deal', 
                    desc: '2 Large Pizzas + Wings + 2L Pop',
                    oldPrice: 54.99,
                    newPrice: 39.99,
                    image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop'
                },
                { 
                    id: 's2',
                    tag: '‚ö° Limited Time', 
                    name: 'Lunch Special', 
                    desc: 'Medium 2-Topping Pizza + Can Pop',
                    oldPrice: 18.99,
                    newPrice: 12.99,
                    image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop'
                },
                { 
                    id: 's3',
                    tag: '‚ù§Ô∏è Customer Favorite', 
                    name: 'Wing Wednesday', 
                    desc: '2 lbs Wings + Fries + Dip',
                    oldPrice: 28.99,
                    newPrice: 19.99,
                    image: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400&h=200&fit=crop'
                }
            ];
            
            // Store specials in state for later use
            state.specials = specials;
            
            specials.forEach(function(s) {
                html += '<div class="menu-item" data-action="view_special" data-value="' + s.id + '">' +
                    '<img src="' + s.image + '" onerror="this.src=\'https://placehold.co/400x160/1a1a2e/25D366?text=' + encodeURIComponent(s.name) + '\'">' +
                    '<div class="body">' +
                    '<div style="display: inline-block; background: #25D366; color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; margin-bottom: 8px;">' + s.tag + '</div>' +
                    '<div class="name">' + s.name + '</div>' +
                    '<div class="desc">' + s.desc + '</div>' +
                    '<div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">' +
                    '<span style="font-size: 14px; text-decoration: line-through; color: #8696a0;">$' + s.oldPrice.toFixed(2) + '</span>' +
                    '<span style="font-size: 20px; font-weight: 800; color: #25D366;">$' + s.newPrice.toFixed(2) + '</span>' +
                    '<span style="background: #25D366; color: white; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 10px;">SAVE $' + (s.oldPrice - s.newPrice).toFixed(0) + '</span>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            });
            
            html += '<div class="buttons" style="margin-top: 20px;">' +
                '<button class="btn" data-action="show_menu">üìã View Full Menu</button>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: View Special Detail
        function showSpecialDetail() {
            var special = state.selectedSpecial;
            if (!special) {
                renderPage('specials');
                return;
            }
            
            var html = '<img class="item-hero" src="' + special.image + '" onerror="this.src=\'https://placehold.co/400x200/1a1a2e/25D366?text=' + encodeURIComponent(special.name) + '\'">' +
                '<div style="display: inline-block; background: #25D366; color: white; font-size: 12px; font-weight: 700; padding: 5px 12px; border-radius: 20px; margin-bottom: 12px;">' + special.tag + '</div>' +
                '<div class="item-title">' + special.name + '</div>' +
                '<div class="item-desc">' + special.desc + '</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="display: flex; align-items: center; justify-content: space-between;">' +
                '<div>' +
                '<div style="font-size: 14px; text-decoration: line-through; color: #8696a0;">Regular: $' + special.oldPrice.toFixed(2) + '</div>' +
                '<div style="font-size: 28px; font-weight: 800; color: #25D366;">$' + special.newPrice.toFixed(2) + '</div>' +
                '</div>' +
                '<div style="background: #25D366; color: white; padding: 10px 16px; border-radius: 12px; text-align: center;">' +
                '<div style="font-size: 11px;">YOU SAVE</div>' +
                '<div style="font-size: 20px; font-weight: 800;">$' + (special.oldPrice - special.newPrice).toFixed(2) + '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="buttons">' +
                '<button class="btn primary" data-action="add_special_to_cart" data-value="' + special.id + '">üõí Add to Cart - $' + special.newPrice.toFixed(2) + '</button>' +
                '<button class="btn" data-action="show_specials">‚Üê Back to Specials</button>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Menu Categories
        function showMenu() {
            var html = '<div class="page-title">üìã Menu</div>';
            
            var categories = [
                { id: 'pizza', icon: 'üçï', name: 'Pizza' },
                { id: 'donair', icon: 'üåØ', name: 'Donair' },
                { id: 'wings', icon: 'üçó', name: 'Wings' },
                { id: 'salads', icon: 'ü•ó', name: 'Salads' },
                { id: 'sides', icon: 'üçü', name: 'Sides' },
                { id: 'drinks', icon: 'ü•§', name: 'Drinks' },
                { id: 'combos', icon: 'üéÅ', name: 'Combos' }
            ];
            
            categories.forEach(function(cat) {
                html += '<div class="category-btn" data-action="show_category" data-value="' + cat.id + '">' +
                    '<div class="icon">' + cat.icon + '</div>' +
                    '<div class="label">' + cat.name + '</div>' +
                    '<div class="arrow">‚Ä∫</div>' +
                    '</div>';
            });
            
            render(html);
        }
        
        // PAGE: Category Items (e.g., Pizza)
        function showCategory(categoryId) {
            state.currentCategory = categoryId;
            
            var categoryNames = {
                'pizza': 'Pizza',
                'donair': 'Donair',
                'wings': 'Wings',
                'salads': 'Salads',
                'sides': 'Sides',
                'drinks': 'Drinks',
                'combos': 'Combos'
            };
            
            var html = '<div class="page-title">üçï ' + (categoryNames[categoryId] || 'Menu') + '</div>';
            
            // Custom option for pizza
            if (categoryId === 'pizza') {
                html += '<div class="custom-btn" data-action="custom_pizza">' +
                    '<div class="icon">üé®</div>' +
                    '<div class="label">Build Your Own Pizza</div>' +
                    '<div class="sub">Choose your toppings</div>' +
                    '</div>';
                
                html += '<div class="section-header">Signature Pizzas</div>';
            }
            
            // Get items from database or use demo
            var items = getItemsForCategory(categoryId);
            
            items.forEach(function(item) {
                html += '<div class="menu-item" data-action="select_item" data-value="' + item.id + '">' +
                    '<img src="' + item.image + '" onerror="this.src=\'https://placehold.co/400x160/1a1a2e/25D366?text=' + encodeURIComponent(item.name) + '\'">' +
                    '<div class="body">' +
                    '<div class="name">' + item.name + '</div>' +
                    '<div class="desc">' + item.desc + '</div>' +
                    '<div class="price">From $' + item.price.toFixed(2) + ' <b>(S)</b></div>' +
                    '</div>' +
                    '</div>';
            });
            
            render(html);
        }
        
        // Demo items for categories
        function getItemsForCategory(categoryId) {
            var items = {
                'pizza': [
                    { id: 'p1', name: 'Pepperoni Classic', desc: 'Pepperoni, mozzarella, signature sauce', price: 14.99, image: 'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=400&h=200&fit=crop' },
                    { id: 'p2', name: 'Meat Lovers', desc: 'Pepperoni, sausage, bacon, ham, beef', price: 18.99, image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop' },
                    { id: 'p3', name: 'Hawaiian', desc: 'Ham, pineapple, mozzarella', price: 15.99, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop' },
                    { id: 'p4', name: 'Veggie Supreme', desc: 'Mushrooms, peppers, onions, olives, tomatoes', price: 16.99, image: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400&h=200&fit=crop' },
                    { id: 'p5', name: 'BBQ Chicken', desc: 'Grilled chicken, BBQ sauce, red onions', price: 17.99, image: 'https://images.unsplash.com/photo-1593560708920-61dd98c46a4e?w=400&h=200&fit=crop' },
                    { id: 'p6', name: 'Canadian', desc: 'Pepperoni, mushrooms, bacon', price: 16.99, image: 'https://images.unsplash.com/photo-1571407970349-bc81e7e96d47?w=400&h=200&fit=crop' }
                ],
                'donair': [
                    { id: 'd1', name: 'Classic Donair', desc: 'Shaved beef, sweet sauce, tomatoes, onions', price: 12.99, image: 'https://images.unsplash.com/photo-1561651823-34feb02250e4?w=400&h=200&fit=crop' },
                    { id: 'd2', name: 'Chicken Donair', desc: 'Grilled chicken, garlic sauce, veggies', price: 13.99, image: 'https://images.unsplash.com/photo-1529006557810-274b9b2fc783?w=400&h=200&fit=crop' }
                ],
                'wings': [
                    { id: 'w1', name: 'Classic Wings', desc: 'Choose your flavor: Hot, Mild, BBQ, Honey Garlic', price: 14.99, image: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400&h=200&fit=crop' },
                    { id: 'w2', name: 'Boneless Wings', desc: 'Crispy boneless bites with your choice of sauce', price: 13.99, image: 'https://images.unsplash.com/photo-1567620832903-9fc6debc209f?w=400&h=200&fit=crop' }
                ],
                'salads': [
                    { id: 's1', name: 'Caesar Salad', desc: 'Romaine, parmesan, croutons, caesar dressing', price: 9.99, image: 'https://images.unsplash.com/photo-1550304943-4f24f54ddde9?w=400&h=200&fit=crop' },
                    { id: 's2', name: 'Greek Salad', desc: 'Tomatoes, cucumbers, feta, olives, red onion', price: 10.99, image: 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=400&h=200&fit=crop' }
                ],
                'sides': [
                    { id: 'si1', name: 'Garlic Bread', desc: 'Toasted with garlic butter', price: 4.99, image: 'https://images.unsplash.com/photo-1619535860434-ba1d8fa12536?w=400&h=200&fit=crop' },
                    { id: 'si2', name: 'Fries', desc: 'Crispy golden fries', price: 5.99, image: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400&h=200&fit=crop' }
                ],
                'drinks': [
                    { id: 'dr1', name: 'Pop (Can)', desc: 'Coke, Sprite, Fanta, Ginger Ale', price: 1.99, image: 'https://images.unsplash.com/photo-1581636625402-29b2a704ef13?w=400&h=200&fit=crop' },
                    { id: 'dr2', name: 'Pop (2L)', desc: 'Coke, Sprite, Fanta', price: 3.99, image: 'https://images.unsplash.com/photo-1624552184280-9e9631bbeee9?w=400&h=200&fit=crop' }
                ],
                'combos': [
                    { id: 'c1', name: 'Pizza + Wings Combo', desc: 'Large pizza + 1lb wings + 2L pop', price: 34.99, image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop' },
                    { id: 'c2', name: 'Family Pack', desc: '2 Large pizzas + 2lb wings + 2L pop', price: 49.99, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop' }
                ]
            };
            
            return items[categoryId] || [];
        }
        
        // Size pricing (multiplier based on small price)
        function getSizePrices(basePrice) {
            return {
                'S': { label: 'S', name: 'Small (10")', price: basePrice, popular: false },
                'M': { label: 'M', name: 'Medium (12")', price: basePrice + 3, popular: false },
                'L': { label: 'L', name: 'Large (14")', price: basePrice + 6, popular: true },
                'XL': { label: 'XL', name: 'X-Large (16")', price: basePrice + 9, popular: false }
            };
        }
        
        // PAGE: Item Detail with Size Selection
        function showItemDetail() {
            var item = state.selectedItem;
            if (!item) {
                renderPage('menu');
                return;
            }
            
            var sizes = getSizePrices(item.price);
            
            var html = '<img class="item-hero" src="' + item.image + '" onerror="this.src=\'https://placehold.co/400x200/1a1a2e/25D366?text=' + encodeURIComponent(item.name) + '\'">' +
                '<div class="item-title">' + item.name + '</div>' +
                '<div class="item-desc">' + item.desc + '</div>' +
                '<div class="section-header">SELECT SIZE</div>';
            
            // Size buttons
            ['S', 'M', 'L', 'XL'].forEach(function(sizeKey) {
                var size = sizes[sizeKey];
                var popularClass = size.popular ? ' popular' : '';
                var popularTag = size.popular ? '<span class="popular-tag">POPULAR</span>' : '';
                
                html += '<div class="size-btn' + popularClass + '" data-action="add_with_size" data-value="' + item.id + '_' + sizeKey + '">' +
                    '<div>' +
                    '<span class="size-label">' + size.label + '</span>' +
                    '<span class="size-name">' + size.name + '</span>' +
                    popularTag +
                    '</div>' +
                    '<div class="size-price">$' + size.price.toFixed(2) + '</div>' +
                    '</div>';
            });
            
            render(html);
        }
        
        // Available toppings
        function getToppings() {
            return [
                { id: 'pepperoni', name: 'Extra Pepperoni', price: 1.50 },
                { id: 'cheese', name: 'Extra Cheese', price: 1.50 },
                { id: 'mushrooms', name: 'Mushrooms', price: 1.50 },
                { id: 'bacon', name: 'Bacon', price: 1.50 },
                { id: 'sausage', name: 'Italian Sausage', price: 1.50 },
                { id: 'peppers', name: 'Green Peppers', price: 1.50 },
                { id: 'onions', name: 'Onions', price: 1.50 },
                { id: 'olives', name: 'Black Olives', price: 1.50 },
                { id: 'jalapenos', name: 'Jalape√±os', price: 1.50 },
                { id: 'pineapple', name: 'Pineapple', price: 1.50 }
            ];
        }
        
        // PAGE: Extra Toppings Selection
        function showToppingsPage() {
            var item = state.selectedItem;
            var sizeKey = state.selectedSize;
            var sizes = getSizePrices(item.price);
            var size = sizes[sizeKey];
            var sizeNames = { 'S': 'Small', 'M': 'Medium', 'L': 'Large', 'XL': 'X-Large' };
            
            var toppings = getToppings();
            var toppingsPrice = state.selectedToppings.length * 1.50;
            var totalPrice = size.price + toppingsPrice;
            
            var html = '<div class="page-title">üçï Extra Toppings?</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="font-size: 16px; font-weight: 600;">' + item.name + ' (' + sizeNames[sizeKey] + ')</div>' +
                '<div style="font-size: 14px; color: #8696a0;">Base: $' + size.price.toFixed(2) + '</div>' +
                '</div>' +
                '<div class="section-header">ADD EXTRA TOPPINGS ($1.50 each)</div>';
            
            toppings.forEach(function(topping) {
                var isSelected = state.selectedToppings.indexOf(topping.id) !== -1;
                var selectedClass = isSelected ? ' selected' : '';
                var checkMark = isSelected ? '‚úì' : '';
                
                html += '<div class="topping-btn' + selectedClass + '" data-action="toggle_topping" data-value="' + topping.id + '">' +
                    '<div class="check">' + checkMark + '</div>' +
                    '<div class="topping-name">' + topping.name + '</div>' +
                    '<div class="topping-price">+$' + topping.price.toFixed(2) + '</div>' +
                    '</div>';
            });
            
            // Total and buttons
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-top: 20px;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                '<span>Pizza (' + sizeNames[sizeKey] + ')</span><span>$' + size.price.toFixed(2) + '</span></div>';
            
            if (state.selectedToppings.length > 0) {
                html += '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                    '<span>Toppings (' + state.selectedToppings.length + ')</span><span>$' + toppingsPrice.toFixed(2) + '</span></div>';
            }
            
            html += '<div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; padding-top: 10px; border-top: 1px solid #2a3942;">' +
                '<span>Total</span><span style="color: #25D366;">$' + totalPrice.toFixed(2) + '</span></div>' +
                '</div>';
            
            html += '<div class="buttons" style="margin-top: 16px;">' +
                '<button class="btn primary" data-action="confirm_toppings">Add to Cart - $' + totalPrice.toFixed(2) + '</button>' +
                '<button class="btn" data-action="skip_toppings">No Extra Toppings</button>' +
                '</div>';
            
            render(html);
        }
        
        // ============================================
        // HEADER
        // ============================================
        function setHeader(name, initials, status) {
            document.getElementById('headerName').textContent = name;
            document.getElementById('avatar').textContent = initials;
            document.getElementById('headerStatus').textContent = status;
        }
        
        // ============================================
        // ACTIONS
        // ============================================
        function handleAction(action, value) {
            console.log('Action:', action, value);
            
            switch(action) {
                case 'share_location':
                    getLocation();
                    break;
                case 'type_address':
                    showAddressInput();
                    break;
                case 'use_saved_address':
                    // Quick confirmation then go to restaurants
                    var addr = state.customer ? state.customer.address : 'Your location';
                    var confirmHtml = '<div class="bubble">‚úÖ <b>Delivering to:</b><br>' + addr + '</div>';
                    render(confirmHtml);
                    setTimeout(function() {
                        renderPage('restaurants');
                    }, 500);
                    break;
                case 'confirm_address':
                    renderPage('restaurants');
                    break;
                case 'select_restaurant':
                    selectRestaurant(value);
                    break;
                case 'continue_to_menu':
                    renderPage('restaurant_home');
                    break;
                case 'show_specials':
                    renderPage('specials');
                    break;
                case 'show_menu':
                    renderPage('menu');
                    break;
                case 'show_category':
                    state.currentCategory = value;
                    renderPage('category');
                    break;
                case 'select_item':
                    selectItem(value);
                    break;
                case 'add_with_size':
                    addItemWithSize(value);
                    break;
                case 'toggle_topping':
                    toggleTopping(value);
                    break;
                case 'confirm_toppings':
                    addItemToCartWithToppings();
                    break;
                case 'skip_toppings':
                    state.selectedToppings = [];
                    addItemToCartWithToppings();
                    break;
                case 'add_special':
                    // Old action - redirect to view
                    viewSpecial(value);
                    break;
                case 'view_special':
                    viewSpecial(value);
                    break;
                case 'add_special_to_cart':
                    addSpecialToCart(value);
                    break;
                case 'custom_pizza':
                    state.customPizzaToppings = [];
                    renderPage('custom_pizza');
                    break;
                case 'toggle_custom_topping':
                    toggleCustomTopping(value);
                    break;
                case 'custom_pizza_continue':
                    renderPage('custom_pizza_size');
                    break;
                case 'add_custom_pizza':
                    addCustomPizzaToCart(value);
                    break;
                case 'show_cart':
                    showCartPage();
                    break;
                case 'remove_item':
                    removeCartItem(parseInt(value));
                    break;
                case 'checkout':
                    renderPage('tip');
                    break;
                case 'go_checkout':
                    renderPage('tip');
                    break;
                case 'add_more':
                    renderPage('menu');
                    break;
                case 'set_tip':
                    state.tip = parseFloat(value) || 0;
                    renderPage('payment');
                    break;
                case 'set_tip_percent':
                    var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
                    state.tip = Math.round(subtotal * parseFloat(value)) / 100;
                    renderPage('payment');
                    break;
                case 'custom_tip':
                    showCustomTipPage();
                    break;
                case 'show_tip_page':
                    renderPage('tip');
                    break;
                case 'pay_card':
                    state.selectedPaymentMethod = 'card';
                    processPayment('card');
                    break;
                case 'show_credit_cards':
                    renderPage('credit_cards');
                    break;
                case 'pay_credit':
                    state.selectedPaymentMethod = 'credit_' + value;
                    processPayment('credit', value);
                    break;
                case 'pay_debit':
                    state.selectedPaymentMethod = 'debit';
                    processPayment('debit');
                    break;
                case 'pay_cash':
                    state.selectedPaymentMethod = 'cash';
                    processPayment('cash');
                    break;
                case 'go_to_payment':
                    renderPage('payment');
                    break;
                case 'new_order':
                    startNewOrder();
                    break;
                case 'call_driver':
                    if (state.assignedDriver) {
                        alert('üìû Calling ' + state.assignedDriver.name + '...\n\n(In production, this would initiate a masked call through the app)');
                    }
                    break;
                case 'message_driver':
                    if (state.assignedDriver) {
                        alert('üí¨ Opening chat with ' + state.assignedDriver.name + '...\n\n(In production, this would open an in-app messaging system)');
                    }
                    break;
                    
                // Delivery Module Actions
                case 'switch_to_customer':
                case 'back_to_customer':
                    deliveryState.mode = 'customer';
                    renderPage('welcome');
                    break;
                case 'accept_order':
                    alert('‚úÖ Order #' + value + ' accepted!\n\nNavigating to pickup location...\n\n(In production, this would open maps with directions)');
                    break;
                case 'select_template':
                    var templates = {
                        'weekly': 'üçï WEEKLY SPECIAL!\n\nThis week only - Get 20% OFF all pizzas from AB King Pizza!\n\nUse code: PIZZA20\n\nOrder now on LocalFirst YYC üíö',
                        'flash': '‚ö° FLASH SALE!\n\nFREE DELIVERY on all orders for the next 2 hours!\n\nNo code needed - discount applied automatically.\n\nOrder now! üöó',
                        'loyalty': 'üíö Thank you for being a LocalFirst customer!\n\nAs a thank you, here\'s $5 OFF your next order.\n\nUse code: THANKS5\n\nWe appreciate you supporting local! üôè',
                        'new': 'üÜï NEW RESTAURANT ALERT!\n\nWe just added Taco Fiesta to LocalFirst YYC!\n\nüåÆ Authentic Mexican cuisine\n‚≠ê 4.5 rating\nüöó FREE delivery under 3km\n\nTry them today!'
                    };
                    var msg = templates[value] || '';
                    document.getElementById('broadcast_message').value = msg;
                    break;
                case 'send_broadcast':
                    var message = document.getElementById('broadcast_message').value;
                    if (message.trim()) {
                        alert('üì§ Broadcast Sent!\n\nYour message has been sent to all customers via WhatsApp.\n\n(In production, this would use the WhatsApp Business API to send bulk messages)');
                    } else {
                        alert('Please enter a message first!');
                    }
                    break;
            }
        }
        
        function handleInput(action, value) {
            if (action === 'submit_name') {
                // Legacy handler - name+phone now handled by submit_customer_btn
                state.customer = state.customer || {};
                state.customer.name = value;
                saveCustomer();
                showAddressPrompt();
            }
            else if (action === 'submit_address') {
                state.customer = state.customer || {};
                state.customer.address = value;
                saveCustomer();
                showAddressConfirm(value);
            }
            else if (action === 'submit_custom_tip') {
                var tipAmount = parseFloat(value) || 0;
                state.tip = Math.max(0, tipAmount); // Ensure non-negative
                renderPage('payment');
            }
        }
        
        // ============================================
        // HELPERS
        // ============================================
        
        // Format phone number for display
        function formatPhone(phone) {
            if (!phone) return '';
            // Remove any non-digits
            var digits = phone.replace(/\D/g, '');
            // Format as (403) 555-1234
            if (digits.length === 10) {
                return '(' + digits.slice(0,3) + ') ' + digits.slice(3,6) + '-' + digits.slice(6);
            } else if (digits.length === 11 && digits[0] === '1') {
                return '+1 (' + digits.slice(1,4) + ') ' + digits.slice(4,7) + '-' + digits.slice(7);
            }
            return phone;
        }
        
        // Generate demo phone (simulates WhatsApp providing this)
        function generateDemoPhone() {
            // Calgary area code 403, random number
            return '1403' + Math.floor(1000000 + Math.random() * 9000000);
        }
        
        function showAddressPrompt() {
            // Check if we have a saved address
            var savedAddress = state.customer ? state.customer.address : null;
            var firstName = state.customer && state.customer.name ? state.customer.name.split(' ')[0] : '';
            var phone = state.customer ? state.customer.phone : '';
            var displayPhone = formatPhone(phone);
            
            var html = '<div style="text-align: center; padding: 15px 0;">' +
                '<div style="font-size: 50px; margin-bottom: 10px;">üéâ</div>' +
                '<div style="font-size: 22px; font-weight: 700;">Hey ' + firstName + '!</div>' +
                '<div style="font-size: 14px; color: #8696a0; margin-top: 6px;">Your discount is locked in</div>' +
                '</div>';
            
            // Show WhatsApp info card - so they know we have their info
            html += '<div style="background: #202c33; border-radius: 12px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="font-size: 11px; color: #8696a0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">üì± Connected via WhatsApp</div>' +
                '<div style="display: flex; align-items: center; gap: 12px;">' +
                '<div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700;">' + 
                (state.customer.name ? state.customer.name.charAt(0).toUpperCase() : '?') + '</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 15px; font-weight: 600;">' + state.customer.name + '</div>' +
                '<div style="font-size: 13px; color: #25D366;">' + displayPhone + '</div>' +
                '</div>' +
                '<div style="font-size: 18px; color: #25D366;">‚úì</div>' +
                '</div>' +
                '</div>';
            
            // Show discount reminder
            if (isFirstTimeCustomer) {
                html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 12px; padding: 14px; margin-bottom: 16px; text-align: center;">' +
                    '<div style="font-size: 14px; font-weight: 700;">üéÅ FREE Delivery + 10% OFF</div>' +
                    '<div style="font-size: 12px; opacity: 0.9;">Applied at checkout</div>' +
                    '</div>';
            }
            
            html += '<div style="background: #202c33; border-radius: 16px; padding: 20px;">' +
                '<div style="font-size: 15px; color: #e9edef; margin-bottom: 16px; text-align: center;">Where should we deliver your food?</div>';
            
            if (savedAddress) {
                html += '<div class="buttons">' +
                    '<button class="btn primary" data-action="use_saved_address">üìç ' + savedAddress + '</button>' +
                    '<button class="btn" data-action="share_location">üìç Use GPS Location</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è Type Address</button>' +
                    '</div>';
            } else {
                html += '<div class="buttons">' +
                    '<button class="btn primary" data-action="share_location" style="font-size: 16px;">üìç Share My Location</button>' +
                    '<button class="btn" data-action="type_address">‚úèÔ∏è Type Address Instead</button>' +
                    '</div>';
            }
            
            html += '</div>';
            render(html);
        }
        
        function showAddressInput() {
            // Pre-fill with saved address if available
            var savedAddress = state.customer && state.customer.address ? state.customer.address : '';
            
            var html = '<div style="background: #202c33; border-radius: 16px; padding: 20px;">' +
                '<div style="font-size: 15px; color: #e9edef; margin-bottom: 14px; text-align: center;">üìç Enter your delivery address</div>' +
                '<div class="input-bubble" style="margin: 0;">' +
                '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" value="' + savedAddress + '" autocomplete="off" style="font-size: 16px;">' +
                '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                '</div>' +
                '</div>';
            render(html);
        }
        
        function showAddressConfirm(address) {
            var firstName = state.customer && state.customer.name ? state.customer.name.split(' ')[0] : '';
            
            var html = '<div style="text-align: center; padding: 20px 0;">' +
                '<div style="font-size: 50px; margin-bottom: 10px;">‚úÖ</div>' +
                '<div style="font-size: 22px; font-weight: 700;">Perfect, ' + firstName + '!</div>' +
                '</div>';
            
            html += '<div style="background: #202c33; border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="font-size: 13px; color: #8696a0; margin-bottom: 8px;">DELIVERING TO</div>' +
                '<div style="font-size: 17px; font-weight: 600;">üìç ' + address + '</div>' +
                '<div style="font-size: 14px; color: #25D366; margin-top: 10px;">üöó FREE delivery applies!</div>' +
                '</div>';
            
            // Show discount if first time
            if (isFirstTimeCustomer) {
                html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">' +
                    '<div style="font-size: 14px; font-weight: 700;">üéÅ Your First Order Discount</div>' +
                    '<div style="font-size: 20px; font-weight: 800; margin: 6px 0;">FREE Delivery + 10% OFF</div>' +
                    '<div style="font-size: 12px; opacity: 0.9;">Auto-applied at checkout</div>' +
                    '</div>';
            }
            
            html += '<div class="buttons">' +
                '<button class="btn primary" data-action="confirm_address" style="font-size: 16px;">üçΩÔ∏è Let\'s See Restaurants!</button>' +
                '<button class="btn" data-action="type_address">‚úèÔ∏è Change Address</button>' +
                '</div>';
            
            render(html);
        }
        
        function getLocation() {
            var html = '<div class="bubble"><span class="spinner"></span> Finding your exact location...</div>';
            render(html);
            
            if (!navigator.geolocation) {
                setTimeout(function() {
                    var errorHtml = '<div class="bubble">üìç GPS not available on this device.<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                }, 500);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    console.log('GPS Success:', pos.coords.latitude, pos.coords.longitude);
                    reverseGeocode(pos.coords.latitude, pos.coords.longitude);
                },
                function(err) {
                    console.log('GPS Error:', err.message);
                    var errorMsg = 'Could not get location.';
                    if (err.code === 1) {
                        errorMsg = 'Location permission denied.';
                    } else if (err.code === 2) {
                        errorMsg = 'Location unavailable.';
                    } else if (err.code === 3) {
                        errorMsg = 'Location request timed out.';
                    }
                    
                    var errorHtml = '<div class="bubble">üìç ' + errorMsg + '<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }
        
        function reverseGeocode(lat, lng) {
            var url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&addressdetails=1';
            
            console.log('Fetching address from:', url);
            
            fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'User-Agent': 'LocalFirstYYC/1.0'
                }
            })
                .then(function(res) { 
                    if (!res.ok) throw new Error('Network error');
                    return res.json(); 
                })
                .then(function(data) {
                    console.log('Geocode result:', data);
                    
                    var fullAddress = '';
                    
                    if (data && data.address) {
                        var addr = data.address;
                        var houseNum = addr.house_number || '';
                        var street = addr.road || addr.street || addr.pedestrian || addr.footway || addr.residential || '';
                        var city = addr.city || addr.town || addr.village || addr.suburb || addr.municipality || 'Calgary';
                        
                        // Build address string
                        var parts = [];
                        if (houseNum) parts.push(houseNum);
                        if (street) parts.push(street);
                        
                        if (parts.length > 0) {
                            fullAddress = parts.join(' ') + ', ' + city;
                        } else if (data.display_name) {
                            // Use display_name as fallback
                            var displayParts = data.display_name.split(',');
                            fullAddress = displayParts.slice(0, 3).join(',').trim();
                        }
                    }
                    
                    // If still empty, use display_name
                    if (!fullAddress && data && data.display_name) {
                        var displayParts = data.display_name.split(',');
                        fullAddress = displayParts.slice(0, 3).join(',').trim();
                    }
                    
                    // Final fallback
                    if (!fullAddress) {
                        fullAddress = 'Calgary, AB';
                    }
                    
                    console.log('Final address:', fullAddress);
                    
                    state.customer = state.customer || {};
                    state.customer.address = fullAddress;
                    state.customer.lat = lat;
                    state.customer.lng = lng;
                    saveCustomer();
                    showAddressConfirm(fullAddress);
                })
                .catch(function(err) {
                    console.log('Geocode error:', err);
                    // Still save the coordinates even if geocoding fails
                    state.customer = state.customer || {};
                    state.customer.lat = lat;
                    state.customer.lng = lng;
                    
                    // Ask user to type address
                    var errorHtml = '<div class="bubble">üìç Found your location but couldn\'t get street address.<br><br>Please type your address:</div>' +
                        '<div class="input-bubble">' +
                        '<input type="text" id="address_input" placeholder="e.g. 123 Main St NW, Calgary" autocomplete="off">' +
                        '<button class="btn primary input-submit" data-input="address_input" data-action="submit_address">Continue</button>' +
                        '</div>';
                    render(errorHtml);
                });
        }
        
        function selectRestaurant(id) {
            var restaurants = {
                '1': { 
                    id: '1', 
                    name: 'AB King Pizza', 
                    icon: 'üçï', 
                    time: '25-35 min',
                    owner: {
                        name: 'Fatima',
                        image: 'data:image/jpeg;base64,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',
                        story: 'I put my heart into every pizza I make. When you order from me, you\'re supporting a local Calgary family, not a corporation.',
                        tagline: 'üë©‚Äçüç≥ Chef & Owner ‚Ä¢ üçï Handmade with Love ‚Ä¢ üíö 100% Local',
                        since: 2018
                    }
                },
                '2': { 
                    id: '2', 
                    name: 'Burger Barn', 
                    icon: 'üçî', 
                    time: '30-40 min',
                    owner: {
                        name: 'Maria Santos',
                        image: 'https://images.unsplash.com/photo-1594744803329-e58b31de8bf5?w=200&h=200&fit=crop&crop=face',
                        story: 'Left my corporate job to follow my dream. Now my daughter works beside me every weekend.',
                        tagline: 'üë©‚Äçüç≥ Chef & Mom ‚Ä¢ üá®üá¶ Alberta Beef Only ‚Ä¢ üí™ Woman-Owned',
                        since: 2015
                    }
                },
                '3': { 
                    id: '3', 
                    name: 'Wing House', 
                    icon: 'üçó', 
                    time: '35-45 min',
                    owner: {
                        name: 'Grace Okonkwo',
                        image: 'https://images.unsplash.com/photo-1589156280159-27698a70f29e?w=200&h=200&fit=crop&crop=face',
                        story: 'Came to Canada with $200. Now I employ 12 people from my community. Your order changes lives.',
                        tagline: 'üåç Nigerian-Canadian ‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Employs 12 Locals ‚Ä¢ üí™ Woman-Owned',
                        since: 2012
                    }
                },
                '4': { 
                    id: '4', 
                    name: 'Taco Fiesta', 
                    icon: 'üåÆ', 
                    time: '35-45 min',
                    owner: {
                        name: 'Rosa Hernandez',
                        image: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=200&h=200&fit=crop&crop=face',
                        story: 'My grandmother\'s recipes saved our family. Now they\'re feeding yours. Taste the love in every bite.',
                        tagline: 'üëµ 3rd Gen Recipes ‚Ä¢ üá≤üáΩ Mexican Heritage ‚Ä¢ üí™ Woman-Owned',
                        since: 2018
                    }
                },
                '5': { 
                    id: '5', 
                    name: 'Noodle King', 
                    icon: 'üçú', 
                    time: '40-50 min',
                    owner: {
                        name: 'Lin Zhang',
                        image: 'https://images.unsplash.com/photo-1607631568010-a87245c0daf8?w=200&h=200&fit=crop&crop=face',
                        story: 'My parents worked 3 jobs so I could go to school. This restaurant is my way of making them proud.',
                        tagline: 'üë®‚Äçüë©‚Äçüë¶ Family Business ‚Ä¢ üá®üá≥ Chinese-Canadian ‚Ä¢ ‚ù§Ô∏è For Mom & Dad',
                        since: 2016
                    }
                }
            };
            state.restaurant = restaurants[id] || { id: id, name: 'Restaurant', time: '30-40 min' };
            
            // Show owner intro first
            showOwnerIntro();
        }
        
        // PAGE: Owner Introduction
        function showOwnerIntro() {
            var r = state.restaurant;
            var owner = r.owner;
            
            if (!owner) {
                renderPage('restaurant_home');
                return;
            }
            
            var yearsInBusiness = new Date().getFullYear() - owner.since;
            
            var html = '<div style="text-align: center; padding-top: 10px;">' +
                '<div style="position: relative; display: inline-block; margin-bottom: 16px;">' +
                '<img src="' + owner.image + '" style="width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 4px solid #25D366;" onerror="this.src=\'https://placehold.co/130x130/202c33/25D366?text=' + encodeURIComponent(owner.name.charAt(0)) + '\'">' +
                '</div>' +
                '<div style="font-size: 13px; color: #25D366; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;">Meet Your Chef</div>' +
                '<div style="font-size: 26px; font-weight: 700; margin-bottom: 4px;">' + owner.name + '</div>' +
                '<div style="font-size: 15px; color: #8696a0; margin-bottom: 12px;">' + r.name + '</div>';
            
            // Tagline badges
            if (owner.tagline) {
                html += '<div style="font-size: 12px; color: #e9edef; margin-bottom: 16px; line-height: 1.8;">' + owner.tagline + '</div>';
            }
            
            html += '</div>';
            
            // Story card - more emotional
            html += '<div style="background: linear-gradient(135deg, #1a2520, #0d1a15); border: 1px solid #25D366; border-radius: 16px; padding: 24px; margin-bottom: 20px; text-align: center;">' +
                '<div style="font-size: 50px; margin-bottom: 16px;">' + r.icon + '</div>' +
                '<div style="font-size: 17px; line-height: 1.7; color: #e9edef; font-style: italic;">"' + owner.story + '"</div>' +
                '</div>';
            
            // Stats row
            html += '<div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 20px;">' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px 20px; text-align: center;">' +
                '<div style="font-size: 22px; font-weight: 700; color: #25D366;">' + yearsInBusiness + '</div>' +
                '<div style="font-size: 10px; color: #8696a0; text-transform: uppercase;">Years</div>' +
                '</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px 20px; text-align: center;">' +
                '<div style="font-size: 22px; font-weight: 700; color: #25D366;">‚≠ê 4.9</div>' +
                '<div style="font-size: 10px; color: #8696a0; text-transform: uppercase;">Rating</div>' +
                '</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px 20px; text-align: center;">' +
                '<div style="font-size: 22px; font-weight: 700; color: #25D366;">2K+</div>' +
                '<div style="font-size: 10px; color: #8696a0; text-transform: uppercase;">Orders</div>' +
                '</div>' +
                '</div>';
            
            // LocalFirst impact badge
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 14px;">' +
                '<div style="font-size: 36px;">üíö</div>' +
                '<div>' +
                '<div style="font-size: 14px; font-weight: 600; color: #25D366;">Your Order Matters</div>' +
                '<div style="font-size: 12px; color: #8696a0; line-height: 1.5;">100% goes to ' + owner.name.split(' ')[0] + '\'s family ‚Äî not corporate headquarters</div>' +
                '</div>' +
                '</div>';
            
            html += '<div class="buttons">' +
                '<button class="btn primary" data-action="continue_to_menu" style="font-size: 17px; padding: 16px;">Support ' + owner.name.split(' ')[0] + ' ‚Äî Let\'s Order! üçΩÔ∏è</button>' +
                '</div>';
            
            render(html);
            setHeader(r.name, r.name.substring(0,2), 'online');
        }
        
        function selectItem(itemId) {
            // Find item in all categories
            var allItems = [];
            ['pizza', 'donair', 'wings', 'salads', 'sides', 'drinks', 'combos'].forEach(function(cat) {
                allItems = allItems.concat(getItemsForCategory(cat));
            });
            
            var item = allItems.find(function(i) { return i.id === itemId; });
            if (item) {
                state.selectedItem = item;
                renderPage('item_detail');
            }
        }
        
        function addItemWithSize(value) {
            // value is "itemId_size" like "p1_L"
            var parts = value.split('_');
            var itemId = parts[0];
            var sizeKey = parts[1];
            
            // Find item
            var allItems = [];
            ['pizza', 'donair', 'wings', 'salads', 'sides', 'drinks', 'combos'].forEach(function(cat) {
                allItems = allItems.concat(getItemsForCategory(cat));
            });
            
            var item = allItems.find(function(i) { return i.id === itemId; });
            if (item) {
                state.selectedItem = item;
                state.selectedSize = sizeKey;
                state.selectedToppings = [];
                
                // Check if this is a pizza - if so, show toppings
                if (itemId.startsWith('p')) {
                    renderPage('item_toppings');
                } else {
                    // Not pizza, add directly to cart
                    addItemToCartWithToppings();
                }
            }
        }
        
        // Add item to cart with selected toppings
        function addItemToCartWithToppings() {
            var item = state.selectedItem;
            var sizeKey = state.selectedSize;
            var toppings = state.selectedToppings;
            
            var sizes = getSizePrices(item.price);
            var size = sizes[sizeKey];
            var sizeNames = { 'S': 'Small', 'M': 'Medium', 'L': 'Large', 'XL': 'X-Large' };
            
            // Calculate toppings cost
            var toppingsPrice = toppings.length * 1.50; // $1.50 per topping
            var totalPrice = size.price + toppingsPrice;
            
            // Build name with toppings
            var name = item.name + ' (' + sizeNames[sizeKey] + ')';
            if (toppings.length > 0) {
                name += ' + ' + toppings.length + ' topping' + (toppings.length > 1 ? 's' : '');
            }
            
            state.cart.push({ 
                id: item.id + '_' + sizeKey + '_' + Date.now(), 
                name: name,
                toppings: toppings,
                price: totalPrice 
            });
            updateCart();
            
            renderPage('item_added');
        }
        
        // Toggle topping selection
        function toggleTopping(toppingId) {
            var index = state.selectedToppings.indexOf(toppingId);
            if (index === -1) {
                state.selectedToppings.push(toppingId);
            } else {
                state.selectedToppings.splice(index, 1);
            }
            // Re-render toppings page to show updated selection
            showToppingsPage();
        }
        
        // Remove item from cart
        function removeCartItem(index) {
            if (index >= 0 && index < state.cart.length) {
                state.cart.splice(index, 1);
                updateCart();
                showCartPage();
            }
        }
        
        // Get custom pizza ingredients with images
        function getCustomPizzaIngredients() {
            return {
                cheese: [
                    { id: 'mozzarella', name: 'Mozzarella', image: 'https://images.unsplash.com/photo-1486297678162-eb2a19b0a32d?w=100&h=100&fit=crop', price: 0, included: true },
                    { id: 'extra_cheese', name: 'Extra Cheese', image: 'https://images.unsplash.com/photo-1552767059-ce182ead6c1b?w=100&h=100&fit=crop', price: 2.00 },
                    { id: 'feta', name: 'Feta', image: 'https://images.unsplash.com/photo-1626957341926-98752fc2ba90?w=100&h=100&fit=crop', price: 1.50 },
                    { id: 'parmesan', name: 'Parmesan', image: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=100&h=100&fit=crop', price: 1.50 }
                ],
                meats: [
                    { id: 'pepperoni', name: 'Pepperoni', image: 'https://images.unsplash.com/photo-1628840042765-356cda07504e?w=100&h=100&fit=crop', price: 1.50 },
                    { id: 'bacon', name: 'Bacon', image: 'https://images.unsplash.com/photo-1606851091851-e8c8c0fca5ba?w=100&h=100&fit=crop', price: 1.50 },
                    { id: 'sausage', name: 'Italian Sausage', image: 'https://images.unsplash.com/photo-1565299507177-b0ac66763828?w=100&h=100&fit=crop', price: 1.50 },
                    { id: 'ham', name: 'Ham', image: 'https://images.unsplash.com/photo-1524438418049-ab2acb7aa48f?w=100&h=100&fit=crop', price: 1.50 },
                    { id: 'chicken', name: 'Grilled Chicken', image: 'https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?w=100&h=100&fit=crop', price: 2.00 },
                    { id: 'beef', name: 'Ground Beef', image: 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=100&h=100&fit=crop', price: 1.50 }
                ],
                veggies: [
                    { id: 'mushrooms', name: 'Mushrooms', image: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'peppers', name: 'Green Peppers', image: 'https://images.unsplash.com/photo-1563565375-f3fdfdbefa83?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'onions', name: 'Onions', image: 'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'olives', name: 'Black Olives', image: 'https://images.unsplash.com/photo-1593030103066-0093718e75f1?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'tomatoes', name: 'Tomatoes', image: 'https://images.unsplash.com/photo-1546470427-0d4db154cca8?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'pineapple', name: 'Pineapple', image: 'https://images.unsplash.com/photo-1550258987-190a2d41a8ba?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'jalapenos', name: 'Jalape√±os', image: 'https://images.unsplash.com/photo-1583119022894-919a68a3d0e3?w=100&h=100&fit=crop', price: 1.00 },
                    { id: 'spinach', name: 'Spinach', image: 'https://images.unsplash.com/photo-1576045057995-568f588f82fb?w=100&h=100&fit=crop', price: 1.00 }
                ]
            };
        }
        
        // PAGE: Custom Pizza Builder
        function showCustomPizzaPage() {
            var ingredients = getCustomPizzaIngredients();
            var toppingsPrice = calculateCustomPizzaPrice();
            
            var html = '<div class="page-title">üé® Build Your Pizza</div>';
            
            // Selected toppings preview
            if (state.customPizzaToppings.length > 0) {
                html += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; padding: 12px; background: #202c33; border-radius: 12px;">';
                var allIngredients = [].concat(ingredients.cheese, ingredients.meats, ingredients.veggies);
                state.customPizzaToppings.forEach(function(tid) {
                    var ing = allIngredients.find(function(i) { return i.id === tid; });
                    if (ing) {
                        html += '<div style="display: flex; align-items: center; gap: 6px; background: #25D366; padding: 4px 10px; border-radius: 20px; font-size: 12px;">' +
                            '<img src="' + ing.image + '" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;">' +
                            ing.name + '</div>';
                    }
                });
                html += '</div>';
            }
            
            // Cheese section
            html += '<div class="section-header">üßÄ CHEESE (Mozzarella included)</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">';
            ingredients.cheese.forEach(function(ing) {
                var isSelected = state.customPizzaToppings.indexOf(ing.id) !== -1 || ing.included;
                html += buildIngredientCard(ing, isSelected);
            });
            html += '</div>';
            
            // Meats section
            html += '<div class="section-header">ü•ì MEATS (+$1.50 - $2.00)</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">';
            ingredients.meats.forEach(function(ing) {
                var isSelected = state.customPizzaToppings.indexOf(ing.id) !== -1;
                html += buildIngredientCard(ing, isSelected);
            });
            html += '</div>';
            
            // Veggies section
            html += '<div class="section-header">ü•¨ VEGGIES (+$1.00)</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">';
            ingredients.veggies.forEach(function(ing) {
                var isSelected = state.customPizzaToppings.indexOf(ing.id) !== -1;
                html += buildIngredientCard(ing, isSelected);
            });
            html += '</div>';
            
            // Price summary
            var basePrice = 12.99;
            var totalPrice = basePrice + toppingsPrice;
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                '<span>Base Pizza</span><span>$' + basePrice.toFixed(2) + '</span></div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                '<span>Toppings (' + state.customPizzaToppings.length + ')</span><span>$' + toppingsPrice.toFixed(2) + '</span></div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; padding-top: 10px; border-top: 1px solid #2a3942;">' +
                '<span>Small Pizza</span><span style="color: #25D366;">$' + totalPrice.toFixed(2) + '</span></div>' +
                '</div>';
            
            html += '<div class="buttons">' +
                '<button class="btn primary" data-action="custom_pizza_continue">Continue - Choose Size</button>' +
                '<button class="btn" data-action="show_category" data-value="pizza">‚Üê Back to Pizzas</button>' +
                '</div>';
            
            render(html);
        }
        
        function buildIngredientCard(ing, isSelected) {
            var selectedStyle = isSelected ? 'border: 2px solid #25D366; background: rgba(37,211,102,0.1);' : 'border: 2px solid #2a3942;';
            var checkMark = isSelected ? '<div style="position: absolute; top: 5px; right: 5px; background: #25D366; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">‚úì</div>' : '';
            var priceTag = ing.included ? '<span style="color: #25D366; font-size: 11px;">Included</span>' : '<span style="color: #8696a0; font-size: 11px;">+$' + ing.price.toFixed(2) + '</span>';
            
            return '<div data-action="toggle_custom_topping" data-value="' + ing.id + '" style="position: relative; ' + selectedStyle + ' border-radius: 12px; padding: 10px; cursor: pointer; text-align: center;">' +
                checkMark +
                '<img src="' + ing.image + '" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-bottom: 6px;" onerror="this.src=\'https://placehold.co/60x60/333/888?text=' + encodeURIComponent(ing.name.charAt(0)) + '\'">' +
                '<div style="font-size: 13px; font-weight: 600;">' + ing.name + '</div>' +
                priceTag +
                '</div>';
        }
        
        function toggleCustomTopping(toppingId) {
            // Don't allow removing mozzarella (it's included)
            if (toppingId === 'mozzarella') return;
            
            var index = state.customPizzaToppings.indexOf(toppingId);
            if (index === -1) {
                state.customPizzaToppings.push(toppingId);
            } else {
                state.customPizzaToppings.splice(index, 1);
            }
            showCustomPizzaPage();
        }
        
        function calculateCustomPizzaPrice() {
            var ingredients = getCustomPizzaIngredients();
            var allIngredients = [].concat(ingredients.cheese, ingredients.meats, ingredients.veggies);
            var total = 0;
            state.customPizzaToppings.forEach(function(tid) {
                var ing = allIngredients.find(function(i) { return i.id === tid; });
                if (ing && !ing.included) {
                    total += ing.price;
                }
            });
            return total;
        }
        
        // PAGE: Custom Pizza Size Selection
        function showCustomPizzaSizePage() {
            var basePrice = 12.99 + calculateCustomPizzaPrice();
            var sizes = getSizePrices(basePrice);
            
            // Show selected toppings
            var ingredients = getCustomPizzaIngredients();
            var allIngredients = [].concat(ingredients.cheese, ingredients.meats, ingredients.veggies);
            
            var html = '<div class="page-title">üçï Choose Size</div>';
            
            // Show pizza preview with toppings
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Your Custom Pizza</div>' +
                '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
            
            // Always show mozzarella
            html += '<div style="display: flex; align-items: center; gap: 4px; background: #2a3942; padding: 4px 10px; border-radius: 20px; font-size: 12px;">üßÄ Mozzarella</div>';
            
            state.customPizzaToppings.forEach(function(tid) {
                var ing = allIngredients.find(function(i) { return i.id === tid; });
                if (ing) {
                    var emoji = ingredients.meats.find(function(i) { return i.id === tid; }) ? 'ü•ì' : 
                               ingredients.veggies.find(function(i) { return i.id === tid; }) ? 'ü•¨' : 'üßÄ';
                    html += '<div style="display: flex; align-items: center; gap: 4px; background: #2a3942; padding: 4px 10px; border-radius: 20px; font-size: 12px;">' + emoji + ' ' + ing.name + '</div>';
                }
            });
            html += '</div></div>';
            
            html += '<div class="section-header">SELECT SIZE</div>';
            
            // Size buttons
            ['S', 'M', 'L', 'XL'].forEach(function(sizeKey) {
                var size = sizes[sizeKey];
                var popularClass = size.popular ? ' popular' : '';
                var popularTag = size.popular ? '<span class="popular-tag">POPULAR</span>' : '';
                
                html += '<div class="size-btn' + popularClass + '" data-action="add_custom_pizza" data-value="' + sizeKey + '">' +
                    '<div>' +
                    '<span class="size-label">' + size.label + '</span>' +
                    '<span class="size-name">' + size.name + '</span>' +
                    popularTag +
                    '</div>' +
                    '<div class="size-price">$' + size.price.toFixed(2) + '</div>' +
                    '</div>';
            });
            
            html += '<div class="buttons" style="margin-top: 20px;">' +
                '<button class="btn" data-action="custom_pizza">‚Üê Back to Toppings</button>' +
                '</div>';
            
            render(html);
        }
        
        function addCustomPizzaToCart(sizeKey) {
            var basePrice = 12.99 + calculateCustomPizzaPrice();
            var sizes = getSizePrices(basePrice);
            var size = sizes[sizeKey];
            var sizeNames = { 'S': 'Small', 'M': 'Medium', 'L': 'Large', 'XL': 'X-Large' };
            
            // Get topping names
            var ingredients = getCustomPizzaIngredients();
            var allIngredients = [].concat(ingredients.cheese, ingredients.meats, ingredients.veggies);
            var toppingNames = state.customPizzaToppings.map(function(tid) {
                var ing = allIngredients.find(function(i) { return i.id === tid; });
                return ing ? ing.name : '';
            }).filter(Boolean);
            
            var name = 'Custom Pizza (' + sizeNames[sizeKey] + ')';
            
            state.cart.push({
                id: 'custom_' + sizeKey + '_' + Date.now(),
                name: name,
                toppings: ['Mozzarella'].concat(toppingNames),
                price: size.price,
                isCustom: true
            });
            
            updateCart();
            state.customPizzaToppings = []; // Reset for next time
            renderPage('item_added');
        }
        
        // PAGE: Item Added Confirmation
        function showItemAdded() {
            var lastItem = state.cart[state.cart.length - 1];
            var total = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            // Get topping names if any
            var toppingNames = '';
            if (lastItem.toppings && lastItem.toppings.length > 0) {
                if (lastItem.isCustom) {
                    // Custom pizza - show all toppings
                    toppingNames = '<div style="font-size: 14px; color: #8696a0; margin-top: 8px; line-height: 1.6;">' + lastItem.toppings.join(', ') + '</div>';
                } else {
                    // Regular pizza with extra toppings
                    var allToppings = getToppings();
                    var names = lastItem.toppings.map(function(tid) {
                        var t = allToppings.find(function(x) { return x.id === tid; });
                        return t ? t.name : tid;
                    });
                    toppingNames = '<div style="font-size: 14px; color: #8696a0; margin-top: 6px;">+ ' + names.join(', ') + '</div>';
                }
            }
            
            var html = '<div style="text-align: center; padding-top: 40px;">' +
                '<div style="font-size: 60px; margin-bottom: 20px;">‚úÖ</div>' +
                '<div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">Added to Cart!</div>' +
                '<div style="font-size: 18px; margin-bottom: 8px;">' + lastItem.name + '</div>' +
                toppingNames +
                '<div style="font-size: 28px; font-weight: 700; color: #25D366; margin: 20px 0 30px;">$' + lastItem.price.toFixed(2) + '</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 30px;">' +
                '<div style="font-size: 14px; color: #8696a0;">Cart Total: ' + state.cart.length + ' item(s)</div>' +
                '<div style="font-size: 22px; font-weight: 700; color: #25D366;">$' + total.toFixed(2) + '</div>' +
                '</div>' +
                '<div class="buttons">' +
                '<button class="btn primary" data-action="go_checkout">‚úÖ Checkout</button>' +
                '<button class="btn" data-action="add_more">‚ûï Add More Items</button>' +
                '</div>' +
                '</div>';
            
            render(html);
        }
        
        function addToCart(itemId) {
            // Find item and add to cart
            var allItems = [];
            ['pizza', 'donair', 'wings', 'salads', 'sides', 'drinks', 'combos'].forEach(function(cat) {
                allItems = allItems.concat(getItemsForCategory(cat));
            });
            
            var item = allItems.find(function(i) { return i.id === itemId; });
            if (item) {
                state.cart.push({ id: item.id, name: item.name, price: item.price });
                updateCart();
                alert('‚úÖ Added to cart!\n\n' + item.name + ' - $' + item.price.toFixed(2));
            }
        }
        
        function viewSpecial(specialId) {
            var special = state.specials.find(function(s) { return s.id === specialId; });
            if (!special) {
                // Fallback specials data
                var fallbackSpecials = {
                    's1': { id: 's1', tag: 'üî• Most Popular', name: 'Family Feast Deal', desc: '2 Large Pizzas + Wings + 2L Pop', oldPrice: 54.99, newPrice: 39.99, image: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop' },
                    's2': { id: 's2', tag: '‚ö° Limited Time', name: 'Lunch Special', desc: 'Medium 2-Topping Pizza + Can Pop', oldPrice: 18.99, newPrice: 12.99, image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop' },
                    's3': { id: 's3', tag: '‚ù§Ô∏è Customer Favorite', name: 'Wing Wednesday', desc: '2 lbs Wings + Fries + Dip', oldPrice: 28.99, newPrice: 19.99, image: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400&h=200&fit=crop' }
                };
                special = fallbackSpecials[specialId];
            }
            
            if (special) {
                state.selectedSpecial = special;
                renderPage('special_detail');
            }
        }
        
        function addSpecialToCart(specialId) {
            var special = state.selectedSpecial || state.specials.find(function(s) { return s.id === specialId; });
            if (!special) {
                var fallbackSpecials = {
                    's1': { name: 'Family Feast Deal', newPrice: 39.99 },
                    's2': { name: 'Lunch Special', newPrice: 12.99 },
                    's3': { name: 'Wing Wednesday', newPrice: 19.99 }
                };
                special = fallbackSpecials[specialId];
                special.id = specialId;
            }
            
            if (special) {
                state.cart.push({ id: special.id + '_' + Date.now(), name: special.name, price: special.newPrice });
                updateCart();
                renderPage('item_added');
            }
        }
        
        function showCartPage() {
            if (state.cart.length === 0) {
                var emptyHtml = '<div class="page-title">üõí Your Cart</div>' +
                    '<div style="text-align: center; padding: 40px 20px;">' +
                    '<div style="font-size: 60px; margin-bottom: 20px;">üõí</div>' +
                    '<div style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">Your cart is empty</div>' +
                    '<div style="font-size: 14px; color: #8696a0; margin-bottom: 30px;">Add some delicious items!</div>' +
                    '<div class="buttons"><button class="btn primary" data-action="show_menu">üìã Browse Menu</button></div>' +
                    '</div>';
                render(emptyHtml);
                return;
            }
            
            var total = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            var html = '<div class="page-title">üõí Your Cart</div>';
            
            // Cart items with remove button
            state.cart.forEach(function(item, index) {
                html += '<div style="background: #202c33; border-radius: 12px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px;">' +
                    '<div style="flex: 1;">' +
                    '<div style="font-size: 15px; font-weight: 600;">' + item.name + '</div>' +
                    '<div style="font-size: 16px; font-weight: 700; color: #25D366; margin-top: 4px;">$' + item.price.toFixed(2) + '</div>' +
                    '</div>' +
                    '<div class="remove-btn" data-action="remove_item" data-value="' + index + '" style="background: #ff4444; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px;">√ó</div>' +
                    '</div>';
            });
            
            // Add more items button
            html += '<button class="btn" data-action="show_menu" style="margin-top: 10px; margin-bottom: 20px;">‚ûï Add More Items</button>';
            
            // Order summary
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 8px;">' +
                '<span>Subtotal (' + state.cart.length + ' item' + (state.cart.length > 1 ? 's' : '') + ')</span><span>$' + total.toFixed(2) + '</span></div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 8px;">' +
                '<span>Delivery</span><span style="color: #25D366;">FREE</span></div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700; padding-top: 12px; border-top: 1px solid #2a3942;">' +
                '<span>Total</span><span style="color: #25D366;">$' + total.toFixed(2) + '</span></div>' +
                '</div>';
            
            html += '<div class="buttons">' +
                '<button class="btn primary" data-action="checkout">‚úÖ Proceed to Checkout</button>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Tip Selection
        function showTipPage() {
            var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            var html = '<div class="page-title">üöó Add a Tip?</div>' +
                '<div style="background: linear-gradient(135deg, #1a2530, #0d1820); border: 1px solid #25D366; border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">' +
                '<div style="font-size: 40px; margin-bottom: 12px;">üíö</div>' +
                '<div style="font-size: 15px; color: #e9edef; line-height: 1.7;">' +
                'Your driver keeps <b style="color: #25D366;">100%</b> of tips.<br>' +
                '<span style="font-size: 13px; color: #8696a0;">Many are newcomers to Canada, working hard to build a better life for their families.</span>' +
                '</div>' +
                '</div>';
            
            // Percentage-based tip options
            var tipOptions = [
                { percent: 0, label: 'No Tip', emoji: '' },
                { percent: 15, label: '15%', emoji: 'üëç' },
                { percent: 18, label: '18%', emoji: 'üôè' },
                { percent: 20, label: '20%', emoji: '‚≠ê' },
                { percent: 25, label: '25%', emoji: 'üåü' }
            ];
            
            tipOptions.forEach(function(tip) {
                var tipAmount = Math.round(subtotal * tip.percent) / 100;
                var total = subtotal + tipAmount;
                var btnClass = tip.percent === 18 ? 'btn primary' : 'btn';
                var tipDisplay = tip.percent > 0 ? '$' + tipAmount.toFixed(2) : '';
                
                html += '<button class="' + btnClass + '" style="margin-bottom: 10px; display: flex; justify-content: space-between; width: 100%;" data-action="set_tip_percent" data-value="' + tip.percent + '">' +
                    '<span>' + tip.emoji + ' ' + tip.label + (tipDisplay ? ' (' + tipDisplay + ')' : '') + '</span>' +
                    '<span style="color: ' + (tip.percent === 0 ? '#8696a0' : '#25D366') + ';">Total: $' + total.toFixed(2) + '</span>' +
                    '</button>';
            });
            
            // Custom tip button
            html += '<button class="btn" style="margin-bottom: 10px; margin-top: 10px;" data-action="custom_tip">‚úèÔ∏è Custom Amount</button>';
            
            render(html);
        }
        
        // PAGE: Custom Tip Input
        function showCustomTipPage() {
            var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            var html = '<div class="page-title">‚úèÔ∏è Custom Tip</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-size: 14px; color: #8696a0; margin-bottom: 8px;">Order Subtotal</div>' +
                '<div style="font-size: 24px; font-weight: 700;">$' + subtotal.toFixed(2) + '</div>' +
                '</div>' +
                '<div class="section-header">ENTER TIP AMOUNT</div>' +
                '<div class="input-bubble">' +
                '<input type="number" id="custom_tip_input" placeholder="Enter tip amount (e.g. 5.00)" style="font-size: 20px; text-align: center;" min="0" step="0.50">' +
                '<button class="btn primary input-submit" data-input="custom_tip_input" data-action="submit_custom_tip">Continue</button>' +
                '</div>' +
                '<div style="text-align: center; margin-top: 16px;">' +
                '<button class="btn" data-action="show_tip_page" style="width: auto; padding: 12px 24px;">‚Üê Back to Tip Options</button>' +
                '</div>';
            
            render(html);
        }
        
        // PAGE: Payment Selection
        function showPaymentPage() {
            var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            // Calculate discount for first time customers
            var discount = 0;
            var deliveryFee = 0;
            if (state.firstOrderDiscount) {
                discount = Math.round(subtotal * state.discountPercent) / 100;
                deliveryFee = 0; // Free delivery
            }
            
            var total = subtotal - discount + deliveryFee + state.tip;
            
            var html = '<div class="page-title">üí≥ Payment</div>';
            
            // If single item, show image
            if (state.cart.length === 1) {
                var item = state.cart[0];
                var itemImage = getItemImage(item);
                if (itemImage) {
                    html += '<img src="' + itemImage + '" style="width: 100%; height: 150px; object-fit: cover; border-radius: 12px; margin-bottom: 16px;" onerror="this.style.display=\'none\'">';
                }
            }
            
            // First order discount banner
            if (state.firstOrderDiscount) {
                html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 12px; padding: 14px; margin-bottom: 16px; text-align: center;">' +
                    '<div style="font-size: 14px; font-weight: 700;">üéâ First Order Discount Applied!</div>' +
                    '<div style="font-size: 13px; opacity: 0.95;">FREE Delivery + 10% OFF = You save $' + (discount + 6.99).toFixed(2) + '</div>' +
                    '</div>';
            }
            
            // Order summary
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #8696a0;">ORDER SUMMARY</div>';
            
            state.cart.forEach(function(item) {
                html += '<div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px;">' +
                    '<span>' + item.name + '</span>' +
                    '<span>$' + item.price.toFixed(2) + '</span></div>';
            });
            
            html += '<div style="border-top: 1px solid #2a3942; margin-top: 12px; padding-top: 12px;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                '<span>Subtotal</span><span>$' + subtotal.toFixed(2) + '</span></div>';
            
            // Show discount if applicable
            if (state.firstOrderDiscount && discount > 0) {
                html += '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #25D366; margin-bottom: 6px;">' +
                    '<span>üéÅ First Order (10% OFF)</span><span>-$' + discount.toFixed(2) + '</span></div>';
            }
            
            // Delivery
            html += '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                '<span>Delivery</span>';
            if (state.firstOrderDiscount) {
                html += '<span><span style="text-decoration: line-through; margin-right: 8px;">$6.99</span><span style="color: #25D366;">FREE</span></span>';
            } else {
                html += '<span style="color: #25D366;">FREE</span>';
            }
            html += '</div>';
            
            if (state.tip > 0) {
                var tipPercent = Math.round((state.tip / subtotal) * 100);
                html += '<div style="display: flex; justify-content: space-between; font-size: 14px; color: #8696a0; margin-bottom: 6px;">' +
                    '<span>Driver Tip (' + tipPercent + '%)</span><span>$' + state.tip.toFixed(2) + '</span></div>';
            }
            
            html += '<div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700; margin-top: 12px;">' +
                '<span>Total</span><span style="color: #25D366;">$' + total.toFixed(2) + '</span></div>';
            
            // Show savings
            if (state.firstOrderDiscount) {
                html += '<div style="text-align: center; margin-top: 10px; font-size: 13px; color: #25D366; font-weight: 600;">' +
                    'üíö You\'re saving $' + (discount + 6.99).toFixed(2) + ' on this order!' +
                    '</div>';
            }
            
            html += '</div></div>';
            
            // Customer & Delivery info
            var customerAddress = state.customer && state.customer.address ? state.customer.address : 'Your location';
            var customerName = state.customer && state.customer.name ? state.customer.name : 'Guest';
            var customerPhone = state.customer && state.customer.phone ? formatPhone(state.customer.phone) : '';
            var deliveryTime = state.restaurant && state.restaurant.time ? state.restaurant.time : '30-40 min';
            
            html += '<div style="background: #202c33; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
                '<div style="font-size: 12px; font-weight: 600; margin-bottom: 12px; color: #8696a0; text-transform: uppercase; letter-spacing: 1px;">üìã CONTACT & DELIVERY</div>' +
                '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #2a3942;">' +
                '<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700;">' + 
                customerName.charAt(0).toUpperCase() + '</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 15px; font-weight: 600;">' + customerName + '</div>' +
                '<div style="font-size: 13px; color: #25D366;">' + customerPhone + '</div>' +
                '</div>' +
                '</div>' +
                '<div style="font-size: 15px; margin-bottom: 6px;">üìç ' + customerAddress + '</div>' +
                '<div style="font-size: 14px; color: #8696a0;">üïê Est. ' + deliveryTime + '</div>' +
                '</div>';
            
            // Payment methods section
            html += '<div class="section-header">SELECT PAYMENT METHOD</div>';
            
            // Credit Card option
            html += '<div class="payment-option" data-action="show_credit_cards" style="background: #202c33; border: 2px solid #2a3942; border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 14px;">' +
                '<div style="font-size: 28px;">üí≥</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 16px; font-weight: 600;">Credit Card</div>' +
                '<div style="font-size: 12px; color: #8696a0;">Visa, Mastercard, Amex</div>' +
                '</div>' +
                '<div style="font-size: 20px; color: #8696a0;">‚Ä∫</div>' +
                '</div>';
            
            // Debit Card option
            html += '<div class="payment-option" data-action="pay_debit" style="background: #202c33; border: 2px solid #2a3942; border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 14px;">' +
                '<div style="font-size: 28px;">üè¶</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 16px; font-weight: 600;">Debit Card</div>' +
                '<div style="font-size: 12px; color: #8696a0;">Interac, Bank Card</div>' +
                '</div>' +
                '<div style="font-size: 20px; color: #8696a0;">‚Ä∫</div>' +
                '</div>';
            
            // Cash on Delivery option
            if (state.codAllowed) {
                html += '<div class="payment-option" data-action="pay_cash" style="background: #202c33; border: 2px solid #2a3942; border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 14px;">' +
                    '<div style="font-size: 28px;">üíµ</div>' +
                    '<div style="flex: 1;">' +
                    '<div style="font-size: 16px; font-weight: 600;">Cash on Delivery</div>' +
                    '<div style="font-size: 12px; color: #8696a0;">Pay when order arrives</div>' +
                    '</div>' +
                    '<div style="font-size: 20px; color: #8696a0;">‚Ä∫</div>' +
                    '</div>';
            } else {
                html += '<div style="background: #2a2a2a; border: 2px solid #3a3a3a; border-radius: 12px; padding: 16px; margin-bottom: 10px; opacity: 0.6;">' +
                    '<div style="display: flex; align-items: center; gap: 14px;">' +
                    '<div style="font-size: 28px;">üíµ</div>' +
                    '<div style="flex: 1;">' +
                    '<div style="font-size: 16px; font-weight: 600; color: #666;">Cash on Delivery</div>' +
                    '<div style="font-size: 12px; color: #ff6b6b;">‚ö†Ô∏è ' + (state.codBlockReason || 'Not available') + '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            }
            
            // Show last order info if returning customer
            if (state.lastOrders && state.lastOrders.length > 0) {
                var lastOrder = state.lastOrders[0];
                html += '<div style="background: #1a2a1a; border: 1px solid #25D366; border-radius: 12px; padding: 14px; margin-top: 16px;">' +
                    '<div style="font-size: 12px; color: #25D366; margin-bottom: 6px;">üîÑ RETURNING CUSTOMER</div>' +
                    '<div style="font-size: 13px; color: #8696a0;">Last order: ' + (lastOrder.restaurant_name || 'Previous restaurant') + '</div>' +
                    '<div style="font-size: 13px; color: #8696a0;">Payment: ' + (lastOrder.payment_method === 'cash' ? 'üíµ Cash' : 'üí≥ Card') + '</div>' +
                    '</div>';
            }
            
            render(html);
        }
        
        // PAGE: Credit Card Selection
        function showCreditCardPage() {
            var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            var total = subtotal + state.tip;
            
            var html = '<div class="page-title">üí≥ Select Card</div>';
            
            // Card options
            var cards = [
                { id: 'visa', name: 'Visa', icon: 'üí≥', color: '#1a1f71' },
                { id: 'mastercard', name: 'Mastercard', icon: 'üí≥', color: '#eb001b' },
                { id: 'amex', name: 'American Express', icon: 'üí≥', color: '#006fcf' },
                { id: 'discover', name: 'Discover', icon: 'üí≥', color: '#ff6000' }
            ];
            
            cards.forEach(function(card) {
                html += '<div class="payment-option" data-action="pay_credit" data-value="' + card.id + '" style="background: #202c33; border: 2px solid #2a3942; border-radius: 12px; padding: 16px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 14px;">' +
                    '<div style="width: 50px; height: 32px; background: ' + card.color + '; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üí≥</div>' +
                    '<div style="flex: 1;">' +
                    '<div style="font-size: 16px; font-weight: 600;">' + card.name + '</div>' +
                    '</div>' +
                    '<div style="font-size: 16px; font-weight: 700; color: #25D366;">$' + total.toFixed(2) + '</div>' +
                    '</div>';
            });
            
            html += '<div class="buttons" style="margin-top: 20px;">' +
                '<button class="btn" data-action="go_to_payment">‚Üê Back to Payment Options</button>' +
                '</div>';
            
            render(html);
        }
        
        // Helper to get item image
        function getItemImage(cartItem) {
            // Custom pizza
            if (cartItem.isCustom) {
                return 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=400&h=200&fit=crop';
            }
            
            // Check if it's a special
            if (cartItem.id && cartItem.id.startsWith('s')) {
                var specialImages = {
                    's1': 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&h=200&fit=crop',
                    's2': 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400&h=200&fit=crop',
                    's3': 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400&h=200&fit=crop'
                };
                var specialId = cartItem.id.split('_')[0];
                return specialImages[specialId];
            }
            
            // Check menu items
            var itemId = cartItem.id ? cartItem.id.split('_')[0] : '';
            var allItems = [];
            ['pizza', 'donair', 'wings', 'salads', 'sides', 'drinks', 'combos'].forEach(function(cat) {
                allItems = allItems.concat(getItemsForCategory(cat));
            });
            var found = allItems.find(function(i) { return i.id === itemId; });
            return found ? found.image : null;
        }
        
        // Process Payment
        function processPayment(method, cardType) {
            var subtotal = state.cart.reduce(function(s, i) { return s + i.price; }, 0);
            
            // Calculate discount for first time customers
            var discount = 0;
            if (state.firstOrderDiscount) {
                discount = Math.round(subtotal * state.discountPercent) / 100;
            }
            
            var total = subtotal - discount + state.tip;
            
            state.paymentMethod = method;
            state.orderNumber = 'LF-' + Math.floor(Math.random() * 9000 + 1000);
            state.orderTotal = total;
            state.orderDiscount = discount;
            
            // Determine display method
            var displayMethod = method;
            if (method === 'credit' && cardType) {
                displayMethod = cardType;
            }
            state.displayPaymentMethod = displayMethod;
            
            if (method !== 'cash') {
                // Show processing for card payments
                var cardName = {
                    'debit': 'Debit Card',
                    'visa': 'Visa',
                    'mastercard': 'Mastercard',
                    'amex': 'American Express',
                    'discover': 'Discover',
                    'card': 'Card',
                    'credit': 'Credit Card'
                };
                
                var html = '<div style="text-align: center; padding-top: 60px;">' +
                    '<div class="spinner" style="width: 50px; height: 50px; border-width: 4px; margin: 0 auto 20px;"></div>' +
                    '<div style="font-size: 20px; font-weight: 600;">Processing ' + (cardName[displayMethod] || 'Payment') + '...</div>' +
                    '<div style="font-size: 14px; color: #8696a0; margin-top: 10px;">Please wait</div>' +
                    '</div>';
                render(html);
                
                // Simulate payment processing then save order
                setTimeout(function() {
                    // Save order to database
                    saveOrderToDatabase({
                        orderNumber: state.orderNumber,
                        total: total,
                        discount: discount,
                        paymentMethod: displayMethod
                    });
                    
                    // Mark first order discount as used
                    if (state.firstOrderDiscount) {
                        localStorage.setItem('localfirst_first_order_used', 'true');
                    }
                    
                    renderPage('confirmed');
                }, 2000);
            } else {
                // Cash on delivery - save order and go to confirmation
                saveOrderToDatabase({
                    orderNumber: state.orderNumber,
                    total: total,
                    discount: discount,
                    paymentMethod: 'cash'
                });
                
                // Mark first order discount as used
                if (state.firstOrderDiscount) {
                    localStorage.setItem('localfirst_first_order_used', 'true');
                }
                
                renderPage('confirmed');
            }
        }
        
        // PAGE: Order Confirmed
        function showConfirmedPage() {
            var total = state.orderTotal || state.cart.reduce(function(s, i) { return s + i.price; }, 0) + state.tip;
            var isCash = state.paymentMethod === 'cash';
            var deliveryTime = state.restaurant && state.restaurant.time ? state.restaurant.time : '30-40 min';
            
            // Parse delivery time to get end time for timeline
            var timeMatch = deliveryTime.match(/(\d+)-(\d+)/);
            var prepTime = timeMatch ? Math.round(parseInt(timeMatch[1]) * 0.4) : 15;
            var pickupTime = timeMatch ? Math.round(parseInt(timeMatch[1]) * 0.7) : 25;
            var deliverTime = timeMatch ? timeMatch[2] : 40;
            
            // Assign a driver
            var drivers = [
                {
                    name: 'Ahmed',
                    image: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAAAAAAD/4gv4SUNDX1BST0ZJTEUAAQEAAAvoAAAAAAIAAABtbnRyUkdCIFhZWiAH2QADABsAFQAkAB9hY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAA9tYAAQAAAADTLQAAAAAp+D3er/JVrnhC+uTKgzkNAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBkZXNjAAABRAAAAHliWFlaAAABwAAAABRiVFJDAAAB1AAACAxkbWRkAAAJ4AAAAIhnWFlaAAAKaAAAABRnVFJDAAAB1AAACAxsdW1pAAAKfAAAABRtZWFzAAAKkAAAACRia3B0AAAKtAAAABRyWFlaAAAKyAAAABRyVFJDAAAB1AAACAx0ZWNoAAAK3AAAAAx2dWVkAAAK6AAAAId3dHB0AAALcAAAABRjcHJ0AAALhAAAADdjaGFkAAALvAAAACxkZXNjAAAAAAAAAB9zUkdCIElFQzYxOTY2LTItMSBibGFjayBzY2FsZWQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWFlaIAAAAAAAACSgAAAPhAAAts9jdXJ2AAAAAAAABAAAAAAFAAoADwAUABkAHgAjACgALQAyADcAOwBAAEUASgBPAFQAWQBeAGMAaABtAHIAdwB8AIEAhgCLAJAAlQCaAJ8ApACpAK4AsgC3ALwAwQDGAMsA0ADVANsA4ADlAOsA8AD2APsBAQEHAQ0BEwEZAR8BJQErATIBOAE+AUUBTAFSAVkBYAFnAW4BdQF8AYMBiwGSAZoBoQGpAbEBuQHBAckB0QHZAeEB6QHyAfoCAwIMAhQCHQImAi8COAJBAksCVAJdAmcCcQJ6AoQCjgKYAqICrAK2AsECywLVAuAC6wL1AwADCwMWAyEDLQM4A0MDTwNaA2YDcgN+A4oDlgOiA64DugPHA9MD4APsA/kEBgQTBCAELQQ7BEgEVQRjBHEEfgSMBJoEqAS2BMQE0wThBPAE/gUNBRwFKwU6BUkFWAVnBXcFhgWWBaYFtQXFBdUF5QX2BgYGFgYnBjcGSAZZBmoGewaMBp0GrwbABtEG4wb1BwcHGQcrBz0HTwdhB3QHhgeZB6wHvwfSB+UH+AgLCB8IMghGCFoIbgiCCJYIqgi+CNII5wj7CRAJJQk6CU8JZAl5CY8JpAm6Cc8J5Qn7ChEKJwo9ClQKagqBCpgKrgrFCtwK8wsLCyILOQtRC2kLgAuYC7ALyAvhC/kMEgwqDEMMXAx1DI4MpwzADNkM8w0NDSYNQA1aDXQNjg2pDcMN3g34DhMOLg5JDmQOfw6bDrYO0g7uDwkPJQ9BD14Peg+WD7MPzw/sEAkQJhBDEGEQfhCbELkQ1xD1ERMRMRFPEW0RjBGqEckR6BIHEiYSRRJkEoQSoxLDEuMTAxMjE0MTYxODE6QTxRPlFAYUJxRJFGoUixStFM4U8BUSFTQVVhV4FZsVvRXgFgMWJhZJFmwWjxayFtYW+hcdF0EXZReJF64X0hf3GBsYQBhlGIoYrxjVGPoZIBlFGWsZkRm3Gd0aBBoqGlEadxqeGsUa7BsUGzsbYxuKG7Ib2hwCHCocUhx7HKMczBz1HR4dRx1wHZkdwx3sHhYeQB5qHpQevh7pHxMfPh9pH5Qfvx/qIBUgQSBsIJggxCDwIRwhSCF1IaEhziH7IiciVSKCIq8i3SMKIzgjZiOUI8Ij8CQfJE0kfCSrJNolCSU4JWgllyXHJfcmJyZXJocmtyboJxgnSSd6J6sn3CgNKD8ocSiiKNQpBik4KWspnSnQKgIqNSpoKpsqzysCKzYraSudK9EsBSw5LG4soizXLQwtQS12Last4S4WLkwugi63Lu4vJC9aL5Evxy/+MDUwbDCkMNsxEjFKMYIxujHyMioyYzKbMtQzDTNGM38zuDPxNCs0ZTSeNNg1EzVNNYc1wjX9Njc2cjauNuk3JDdgN5w31zgUOFA4jDjIOQU5Qjl/Obw5+To2OnQ6sjrvOy07azuqO+g8JzxlPKQ84z0iPWE9oT3gPiA+YD6gPuA/IT9hP6I/4kAjQGRApkDnQSlBakGsQe5CMEJyQrVC90M6Q31DwEQDREdEikTORRJFVUWaRd5GIkZnRqtG8Ec1R3tHwEgFSEtIkUjXSR1JY0mpSfBKN0p9SsRLDEtTS5pL4kwqTHJMuk0CTUpNk03cTiVObk63TwBPSU+TT91QJ1BxULtRBlFQUZtR5lIxUnxSx1MTU19TqlP2VEJUj1TbVShVdVXCVg9WXFapVvdXRFeSV+BYL1h9WMtZGllpWbhaB1pWWqZa9VtFW5Vb5Vw1XIZc1l0nXXhdyV4aXmxevV8PX2Ffs2AFYFdgqmD8YU9homH1YklinGLwY0Njl2PrZEBklGTpZT1lkmXnZj1mkmboZz1nk2fpaD9olmjsaUNpmmnxakhqn2r3a09rp2v/bFdsr20IbWBtuW4SbmtuxG8eb3hv0XArcIZw4HE6cZVx8HJLcqZzAXNdc7h0FHRwdMx1KHWFdeF2Pnabdvh3VnezeBF4bnjMeSp5iXnnekZ6pXsEe2N7wnwhfIF84X1BfaF+AX5ifsJ/I3+Ef+WAR4CogQqBa4HNgjCCkoL0g1eDuoQdhICE44VHhauGDoZyhteHO4efiASIaYjOiTOJmYn+imSKyoswi5aL/IxjjMqNMY2Yjf+OZo7OjzaPnpAGkG6Q1pE/kaiSEZJ6kuOTTZO2lCCUipT0lV+VyZY0lp+XCpd1l+CYTJi4mSSZkJn8mmia1ZtCm6+cHJyJnPedZJ3SnkCerp8dn4uf+qBpoNihR6G2oiailqMGo3aj5qRWpMelOKWpphqmi6b9p26n4KhSqMSpN6mpqhyqj6sCq3Wr6axcrNCtRK24ri2uoa8Wr4uwALB1sOqxYLHWskuywrM4s660JbSctRO1irYBtnm28Ldot+C4WbjRuUq5wro7urW7LrunvCG8m70VvY++Cr6Evv+/er/1wHDA7MFnwePCX8Lbw1jD1MRRxM7FS8XIxkbGw8dBx7/IPci8yTrJuco4yrfLNsu2zDXMtc01zbXONs62zzfPuNA50LrRPNG+0j/SwdNE08bUSdTL1U7V0dZV1tjXXNfg2GTY6Nls2fHadtr724DcBdyK3RDdlt4c3qLfKd+v4DbgveFE4cziU+Lb42Pj6+Rz5PzlhOYN5pbnH+ep6DLovOlG6dDqW+rl63Dr++yG7RHtnO4o7rTvQO/M8Fjw5fFy8f/yjPMZ86f0NPTC9VD13vZt9vv3ivgZ+Kj5OPnH+lf65/t3/Af8mP0p/br+S/7c/23//2Rlc2MAAAAAAAAALklFQyA2MTk2Ni0yLTEgRGVmYXVsdCBSR0IgQ29sb3VyIFNwYWNlIC0gc1JHQgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYWVogAAAAAAAAYpkAALeFAAAY2lhZWiAAAAAAAAAAAABQAAAAAAAAbWVhcwAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACWFlaIAAAAAAAAAMWAAADMwAAAqRYWVogAAAAAAAAb6IAADj1AAADkHNpZyAAAAAAQ1JUIGRlc2MAAAAAAAAALVJlZmVyZW5jZSBWaWV3aW5nIENvbmRpdGlvbiBpbiBJRUMgNjE5NjYtMi0xAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYWVogAAAAAAAA9tYAAQAAAADTLXRleHQAAAAAQ29weXJpZ2h0IEludGVybmF0aW9uYWwgQ29sb3IgQ29uc29ydGl1bSwgMjAwOQAAc2YzMgAAAAAAAQxEAAAF3///8yYAAAeUAAD9j///+6H///2iAAAD2wAAwHX/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wAARCABxAMgDAREAAhEBAxEB/8QAGwAAAQUBAQAAAAAAAAAAAAAAAAIEBQYHAQP/xABNEAABAwMBBAMIDQkGBwAAAAABAAIDBAUREgYHITETQVEUImFxgZLC0hUXIzJCUlNUg5GTodEWJCVERWJysbImMzVDc8E0Y2SCo+Hw/8QAGgEBAAMBAQEAAAAAAAAAAAAAAAEDBAIFBv/EAC0RAAICAQMDBAEDBQEBAAAAAAABAhEDBBIhBTFRIjJBYRNxodEjUoGRseHx/9oADAMBAAIRAxEAPwDZkAICHv8AenWdkRb0ZMmrg/wY/FSjluij1u9C608rmsoqXSORcHH/AHUE8jB29u9A8KWg8x/rIORPtuXz5rQeY/1kJOe29fPmtB5j/WQmhB3wXwfq1u8x/rIKEHfHfB/kW3zH+sgoT7ct8+Qtv2b/AFkBz257583t32b/AFkA6tm9u+V9fHT9zUGDknTG/OAP4lXknsg5GnSYFnzLG+w5vO9yttPuQgpJqkj+7DXYb4+Kox5ck/B6Gq0elwKrbfjj+CB9uzal3vbfbcf6cnrLRuPL2eEKi337RMkHdFut7mZ4hjHg/wBSht1wdQjBP1p19Frt+8qsudKKimbSkHmCx2WnsPFZ3nnF00e5h6Zpc0d0ZP8Ab+CLvW9a+WqtbCKe3lr4w8FzH56wfhdoWjHPfGzyNdplp82yPYj/AG6b583tv2b/AFlYYzvt0Xz5tbfMf6yEB7c9+PKmtvmP9ZAdG+W/n9Ut32b/AFlIPRm+DaB3Okt/2b/WQgu2wO19ZtU2uFZFAx1Nox0IIzq1dpPYoBcUJBACAEBle+mtkozZjG4t1dNnH/YhDVmXPvr3NxI3UVDR0iOluMzzww3xKQeTqmY85CgEGV55uP1oBOs9qANSANSAWJEA+tlwloXTTU4zUOZ0cZPwcnifHwVc47lTNWmyvC5TXeuP8j+3WOeoqiat3fk98556yqZS+IlkU5PdN8lvg2Q1xZiayTA44PFVVItuJGXPY2qax0kVOQMLpSce5DipFeon3Gw3LpI4HuH+ZEQcParHtmhgzZNNO12+T12srqevloqimOWGFwIPNpDjwPhGV3hW1NHXUssc0ozj8or+pXHlhqQg6EB0Oc3kSgPZlXKBp1ZQGubi3l/s3k/IemgNcQAgBACAyDfwS32DP+v6CAyEkOCgkAztQHC3CAQVIEoAQAgAcEBcNj6Wlr7RWQTRQiZtVEYZiO/JPwc9mMqnI2pIvxq4Mnr3s7PUV0hihZoDnZkle5rWNzwwG8T41SpUy7Y5IRsdTVltv/czJNdPKcFwzjh2Z6kk7qhCLV2Se27ro+4ww0kkrIjwGiUR6j4yuYvl2dOLrgNnqSr7r6KuhmcSMYn0vBHa17eB8IK62xbOW5JFD2pszbW2mmdUtMtW58gpQ3jGwng4nw8eHgWmLM0+yK6uyoUEJOgoBWQgAA9QKEGvbhXavZ36D00BsCAEAIAQGR793ERWVnxnTH+hAZrZKBlRDLLJGHd8GtVcmdJCb7QimMbYIS0huXEJB2JKiFEp61YcndQI4KCQxkKQJxgZQHNYQgNfgQF73fVMUdnuri5omimgeARxLS7BVORcovxPho0mS50dJTPlnAJPDHW49ipTRppnlZCyruRqHmJknECMOyWhIr1WTN+miTuXQwQyOljbIxpy/hnA68hTJJHMG2KfPRU1AamLSGMj1DSOGAMrpbfg4lu+TBNrKuWq2kqxKHtEThExr+bWgcB95PlV8VSM03bIccF0cneSECS/sQHtRUs1ZNpj5jic9SAmm0pLMYGRwKA0XcQzo5toGH4LoPTQGvoAQAgBAZFv2/Yh7On9BAV3ZOhYy30xlHB+XnyqqaLItDW+OaKuqkx3oaeCRVIiTtlDPWe0q04FFuI2u6yVBJ6NYTw6wMoBfc0pGeifg8iGlAcFBUO97BKfEwoD1ZaK9/vKKc/RlLB2CKsoajUI5Yy0jW3BGQDnB7eSOmE6Lm9r9prUx0U2KuCZ4YzVhrzp1Nz4wCPGs69LNfviT1k2WhnqYaxlzpe6GMHSRiodC9pOBgg5SmwpRi/kf3S0VdNTdHbbjHLUzu0uYypceHHLycYwBzU00LT7WQJuclv2WbbY5zW1MkT9LcHOHe9bjxcfEuYr1WJyqBR5bNdqqrlqJ6GofLK8vcdB4knK0WjIzxq7PW0Tm90074g/lqCJ2BgQNXgyuiDkrNDwOohASFil6O4aOp7cKGQybg750wwOD+pCUaHuZi6Kuv56nCnP9akGqoAQAgBAZHv0bqFkaOZMw/oQhnjbKMRxQQge8jA+5Q0Ivkom09yjFwr6VjMHONWetQkdFWPUF0QOZm6eiZ4MrlEnuyMx10QcBh4H1J8A1p20GzdspoYaipp2vDB3oGSFFEEnarjabtEX0EkMwHMNAyEBIdGwDg1o8igHk6jpnvJdBGSestQGWXqGfZbbESxx9HTSy9NE0e9x1j+f1pSkqO4txdlzF8mgbF3LQtr4Je+ZjS7QezjyVUbRsckzz2o2o7hsUmkdDX1LOjLA4Hom+Q44+BdxTb5K5ySVIobai9Wm3U1/YdPTyOih6RueAbxcB4uA8q6STdIole22WfYjbaqu9xNvuIYZHNzG9oxnHUolGjiyQ3iRh1mjdgZbIoj3DMl4dE054kngriBdQ3MLHjxKAecMpgnZK3m05UgsFjqH1TJukOX6sqAatuibie8nwQj+tSDTEAIAQAgMs3xxdPc9movjTS+gpRxPhHaN8cfSOcQCGnGVEiMbsyW522vnramUUVQ4vkJyIzxGVFosSY0js1ydI38wqMZ+TKWTTHNTaLiaoYoZyAPiFQiTxktdyYWP7iqCQPkzwRNEUxs63XDJLqOoyesxlTaFMntipK+2bS0zjBOyKU6JMsIGD2qGxRs2tucZGfGoIGVzvFFZqc1FdOI2fBHNzz2AdaVYKfUz/l1RT66cUzGPxTEnLuHWfrVM5bZ8GrHjbx2/nsVmnZtNaZjS07XvAdyHEFd/kgzlQnHgnrDsVdL3XNrb+dFOzBMeeMnYD4FDyKqiFBt3Ind5LaaLZmOn0ta5jw6Jo+CGjHD6wFzB1NGlY9+LI32S/wDhmNor/Ym7wV7Ig98Ts6c41eBa2kzyU2i27TbXUF+sfRwNlhnByYpB/IjgVXsaZ3+RMoDonMjY8jAdyXR0ej3ZpdPlQkb82goQTezEma5zT8IIQzYd03/EXnxw+mgRpKEggBACAzjedCZtoNnABnT3Q77mLuC5KczpEVA4iYhwII7VXmXY70ztMdh3hVJpFB3hQHQ5AGSgOalBI3rqjuahqJwM9HGXYHgCIh9jKYLvdBXd3msmaQ/WGueSD4Mdi0KJncvAi4XKqulU6qrJnSyHrd/IdgXXYhFj2ZuDqGCme7jTv1Mk/ddngV5+V/1Gj6CGJy0mOa+LT/2XKCrbSzGXvXMd2nGPCFVZRsbJZ19oqOjM8kwcPgtbxLj2BWbkkcwwTyS2xRmW2N7lukuqbDXSOGlg5MYOr61Zp05z3eDZ1CMdLpFhXeT5/wAFVceR8IW4+aR6tXSKmLcGvbpcMhdUmcJyXZnk6EFhaz6iq3GjRDI3w0MgcNIXBaSmzztNyYO1EQ+xtm6hpEl2djGei9JSzmJoyg7BACAEBn+8x7YKu01GcOY2YN8uj8FZjM2o+CH2Xqm3K8BswbIGjBBHPgpaTmrIxNrG2XfuGjH6tH5q72rwN8vIptHS/N4/NTahufkqdThlVM1owA8gDyrFJepm+PtRZaUQst8BdG0ksHUFtguEYZy9TPcwxacmKPzFNI4tmaby9pomtbZaFjGF3fVErRg4+KP91U5RbaXwa5Yp44RlJ+7n/BmL3E8MqCtCCeGFB0iasVfBBST09SyR8b850tzjisGog3O0fT9LzRWBwkm1ySdZMKmkibRzdNHEcYGdTR1ZHYqFa9x6GPDjUnLE/wDwZ/nUHfPLZP3CTn6+pWwhGaZXny5NM02rshK2oNRVve7q4eJbMMNsaPmuoah581+Bu8d4rfg89PkU13EKbIaPZpXSZW0SmzkLZrtrcMtiZq8qzaqVRo93oeFTzub+EG1Nqijd3fTxBjXH3RreWe1U4Mj9rNnVdEoL80F+v8kVZCRcYyO1a0fPy7G3bpc9Jd8uzxix4PfozmJpCg7BACAEBk2/GtfR+wuk+/6f7tC6i6K5wUirbu7/AE1NcJJa2RzBqHfaCQOHgUp+tNkbKg0jS/yxsPz7/wATvwVu6Pkq2S8ANs7CP10n6J/4Juj5GyXgqtTtFb31MrmumILiQehd+CxyVts3RdJFjptrbH3FC01ulwYAQ6J3D7lrjOKXcxShJt8Hr+VljOMV4OOro3cfuU/kiubEcM5NRS7mI7QVjq291M5OMux4v/srLi9t+T0+oP8AruH9qS/0iMc0598VaYEcLc4GSShNkrY2NkE7COtYdTw0fUdFqWOS+yUbbuhlEgOCOodY6wVl32qPaWCKe5Hq+BjYnOjBAxnHNXYW+TF1HatpUc65ZH9rifvXoRVI+MyvdJs47jwXRWhQbhALaeOFKOaJ7ZpmmOolxxcQ0LBqnckj63oWPbilPy/+E1Vwtq4JIHjIezCzptOz2skI5MbhL5KbZoHR3MxvHfRkg+RenF3yfAZYuDcX8GzbojmW8/Q+mpZxE0tQdggBACAxzf8AfsL6f0EBQaEml2epZ6d74pJqktkLHY1Bc92ddkXhlLCAOMh4dchVZYegpoex3nlQSKFPD2HzigOiCIfBPnFQTQ3uDY4bfPI0EFrOHErmftZp0cbzxX2ZtX8K2U/GOVfhfoRV1KG3Uy++Ty5q880SOfiUHRK7NkGrlaevB+9YtV2TPpOhPmcf0LBLgPEnSdvBYUfSsYV0wZRl7Xd7oyFbjT3UZdTKMcLm/hFWjPe+Nesj4BiuJ44QgCTywgAu5nwIEiyWX3O2s7XPJ/kvLzu5s+56Zj2aWKZLCX3QjPwf91Tyel9EO6lEV+kmHvZo9Y8fI/y+9elppboHxPWcX4tQ2u0uTQty5PsltGCScOgxx/jVz7nmw7GrqDoEAIAQGN7/AL9hfT+ggM/pjnZuhH/WFQvcS/ablHRwGNn5tGTpbgho7Ft2rwYHKXkTdIIW2id3QRte1vMNCryJbWW4pNzRUsrAegGpQSNbkNdsqW9sZXMuxp0jrPF/ZnFxHurX/GarMD4aLurxrJGX0eLeLFqXY8F9xHUVB2SWzh/STh8ZhWTVew97obrPJfRPTd45x1cR2uWBH1L4Iu+PayhYxvDVj/2tOnVzs8nq2TZpqXzRX2EDn2L0EfHs9Q5uOYUnDTOFzS7mEJS4EOIc/A6yAuW+C2EbaRZqE4jp4+xuory592z7zT8Qih1DLrlkI5NAC5ao0J2z2dGJGtk62ZHkK1aSXqaPn+v4rwxyeH/0uW5gYue0fjp/TW2Xc+Yx+01ZcnYIAQAgMb3/AHOw/T+ggM9pT/Z2j8FZ+Che4l+03mJ5jjY45I0j+S3nnHjeXg2ipdxALQqsnsZbh96KZrHavPPSOdIFBI0uc2m3TYPMY+tcT9ps0Md2oiUK4D3IH4jyF3hfJs6tG8Sl4Y0j4tPFa0fNSOO5FAh9YXabowjlpIWbUr0Ht9Gklqa+iwVOHFeej62RCX+TLoWdgJWzTLuz53rc+IQ/VkTGC7kcEBbVyfNt0ejBkFruOERy/KEOa0HGM+JCUwhZqn09gJVU3SNmkhuypMn4ZQwyvB4NaGhYGj7KEkrfgd0QIptR5vOVxLuX4vbY7hOYnhd4ZbciZk6ji/LpZx+v+F03NNIuW0TscCafH1PXpy7nwuJ+k1RclgIAQAgM93p7NXG/m1PoLR7JCmMvSR9KGc9OOJI7FKOW3ZT49ir621RRDYstc2fV0fdg70dvvlC7nT7F/pYL/wBAxktoxpGDqmbk/erlm+ih4PsTcbfe66hkphb9GsYz0jeH3qJZN0WqOoYtsrsgRsVfOuA+c38Vm2s07kH5FXv5B3nN/FRtZO5DO57E7QPpNENC+VxcMgPby+tVzhJrhG/QZsePLum6VFZrN3G10rZAyyyHUAR7rHz85TjhJNWatZqsGXHKMZdxhHuz21af8Bl+2i9Zakz55xsW7dltkQf0FL9tH6yWiEme1t3a7YU9wilkskjWNJyelj7P4lVmW6DSPR6fkhi1EZzdJEy7YXakuP6Ikx/qM9ZYvwz8H0z6lpf7/wBmRVx3d7Zy1LZILLNwYRkTRjt/eWvDFxXJ8/1PPDPkTg7SQybux21YO9sco+li9ZX2eU1Z07sttSc+wcvkli9ZLIS+gG7LbXH+By5z8tH6yWKCLdptq2oDzYpcdfu0frKuatGrT5Px5FJj+Pd1teWhjrNK0Odlx6WPgPOWd45eD3Ia7C405Vf6kszYTaVrQPYmQAcP7xn4qn8OTwekupaRKt/7MXDsRtMxzs2mTB/5jPxT8M/BzLqWkarf+z/gtW7HZ+8WOrvBulE6mZN0XQuc9p14155E9o5r0bs+McVGT29rNBUAEAIAQHCgOBAdCAEAIAQAgOIAQgEJBACAEAIQCEggBACAEAIDo60B1ACA/9k=',
                    vehicle: 'Honda Civic',
                    rating: 4.9,
                    deliveries: 1247,
                    story: 'Proud to deliver for LocalFirst YYC. Your order supports local Calgary families ‚Äî thank you for choosing us!',
                    flag: 'üá®üá¶'
                },
                {
                    name: 'Priya Patel',
                    image: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200&h=200&fit=crop&crop=face',
                    vehicle: 'Toyota Corolla',
                    rating: 4.8,
                    deliveries: 892,
                    story: 'Single mom, new to Canada. Working nights so I can be home when my son wakes up. Every delivery brings us closer to our dreams.',
                    flag: 'üáÆüá≥'
                },
                {
                    name: 'Emmanuel Osei',
                    image: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop&crop=face',
                    vehicle: 'Ford Focus',
                    rating: 4.9,
                    deliveries: 2103,
                    story: 'Studying nursing by day, driving by night. Sent my first paycheck home to Ghana ‚Äî mom cried. 2 more years until I graduate.',
                    flag: 'üá¨üá≠'
                },
                {
                    name: 'Maria Rodriguez',
                    image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop&crop=face',
                    vehicle: 'Hyundai Elantra',
                    rating: 4.7,
                    deliveries: 567,
                    story: 'Fled Venezuela with nothing. Canada gave us safety, now I\'m working for our future. My daughter starts school next month!',
                    flag: 'üáªüá™'
                },
                {
                    name: 'Yusuf Ibrahim',
                    image: 'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=200&h=200&fit=crop&crop=face',
                    vehicle: 'Mazda 3',
                    rating: 4.9,
                    deliveries: 1834,
                    story: 'Former teacher in Somalia. Here I deliver food, but I also deliver hope to my family. Thank you for being part of our journey.',
                    flag: 'üá∏üá¥'
                }
            ];
            // Always use Ahmed as our featured driver
            var driver = drivers[0];
            state.assignedDriver = driver;
            
            var html = '<div style="text-align: center; padding-top: 20px;">' +
                '<div style="font-size: 60px; margin-bottom: 10px;">üéâ</div>' +
                '<div style="font-size: 24px; font-weight: 800; margin-bottom: 5px;">Order Confirmed!</div>' +
                '<div style="font-size: 14px; color: #8696a0; margin-bottom: 20px;">Order #' + (state.orderNumber || 'LF-0000') + '</div>' +
                '</div>';
            
            // Driver card
            html += '<div style="background: linear-gradient(135deg, #1a2530, #0d1820); border: 2px solid #25D366; border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="font-size: 12px; color: #25D366; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px; text-align: center;">üöó YOUR DRIVER IS ON THE WAY</div>' +
                '<div style="display: flex; align-items: center; gap: 14px; margin-bottom: 14px;">' +
                '<div style="position: relative;">' +
                '<img src="' + driver.image + '" style="width: 75px; height: 75px; border-radius: 50%; object-fit: cover; border: 3px solid #25D366;" onerror="this.src=\'https://placehold.co/75x75/202c33/25D366?text=' + encodeURIComponent(driver.name.charAt(0)) + '\'">' +
                '<div style="position: absolute; bottom: -4px; right: -4px; font-size: 22px;">' + (driver.flag || 'üöó') + '</div>' +
                '</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 18px; font-weight: 700;">' + driver.name + '</div>' +
                '<div style="font-size: 12px; color: #8696a0;">üöó ' + driver.vehicle + ' ‚Ä¢ ‚≠ê ' + driver.rating + '</div>' +
                '<div style="font-size: 12px; color: #25D366;">' + driver.deliveries.toLocaleString() + ' deliveries completed</div>' +
                '</div>' +
                '</div>' +
                '<div style="background: #202c33; border-radius: 12px; padding: 14px; font-size: 14px; color: #e9edef; line-height: 1.6; text-align: center;">' +
                '"' + driver.story + '"' +
                '</div>' +
                '</div>';
            
            // Restaurant owner preparing
            var owner = state.restaurant && state.restaurant.owner ? state.restaurant.owner : null;
            html += '<div style="background: #202c33; border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 16px;">';
            
            if (owner) {
                html += '<img src="' + owner.image + '" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" onerror="this.src=\'https://placehold.co/50x50/202c33/25D366?text=üë®‚Äçüç≥\'">';
            } else {
                html += '<div style="font-size: 40px;">üë®‚Äçüç≥</div>';
            }
            
            html += '<div>' +
                '<div style="font-size: 16px; font-weight: 600;">Preparing your order</div>' +
                '<div style="font-size: 14px; color: #8696a0;">' + (owner ? owner.name + ' at ' : '') + (state.restaurant ? state.restaurant.name : 'Restaurant') + '</div>' +
                '</div></div>';
            
            // Timeline
            html += '<div style="border-left: 2px solid #25D366; margin-left: 20px; padding-left: 20px;">' +
                '<div style="margin-bottom: 15px;">' +
                '<div style="font-size: 14px; font-weight: 600; color: #25D366;">‚úì Order Received</div>' +
                '<div style="font-size: 12px; color: #8696a0;">Just now</div>' +
                '</div>' +
                '<div style="margin-bottom: 15px;">' +
                '<div style="font-size: 14px; font-weight: 600;">üçï Preparing</div>' +
                '<div style="font-size: 12px; color: #8696a0;">~' + prepTime + ' min</div>' +
                '</div>' +
                '<div style="margin-bottom: 15px;">' +
                '<div style="font-size: 14px; font-weight: 600; color: #8696a0;">üöó ' + driver.name.split(' ')[0] + ' picks up</div>' +
                '<div style="font-size: 12px; color: #8696a0;">~' + pickupTime + ' min</div>' +
                '</div>' +
                '<div>' +
                '<div style="font-size: 14px; font-weight: 600; color: #8696a0;">üìç Delivery</div>' +
                '<div style="font-size: 12px; color: #8696a0;">~' + deliverTime + ' min</div>' +
                '</div>' +
                '</div></div>';
            
            // Payment info
            var paymentDisplay = 'üí≥ Paid';
            if (isCash) {
                paymentDisplay = 'üíµ Cash on Delivery';
            } else if (state.displayPaymentMethod) {
                var methodNames = {
                    'debit': 'üè¶ Debit Card',
                    'visa': 'üí≥ Visa',
                    'mastercard': 'üí≥ Mastercard',
                    'amex': 'üí≥ Amex',
                    'discover': 'üí≥ Discover'
                };
                paymentDisplay = (methodNames[state.displayPaymentMethod] || 'üí≥ Card') + ' - Paid';
            }
            
            html += '<div style="background: #202c33; border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">' +
                '<span style="color: #8696a0;">Payment</span>' +
                '<span>' + paymentDisplay + '</span>' +
                '</div>' +
                '<div style="display: flex; justify-content: space-between;">' +
                '<span style="color: #8696a0;">Total</span>' +
                '<span style="font-size: 20px; font-weight: 700; color: #25D366;">$' + total.toFixed(2) + '</span>' +
                '</div>';
            
            // Show savings if first order discount was applied
            if (state.orderDiscount && state.orderDiscount > 0) {
                html += '<div style="background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 8px; padding: 12px; margin-top: 12px; text-align: center;">' +
                    '<div style="font-size: 13px; font-weight: 700;">üéâ You saved $' + (state.orderDiscount + 6.99).toFixed(2) + ' on this order!</div>' +
                    '</div>';
            }
            
            // COD warning if applicable
            if (isCash) {
                html += '<div style="background: #3a2a1a; border-radius: 8px; padding: 10px; margin-top: 12px; font-size: 12px; color: #ffaa00;">' +
                    '‚ö†Ô∏è Please have exact change ready. Driver cannot make change for large bills.' +
                    '</div>';
            }
            html += '</div>';
            
            // Customer contact info card
            var confirmedAddress = state.customer && state.customer.address ? state.customer.address : 'Your location';
            var customerPhone = state.customer && state.customer.phone ? formatPhone(state.customer.phone) : '';
            var customerName = state.customer && state.customer.name ? state.customer.name : 'Guest';
            
            html += '<div style="background: #202c33; border-radius: 16px; padding: 20px; margin-bottom: 20px;">' +
                '<div style="font-size: 12px; color: #8696a0; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px;">üìã Order Contact Info</div>' +
                '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid #2a3942;">' +
                '<div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700;">' + 
                customerName.charAt(0).toUpperCase() + '</div>' +
                '<div style="flex: 1;">' +
                '<div style="font-size: 16px; font-weight: 600;">' + customerName + '</div>' +
                '<div style="font-size: 14px; color: #25D366;">' + customerPhone + '</div>' +
                '</div>' +
                '</div>' +
                '<div style="font-size: 14px; color: #8696a0; margin-bottom: 6px;">Delivering to</div>' +
                '<div style="font-size: 16px;">üìç ' + confirmedAddress + '</div>' +
                '</div>';
            
            // Contact driver buttons
            html += '<div style="display: flex; gap: 10px; margin-bottom: 12px;">' +
                '<button class="btn" style="flex: 1; background: #202c33;" data-action="call_driver">üìû Call ' + driver.name.split(' ')[0] + '</button>' +
                '<button class="btn" style="flex: 1; background: #202c33;" data-action="message_driver">üí¨ Message</button>' +
                '</div>';
            
            // Track Order button - prominent green CTA
            html += '<a href="track.html" style="display: block; text-decoration: none; margin-bottom: 20px;">' +
                '<button class="btn" style="width: 100%; background: linear-gradient(135deg, #25D366, #128C7E); font-weight: 700; font-size: 16px;">üìç Track Your Order Live</button>' +
                '</a>';
            
            // Support info
            html += '<div style="text-align: center; margin-bottom: 20px;">' +
                '<div style="font-size: 13px; color: #8696a0;">Need help? Contact LocalFirst YYC</div>' +
                '<div style="font-size: 14px; color: #25D366;">üìû (403) 826-5529</div>' +
                '</div>';
            
            // Community impact message
            var ownerFirst = owner ? owner.name.split(' ')[0] : 'a local family';
            var driverFirst = driver.name.split(' ')[0];
            
            html += '<div style="background: linear-gradient(135deg, #1a3020, #0d2010); border: 1px solid #25D366; border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">' +
                '<div style="font-size: 28px; margin-bottom: 10px;">üíö</div>' +
                '<div style="font-size: 16px; font-weight: 700; color: #25D366; margin-bottom: 10px;">You Just Made a Difference</div>' +
                '<div style="font-size: 13px; color: #e9edef; line-height: 1.7;">' +
                ownerFirst + ' can keep her family\'s dream alive.<br>' +
                driverFirst + ' is one delivery closer to their goals.<br>' +
                '<span style="color: #25D366; font-weight: 600;">Thank you for choosing local. üá®üá¶</span>' +
                '</div>' +
                '</div>';
            
            // New order button
            html += '<div class="buttons">' +
                '<button class="btn" data-action="new_order">üîÑ Start New Order</button>' +
                '</div>';
            
            render(html);
            
            // Hide cart badge
            cartBadge.className = 'cart-badge';
        }
        
        // Start New Order
        function startNewOrder() {
            state.cart = [];
            state.tip = 0;
            state.selectedItem = null;
            state.selectedSize = null;
            state.selectedToppings = [];
            state.selectedSpecial = null;
            state.specials = [];
            state.customPizzaToppings = [];
            state.orderNumber = null;
            state.orderTotal = null;
            state.orderDiscount = 0;
            state.paymentMethod = null;
            state.selectedPaymentMethod = null;
            state.displayPaymentMethod = null;
            state.assignedDriver = null;
            state.history = [];
            updateCart();
            
            if (state.restaurant) {
                renderPage('restaurant_home', false);
            } else {
                renderPage('restaurants', false);
            }
        }
        
        // Cart badge click
        cartBadge.addEventListener('click', function() {
            showCartPage();
        });
        
        // ============================================
        // INIT
        // ============================================
        function init() {
            // Always start at welcome page
            // For returning customers, welcome page shows "Welcome back" with saved address
            // For new customers, welcome page shows discount offer
            if (loadCustomer()) {
                console.log('Welcome back:', state.customer.name);
                console.log('Saved address:', state.customer.address);
                // Load order history for COD checking
                loadCustomerHistory();
            }
            // Always start at welcome - it handles both new and returning customers
            renderPage('welcome', false);
        }
        
        init();
    </script>
</body>
</html>
