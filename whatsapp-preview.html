<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LocalFirst YYC - Order Local</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #0b141a; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: white;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow: hidden;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            height: 100vh;
            height: -webkit-fill-available;
            display: flex; 
            flex-direction: column; 
        }
        
        /* WhatsApp Header */
        .wa-header { 
            background: #075E54; 
            padding: 12px 16px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            flex-shrink: 0;
        }
        .wa-back { color: white; font-size: 20px; cursor: pointer; }
        .wa-avatar { 
            width: 40px; height: 40px; 
            background: linear-gradient(135deg, #25D366, #128C7E); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 18px; font-weight: bold; color: white;
            overflow: hidden;
        }
        .wa-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .wa-info { flex: 1; }
        .wa-name { color: white; font-weight: 600; font-size: 16px; }
        .wa-status { color: #a8d8c8; font-size: 12px; }
        .wa-help { color: white; font-size: 20px; cursor: pointer; padding: 8px; }
        
        /* Chat Area */
        .chat-area { 
            flex: 1; 
            overflow-y: auto;
            padding: 12px;
            background: #0b141a;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h60v60H0z' fill='%230b141a'/%3E%3Cpath d='M30 30m-1 0a1 1 0 1 0 2 0a1 1 0 1 0-2 0' fill='%23ffffff05'/%3E%3C/svg%3E");
        }
        
        /* Messages */
        .message { margin-bottom: 12px; animation: fadeIn 0.3s ease; }
        .message.out { display: flex; justify-content: flex-end; }
        .message.in { display: flex; justify-content: flex-start; }
        .message.center { display: flex; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .bubble { 
            max-width: 85%; 
            padding: 10px 14px; 
            font-size: 15px; 
            line-height: 1.45; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        .bubble.out { background: #005c4b; border-radius: 10px 10px 0 10px; }
        .bubble.in { background: #202c33; border-radius: 10px 10px 10px 0; }
        .bubble.system { 
            background: rgba(255,255,255,0.1); 
            border-radius: 20px; 
            font-size: 12px; 
            color: #8696a0; 
            padding: 6px 14px;
            max-width: 90%;
        }
        
        /* Images in bubbles */
        .bubble img { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            max-height: 200px; 
            object-fit: cover; 
        }
        .bubble.with-image { padding: 6px; padding-bottom: 10px; }
        .bubble.with-image .caption { padding: 6px 8px 0; }
        
        /* Savings Banner */
        .savings-banner {
            background: linear-gradient(135deg, #25D366, #128C7E);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(37, 211, 102, 0.3); }
            to { box-shadow: 0 0 20px rgba(37, 211, 102, 0.6); }
        }
        .savings-banner .big { font-size: 26px; font-weight: 800; }
        .savings-banner .sub { font-size: 13px; opacity: 0.9; margin-top: 4px; }
        
        /* WhatsApp Buttons */
        .wa-buttons { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
        .wa-btn {
            background: transparent;
            border: 1px solid #00a884;
            color: #00a884;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .wa-btn:active { background: #00a88433; transform: scale(0.98); }
        .wa-btn.primary { background: #00a884; color: white; border: none; }
        .wa-btn.primary:active { background: #008f72; }
        
        /* Restaurant Card */
        .restaurant-card {
            background: #202c33;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .restaurant-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .restaurant-card .info {
            padding: 12px;
        }
        .restaurant-card .name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .restaurant-card .meta {
            font-size: 13px;
            color: #8696a0;
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }
        .restaurant-card .meta span { display: flex; align-items: center; gap: 4px; }
        .restaurant-card .order-btn {
            background: #00a884;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .restaurant-card .order-btn:active { background: #008f72; }
        
        /* Menu Item Card */
        .menu-card {
            background: #202c33;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .menu-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        .menu-card .info { padding: 12px; }
        .menu-card .name { font-size: 15px; font-weight: 600; }
        .menu-card .desc { font-size: 13px; color: #8696a0; margin: 4px 0 8px; }
        .menu-card .price { color: #25D366; font-weight: 700; font-size: 16px; }
        .menu-card .add-btn {
            background: #00a884;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .menu-card .add-btn:active { background: #008f72; }
        
        /* Input Bar */
        .input-bar { 
            background: #1a2229; 
            padding: 10px 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            flex-shrink: 0;
        }
        .input-field { 
            flex: 1; 
            background: #2a3942; 
            border: none; 
            border-radius: 24px; 
            padding: 12px 18px; 
            color: white; 
            font-size: 15px; 
            outline: none; 
        }
        .input-field::placeholder { color: #8696a0; }
        .send-btn, .mic-btn { 
            width: 44px; height: 44px; 
            background: #00a884; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 20px; 
            cursor: pointer; 
            border: none;
            flex-shrink: 0;
        }
        .send-btn:active, .mic-btn:active { background: #008f72; }
        
        /* Typing indicator */
        .typing { display: flex; gap: 4px; padding: 12px; }
        .typing span { 
            width: 8px; height: 8px; 
            background: #8696a0; 
            border-radius: 50%; 
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing span:nth-child(1) { animation-delay: 0s; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #8696a0; }
        .spinner { 
            width: 40px; height: 40px; 
            border: 3px solid #2a3942; 
            border-top-color: #25D366; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 12px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="wa-header">
            <div class="wa-back" onclick="goBack()">‚Üê</div>
            <div class="wa-avatar" id="avatar">LF</div>
            <div class="wa-info">
                <div class="wa-name" id="headerName">LocalFirst YYC</div>
                <div class="wa-status" id="headerStatus">online</div>
            </div>
            <div class="wa-help" onclick="showHelp()">‚ùì</div>
        </div>
        
        <div class="chat-area" id="chatArea">
            <div class="loading">
                <div class="spinner"></div>
                Loading...
            </div>
        </div>
        
        <div class="input-bar">
            <input type="text" class="input-field" id="userInput" placeholder="Type a message or search...">
            <button class="mic-btn" id="micBtn">üé§</button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIG
        // ============================================
        const SUPABASE_URL = 'https://htzozoordnftgkjyadsf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0em96b29yZG5mdGdranlhZHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzM3MDUsImV4cCI6MjA4MzQwOTcwNX0.zWDiVBwgeRDlnvb2FQxAnU-VDX6Yee4EiLmyWHRYYjM';
        
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ============================================
        // STATE
        // ============================================
        let state = {
            mode: 'discovery', // 'discovery' or 'restaurant'
            restaurants: [],
            currentRestaurant: null,
            menuItems: [],
            categories: [],
            cart: [],
            address: '',
            tip: 0,
            step: 'init' // init, location, restaurants, menu, category, item, cart, tip, payment, confirmed
        };
        
        // Check URL params
        const params = new URLSearchParams(window.location.search);
        const storeId = params.get('store');
        const hasPromo = params.has('promo');
        
        // ============================================
        // INIT
        // ============================================
        async function init() {
            clearChat();
            
            if (storeId) {
                // Direct to restaurant
                state.mode = 'restaurant';
                await loadRestaurant(storeId);
            } else {
                // Discovery mode
                state.mode = 'discovery';
                await loadAllRestaurants();
                showWelcome();
            }
        }
        
        async function loadAllRestaurants() {
            try {
                const { data } = await db.from('restaurants').select('*');
                state.restaurants = data || [];
            } catch (e) {
                console.error(e);
            }
        }
        
        async function loadRestaurant(id) {
            try {
                const { data: rest } = await db.from('restaurants').select('*').eq('id', id).single();
                if (rest) {
                    state.currentRestaurant = rest;
                    await loadMenu(id);
                    updateHeader(rest);
                    showRestaurantWelcome();
                }
            } catch (e) {
                // Try by name/slug
                const { data: rest } = await db.from('restaurants').select('*').limit(1);
                if (rest && rest[0]) {
                    state.currentRestaurant = rest[0];
                    await loadMenu(rest[0].id);
                    updateHeader(rest[0]);
                    showRestaurantWelcome();
                }
            }
        }
        
        async function loadMenu(restaurantId) {
            const { data } = await db.from('menu_items').select('*').eq('is_available', true);
            state.menuItems = data || [];
            state.categories = [...new Set(state.menuItems.map(i => i.category).filter(Boolean))];
        }
        
        function updateHeader(restaurant) {
            document.getElementById('headerName').textContent = restaurant.name || 'LocalFirst YYC';
            if (restaurant.logo_url) {
                document.getElementById('avatar').innerHTML = '<img src="' + restaurant.logo_url + '">';
            } else {
                document.getElementById('avatar').textContent = (restaurant.name || 'LF').substring(0,2).toUpperCase();
            }
        }
        
        // ============================================
        // CHAT HELPERS
        // ============================================
        function clearChat() {
            document.getElementById('chatArea').innerHTML = '';
        }
        
        function scrollToBottom() {
            const chat = document.getElementById('chatArea');
            chat.scrollTop = chat.scrollHeight;
        }
        
        function addMessage(type, content) {
            const chat = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.innerHTML = content;
            chat.appendChild(div);
            scrollToBottom();
        }
        
        function addBubble(type, text, buttons = []) {
            let html = '<div class="bubble ' + type + '">' + text;
            if (buttons.length > 0) {
                html += '<div class="wa-buttons">';
                buttons.forEach((btn, i) => {
                    const cls = i === 0 ? 'wa-btn primary' : 'wa-btn';
                    html += '<button class="' + cls + '" onclick="' + btn.action + '">' + btn.label + '</button>';
                });
                html += '</div>';
            }
            html += '</div>';
            addMessage(type, html);
        }
        
        function addTyping() {
            addMessage('in', '<div class="bubble in"><div class="typing"><span></span><span></span><span></span></div></div>');
        }
        
        function removeTyping() {
            const typing = document.querySelector('.typing');
            if (typing) typing.closest('.message').remove();
        }
        
        function showSavingsBanner() {
            addMessage('center', '<div class="savings-banner"><div class="big">üéâ YOU SAVE $6.99!</div><div class="sub">FREE delivery ‚Ä¢ Skip charges $6.99</div></div>');
        }
        
        // ============================================
        // DISCOVERY MODE
        // ============================================
        function showWelcome() {
            state.step = 'init';
            
            if (hasPromo) {
                showSavingsBanner();
            }
            
            setTimeout(() => {
                addBubble('in', 
                    'üëã Welcome to <b>LocalFirst YYC</b>!\n\n' +
                    'Order from Calgary\'s best local restaurants.\n' +
                    'üöó FREE delivery ‚Ä¢ No app fees\n\n' +
                    'What\'s your delivery address?',
                    [
                        { label: 'üìç Share My Location', action: 'useLocation()' },
                        { label: '‚úèÔ∏è Type Address', action: 'promptAddress()' }
                    ]
                );
                state.step = 'location';
            }, 500);
        }
        
        window.useLocation = function() {
            addBubble('out', 'üìç Share My Location');
            
            if (navigator.geolocation) {
                addTyping();
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        removeTyping();
                        state.address = 'Near ' + pos.coords.latitude.toFixed(2) + ', ' + pos.coords.longitude.toFixed(2);
                        showNearbyRestaurants();
                    },
                    () => {
                        removeTyping();
                        state.address = 'Calgary, AB';
                        showNearbyRestaurants();
                    }
                );
            } else {
                state.address = 'Calgary, AB';
                showNearbyRestaurants();
            }
        };
        
        window.promptAddress = function() {
            addBubble('out', '‚úèÔ∏è Type Address');
            addBubble('in', 'üìç Please type your delivery address:');
            state.step = 'typing_address';
        };
        
        function showNearbyRestaurants() {
            state.step = 'restaurants';
            
            addBubble('in', 'üìç Delivering to: <b>' + state.address + '</b>\n\nüçΩÔ∏è Restaurants near you:');
            
            // Show restaurant cards
            setTimeout(() => {
                if (state.restaurants.length === 0) {
                    // Demo data if no restaurants in DB
                    const demoRestaurants = [
                        { id: '1', name: 'AB King Pizza', cuisine: 'Pizza', rating: 4.8, distance: '0.8 km', time: '25-35 min', image: 'https://images.unsplash.com/photo-1513104890138-7c749659a591?w=400' },
                        { id: '2', name: 'Joe\'s Wings', cuisine: 'Wings', rating: 4.6, distance: '1.2 km', time: '30-40 min', image: 'https://images.unsplash.com/photo-1608039755401-742074f0548d?w=400' }
                    ];
                    demoRestaurants.forEach(r => addRestaurantCard(r));
                } else {
                    state.restaurants.forEach(r => addRestaurantCard(r));
                }
            }, 300);
        }
        
        function addRestaurantCard(r) {
            const html = `
                <div class="restaurant-card">
                    <img src="${r.image || r.logo_url || 'https://via.placeholder.com/400x120/333/888?text=' + encodeURIComponent(r.name)}" onerror="this.src='https://via.placeholder.com/400x120/333/888?text=${encodeURIComponent(r.name)}'">
                    <div class="info">
                        <div class="name">${r.name}</div>
                        <div class="meta">
                            <span>‚≠ê ${r.rating || '4.7'}</span>
                            <span>üìç ${r.distance || '1 km'}</span>
                            <span>üöó ${r.time || '30 min'}</span>
                        </div>
                        <button class="order-btn" onclick="selectRestaurant('${r.id}')">Order Now - FREE Delivery</button>
                    </div>
                </div>
            `;
            addMessage('in', html);
        }
        
        window.selectRestaurant = async function(id) {
            const r = state.restaurants.find(x => x.id === id) || { id, name: 'Restaurant' };
            addBubble('out', 'üçΩÔ∏è ' + r.name);
            
            state.currentRestaurant = r;
            await loadMenu(id);
            updateHeader(r);
            
            showRestaurantWelcome();
        };
        
        // ============================================
        // RESTAURANT MODE
        // ============================================
        function showRestaurantWelcome() {
            state.step = 'order_type';
            
            const name = state.currentRestaurant?.name || 'this restaurant';
            
            if (hasPromo && state.mode === 'restaurant') {
                showSavingsBanner();
            }
            
            setTimeout(() => {
                addBubble('in',
                    'üëã Welcome to <b>' + name + '</b>!\n\n' +
                    'How would you like to order?',
                    [
                        { label: 'üöó Delivery (FREE!)', action: 'selectDelivery()' },
                        { label: 'üèÉ Pickup (15 min)', action: 'selectPickup()' }
                    ]
                );
            }, 300);
        }
        
        window.selectDelivery = function() {
            addBubble('out', 'üöó Delivery');
            state.step = 'address';
            
            if (state.address) {
                confirmAddress();
            } else {
                setTimeout(() => {
                    addBubble('in', 
                        'üöó FREE delivery!\n\nüìç What\'s your address?',
                        [
                            { label: 'üìç Share Location', action: 'useLocationForDelivery()' }
                        ]
                    );
                }, 300);
            }
        };
        
        window.useLocationForDelivery = function() {
            state.address = 'Calgary, AB';
            confirmAddress();
        };
        
        function confirmAddress() {
            addBubble('in', '‚úÖ Delivering to: <b>' + state.address + '</b>\n‚è±Ô∏è ~30-40 min ‚Ä¢ üöó FREE');
            showMenu();
        }
        
        window.selectPickup = function() {
            addBubble('out', 'üèÉ Pickup');
            state.address = 'PICKUP';
            addBubble('in', '‚úÖ Pickup order\n‚è±Ô∏è Ready in ~15 min');
            showMenu();
        };
        
        // ============================================
        // MENU
        // ============================================
        function showMenu() {
            state.step = 'menu';
            
            let btns = state.categories.map(cat => ({
                label: getCategoryEmoji(cat) + ' ' + cat,
                action: 'showCategory("' + cat + '")'
            }));
            
            if (state.cart.length > 0) {
                btns.push({ label: 'üõí Cart (' + state.cart.length + ')', action: 'showCart()' });
            }
            
            setTimeout(() => {
                addBubble('in',
                    'üîç <b>Search:</b> Type what you want\n\nüìã Or browse:',
                    btns.length > 0 ? btns : [{ label: 'üìã View All Items', action: 'showAllItems()' }]
                );
            }, 300);
        }
        
        function getCategoryEmoji(cat) {
            const c = cat.toLowerCase();
            if (c.includes('pizza')) return 'üçï';
            if (c.includes('wing')) return 'üçó';
            if (c.includes('side')) return 'ü•ó';
            if (c.includes('drink')) return 'ü•§';
            if (c.includes('dessert')) return 'üç∞';
            if (c.includes('special')) return 'üî•';
            return 'üçΩÔ∏è';
        }
        
        window.showCategory = function(cat) {
            state.step = 'category';
            addBubble('out', getCategoryEmoji(cat) + ' ' + cat);
            
            const items = state.menuItems.filter(i => i.category === cat);
            
            setTimeout(() => {
                addBubble('in', getCategoryEmoji(cat) + ' <b>' + cat.toUpperCase() + '</b>');
                
                items.forEach((item, i) => {
                    setTimeout(() => addMenuCard(item), i * 150);
                });
                
                setTimeout(() => {
                    addBubble('in', '', [
                        { label: '‚¨ÖÔ∏è Back to Menu', action: 'showMenu()' },
                        state.cart.length > 0 ? { label: 'üõí Cart (' + state.cart.length + ')', action: 'showCart()' } : null
                    ].filter(Boolean));
                }, items.length * 150 + 200);
            }, 300);
        };
        
        window.showAllItems = function() {
            state.step = 'category';
            
            state.menuItems.slice(0, 6).forEach((item, i) => {
                setTimeout(() => addMenuCard(item), i * 150);
            });
            
            setTimeout(() => {
                addBubble('in', '', [
                    { label: '‚¨ÖÔ∏è Back', action: 'showMenu()' }
                ]);
            }, 1000);
        };
        
        function addMenuCard(item) {
            const html = `
                <div class="menu-card">
                    <img src="${item.image_url || 'https://via.placeholder.com/400x140/333/888?text=' + encodeURIComponent(item.name)}" onerror="this.src='https://via.placeholder.com/400x140/333/888?text=${encodeURIComponent(item.name)}'">
                    <div class="info">
                        <div class="name">${item.name}</div>
                        <div class="desc">${item.description || ''}</div>
                        <div class="price">$${(item.base_price || 0).toFixed(2)}</div>
                        <button class="add-btn" onclick="addToCart('${item.id}')">Add to Order</button>
                    </div>
                </div>
            `;
            addMessage('in', html);
        }
        
        window.addToCart = function(itemId) {
            const item = state.menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            state.cart.push({
                id: item.id,
                name: item.name,
                price: item.base_price || 0
            });
            
            addBubble('out', '‚ûï ' + item.name);
            
            setTimeout(() => {
                addBubble('in', 
                    '‚úÖ Added <b>' + item.name + '</b>\n\n' +
                    'üõí Cart: ' + state.cart.length + ' item(s) ‚Ä¢ $' + getCartTotal().toFixed(2),
                    [
                        { label: '‚ûï Add More', action: 'showMenu()' },
                        { label: '‚úÖ Checkout', action: 'showTip()' }
                    ]
                );
            }, 200);
        };
        
        function getCartTotal() {
            return state.cart.reduce((sum, i) => sum + i.price, 0);
        }
        
        // ============================================
        // CART
        // ============================================
        window.showCart = function() {
            state.step = 'cart';
            
            if (state.cart.length === 0) {
                addBubble('in', 'üõí Your cart is empty!', [
                    { label: 'üìã Browse Menu', action: 'showMenu()' }
                ]);
                return;
            }
            
            let text = 'üõí <b>YOUR CART</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            state.cart.forEach(item => {
                text += item.name + ' - $' + item.price.toFixed(2) + '\n';
            });
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'Subtotal: $' + getCartTotal().toFixed(2) + '\n';
            text += 'Delivery: FREE üéâ';
            
            addBubble('in', text, [
                { label: '‚úÖ Checkout', action: 'showTip()' },
                { label: '‚ûï Add More', action: 'showMenu()' },
                { label: 'üóëÔ∏è Clear Cart', action: 'clearCart()' }
            ]);
        };
        
        window.clearCart = function() {
            state.cart = [];
            addBubble('out', 'üóëÔ∏è Clear Cart');
            addBubble('in', 'üóëÔ∏è Cart cleared!', [
                { label: 'üìã Browse Menu', action: 'showMenu()' }
            ]);
        };
        
        // ============================================
        // TIP & PAYMENT
        // ============================================
        window.showTip = function() {
            state.step = 'tip';
            addBubble('out', '‚úÖ Checkout');
            
            setTimeout(() => {
                addBubble('in',
                    'üöó <b>Add a tip for your driver?</b>\n\n' +
                    'Your driver earns 100% of tips.\n' +
                    'Every dollar supports local families.',
                    [
                        { label: 'üíµ $3', action: 'setTip(3)' },
                        { label: 'üíµ $5', action: 'setTip(5)' },
                        { label: 'üíµ $7', action: 'setTip(7)' },
                        { label: 'No tip', action: 'setTip(0)' }
                    ]
                );
            }, 300);
        };
        
        window.setTip = function(amount) {
            state.tip = amount;
            addBubble('out', amount > 0 ? 'üíµ $' + amount + ' tip' : 'No tip');
            
            if (amount > 0) {
                addBubble('in', 'üôè Thank you! Your driver will appreciate it.');
            }
            
            setTimeout(showPayment, 300);
        };
        
        function showPayment() {
            state.step = 'payment';
            
            const subtotal = getCartTotal();
            const total = subtotal + state.tip;
            
            let text = 'üìã <b>ORDER SUMMARY</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            state.cart.forEach(i => {
                text += i.name + ' $' + i.price.toFixed(2) + '\n';
            });
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'Subtotal: $' + subtotal.toFixed(2) + '\n';
            text += 'Delivery: FREE\n';
            if (state.tip > 0) text += 'Driver Tip: $' + state.tip.toFixed(2) + '\n';
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += '<b>TOTAL: $' + total.toFixed(2) + '</b>\n\n';
            text += 'üìç ' + (state.address === 'PICKUP' ? 'Pickup' : state.address);
            
            addBubble('in', text, [
                { label: 'üí≥ Pay Now', action: 'payCard()' },
                { label: 'üíµ Cash at Door', action: 'payCash()' }
            ]);
        }
        
        window.payCard = function() {
            addBubble('out', 'üí≥ Pay Now');
            
            const total = getCartTotal() + state.tip;
            const orderNum = 'LF-' + Math.floor(Math.random() * 9000 + 1000);
            
            addBubble('in', 
                'üí≥ <b>SECURE CHECKOUT</b>\n\n' +
                'Tap to pay:\n' +
                'üîó pay.localfirst.ca/ord/' + orderNum + '\n\n' +
                '‚úÖ 256-bit encryption\n' +
                'üí∞ Total: $' + total.toFixed(2)
            );
            
            setTimeout(() => {
                addMessage('center', '<div class="bubble system">Payment completed ‚úì</div>');
                confirmOrder(total, orderNum, false);
            }, 1500);
        };
        
        window.payCash = function() {
            addBubble('out', 'üíµ Cash at Door');
            const total = getCartTotal() + state.tip;
            const orderNum = 'LF-' + Math.floor(Math.random() * 9000 + 1000);
            confirmOrder(total, orderNum, true);
        };
        
        function confirmOrder(total, orderNum, isCash) {
            state.step = 'confirmed';
            
            const eta = new Date(Date.now() + 40 * 60000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            setTimeout(() => {
                addBubble('in',
                    'üéâ <b>ORDER CONFIRMED!</b>\n\n' +
                    'Order #' + orderNum + '\n\n' +
                    (isCash ? 'üíµ Pay $' + total.toFixed(2) + ' at door' : '‚úÖ Paid: $' + total.toFixed(2)) + '\n' +
                    'üìç ' + (state.address === 'PICKUP' ? 'Pickup' : state.address) + '\n' +
                    '‚è±Ô∏è ETA: ' + eta + '\n\n' +
                    'Your order is being prepared! üçï'
                );
            }, 300);
            
            setTimeout(() => {
                addBubble('in',
                    'üöó <b>DRIVER ASSIGNED</b>\n\n' +
                    'üëã Mike is on his way!\n' +
                    '‚≠ê 4.9 rating ‚Ä¢ 1,247 deliveries\n\n' +
                    'Any issues? Tap ‚ùì above for help.\n\n' +
                    'Thanks for supporting local! ‚ù§Ô∏è',
                    [
                        { label: 'üîÑ New Order', action: 'startOver()' }
                    ]
                );
            }, 3500);
        }
        
        window.startOver = function() {
            state.cart = [];
            state.tip = 0;
            clearChat();
            
            if (state.mode === 'restaurant') {
                showRestaurantWelcome();
            } else {
                showWelcome();
            }
        };
        
        // ============================================
        // HELP & BACK
        // ============================================
        window.showHelp = function() {
            addBubble('in',
                '‚ùì <b>NEED HELP?</b>\n\n' +
                'LocalFirst YYC Support:\n\n' +
                'üì± Chat here anytime\n' +
                'üìû +1 (403) 826-5529\n' +
                'üìß support@localfirst.ca\n\n' +
                'We handle:\n' +
                '‚Ä¢ Order issues\n' +
                '‚Ä¢ Refunds\n' +
                '‚Ä¢ Delivery problems\n\n' +
                'Available 7 days, 10am-10pm',
                [
                    { label: '‚¨ÖÔ∏è Back', action: 'continueOrder()' }
                ]
            );
        };
        
        window.continueOrder = function() {
            if (state.step === 'menu' || state.step === 'category') {
                showMenu();
            } else if (state.step === 'cart') {
                showCart();
            }
        };
        
        window.goBack = function() {
            if (state.step === 'category') {
                showMenu();
            } else if (state.step === 'restaurants') {
                clearChat();
                showWelcome();
            } else if (state.mode === 'discovery' && state.currentRestaurant) {
                state.currentRestaurant = null;
                document.getElementById('headerName').textContent = 'LocalFirst YYC';
                document.getElementById('avatar').textContent = 'LF';
                showNearbyRestaurants();
            }
        };
        
        // ============================================
        // TEXT INPUT
        // ============================================
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim();
                if (val) {
                    handleTextInput(val);
                    this.value = '';
                }
            }
        });
        
        function handleTextInput(text) {
            addBubble('out', text);
            
            // Address input
            if (state.step === 'typing_address' || state.step === 'address') {
                state.address = text;
                if (state.mode === 'discovery') {
                    showNearbyRestaurants();
                } else {
                    confirmAddress();
                }
                return;
            }
            
            // Search menu
            if (state.step === 'menu' || state.step === 'category') {
                const results = state.menuItems.filter(i => 
                    i.name.toLowerCase().includes(text.toLowerCase()) ||
                    (i.description && i.description.toLowerCase().includes(text.toLowerCase()))
                );
                
                if (results.length > 0) {
                    addBubble('in', 'üîç Found ' + results.length + ' item(s):');
                    results.slice(0, 4).forEach((item, i) => {
                        setTimeout(() => addMenuCard(item), i * 150);
                    });
                } else {
                    addBubble('in', 'üîç No items found for "' + text + '"', [
                        { label: 'üìã Show Menu', action: 'showMenu()' }
                    ]);
                }
            }
        }
        
        // Mic button
        document.getElementById('micBtn').addEventListener('click', function() {
            alert('üé§ Voice Ordering\n\nComing soon!\n\nYou\'ll be able to say:\n‚Ä¢ "Large pepperoni pizza"\n‚Ä¢ "Add wings"\n‚Ä¢ "Checkout"');
        });
        
        // ============================================
        // START
        // ============================================
        init();
    </script>
</body>
</html>
